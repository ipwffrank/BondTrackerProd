rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ORGANIZATIONS COLLECTION
    // ============================================
    match /organizations/{orgId} {
      // Anyone authenticated can read organization info
      allow read: if request.auth != null;
      
      // Anyone can create organization (for first-time signup)
      allow create: if request.auth != null;
      
      // Only admin can update organization
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.isAdmin == true;
      
      // ============================================
      // USERS SUBCOLLECTION
      // ============================================
      match /users/{userId} {
        // ✅ Anyone authenticated can read (needed for login)
        allow read: if request.auth != null;
        
        // ✅ Anyone can create (needed for signup)
        allow create: if request.auth != null;
        
        // ✅ User can update their own document
        allow update: if request.auth != null && 
          (request.auth.uid == userId || 
           get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.isAdmin == true);
        
        // Only admins can delete users
        allow delete: if request.auth != null && 
          get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.isAdmin == true;
      }
      
      // ============================================
      // INVITATIONS SUBCOLLECTION
      // ============================================
      match /invitations/{invitationId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && 
          get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.isAdmin == true;
        allow update: if request.auth != null;
        allow delete: if request.auth != null;
      }
      
      // ============================================
      // ACTIVITIES SUBCOLLECTION
      // ============================================
      match /activities/{activityId} {
        allow read, write: if request.auth != null && 
          exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
      }
      
      // ============================================
      // NEW ISSUES SUBCOLLECTION
      // ============================================
      match /newIssues/{issueId} {
        allow read, write: if request.auth != null && 
          exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
      }
      
      // ============================================
      // ORDER BOOKS SUBCOLLECTION
      // ============================================
      match /orderBooks/{orderId} {
        allow read, write: if request.auth != null && 
          exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
      }
      
      // ============================================
      // CLIENTS SUBCOLLECTION
      // ============================================
      match /clients/{clientId} {
        allow read, create, update: if request.auth != null && 
          exists(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid));
        
        // Only admins can delete clients
        allow delete: if request.auth != null && 
          get(/databases/$(database)/documents/organizations/$(orgId)/users/$(request.auth.uid)).data.isAdmin == true;
      }
    }
  }
}
