<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Sales Activity Tracker (Updated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .container { max-width: 1200px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; color: #e2e8f0; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #63b3ed; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled { background-color: #4a5568; cursor: not-allowed; }
        .btn-primary { background-color: #4c51bf; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #667eea; }
        .btn-primary:disabled { background-color: #3b4252; cursor: not-allowed; color: #a0aec0; }
        .btn-danger { background-color: #e53e3e; color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #fc8181; }
        .tab-btn.active { background-color: #4c51bf; color: white; font-weight: 600; }
        .tab-btn:hover { background-color: #4a5568; }
        .tab-btn { transition: background-color 0.2s; }
        .table-header { background-color: #2d3748; color: #a0aec0; }
        .table-row:nth-child(odd) { background-color: #2d3748; }
        .table-row:nth-child(even) { background-color: #1a202c; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: #2d3748; margin: auto; padding: 24px; border: 1px solid #4a5568; width: 90%; max-width: 400px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
        <div class="ml-4 text-white">Fetching rates...</div>
    </div>

    <div id="successMessage" class="fixed top-4 right-4 bg-green-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform translate-x-full hidden">Activity Logged!</div>
    <div id="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform hidden">Failed to log activity. Please try again.</div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="mb-6">Are you sure you want to delete this entry?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Delete</button>
                <button id="cancelDeleteBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-8 lg:p-12">
        <h1 class="text-4xl lg:text-5xl font-extrabold text-center mb-6 text-indigo-400">Bond Sales Activity Tracker</h1>
        <div id="userIdDisplay" class="text-sm text-center mb-6 text-gray-500">User ID: <span id="userIdSpan" class="text-gray-200 font-mono text-xs md:text-sm">Loading...</span></div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Client Database</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input id="newClientName" class="form-input" placeholder="Client Name (uppercased will be stored)" />
                <select id="newClientType" class="form-select">
                    <option value="Treasury">Treasury</option>
                    <option value="Asset Manager">Asset Manager</option>
                    <option value="Hedge Fund">Hedge Fund</option>
                    <option value="SWF">SWF</option>
                    <option value="Central Bank">Central Bank</option>
                    <option value="Prop">Prop</option>
                    <option value="WM">WM</option>
                </select>
                <div class="flex items-center">
                    <button id="addClientBtn" class="btn-primary px-4 py-2">Add Client</button>
                </div>
            </div>
            <div id="clientsList" class="text-sm text-gray-300">Clients will appear in the dropdown when added.</div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Log New Activity</h2>
            <div id="activity-hint" class="text-sm text-center mb-4 text-gray-400">Please select an activity type below to enable the form.</div>

            <div class="flex flex-wrap gap-2 mb-6 justify-center lg:justify-start">
                <button id="tab-enquiry" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Enquiry</button>
                <button id="tab-trade" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Trade</button>
                <button id="tab-missed-trades" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Missed Trades</button>
                <button id="tab-new-issues" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <form id="activityForm">
                <input type="hidden" id="activityType" value="" required>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="form-group">
                        <label for="clientName" class="block mb-2 text-sm font-medium">Client Name</label>
                        <select id="clientName" class="form-select" disabled required>
                            <option value="">(Select client from Client Database)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientType" class="block mb-2 text-sm font-medium">Client Type</label>
                        <input type="text" id="clientType" class="form-input" disabled placeholder="Auto-filled from client database" />
                    </div>
                    <div class="form-group">
                        <label for="securities" class="block mb-2 text-sm font-medium">Securities</label>
                        <input type="text" id="securities" class="form-input" disabled required>
                    </div>

                    <!-- General fields for all activity types -->
                    <div id="commonFields" class="contents">
                        <div class="form-group">
                            <label for="buySell" class="block mb-2 text-sm font-medium">Buy/Sell</label>
                            <select id="buySell" class="form-select" disabled>
                                <option value="Buy">Buy</option>
                                <option value="Sell">Sell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="size" class="block mb-2 text-sm font-medium">Size (MM)</label>
                            <input type="number" id="size" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="priceTarget" class="block mb-2 text-sm font-medium" id="priceLabel">Price Target</label>
                            <input type="text" id="priceTarget" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="currency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="currency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="usdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="usdEquivalent" class="form-input" disabled readonly>
                        </div>
                    </div>

                    <!-- Specific field for Missed Trades -->
                    <div id="missedTradeFields" class="form-group hidden">
                        <label for="cptyTradedAway" class="block mb-2 text-sm font-medium">CPTY Traded Away</label>
                        <input type="text" id="cptyTradedAway" class="form-input" disabled required>
                    </div>

                    <!-- Specific fields for New Issues -->
                    <div id="newIssueFields" class="contents hidden">
                        <div class="form-group">
                            <label for="ioi" class="block mb-2 text-sm font-medium">IOI</label>
                            <input type="text" id="ioi" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="orderSize" class="block mb-2 text-sm font-medium">Order Size (MM)</label>
                            <input type="number" id="orderSize" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="realInterest" class="block mb-2 text-sm font-medium">Real Interest (MM)</label>
                            <input type="number" id="realInterest" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="niCurrency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="niCurrency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="niUsdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="niUsdEquivalent" class="form-input" disabled readonly>
                        </div>
                        <div class="form-group lg:col-span-3">
                            <label for="remarks" class="block mb-2 text-sm font-medium">Remarks</label>
                            <textarea id="remarks" class="form-textarea" disabled rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center md:text-right">
                    <button type="submit" id="submitBtn" class="btn-primary mt-4" disabled>Log Activity</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Activity Log</h2>

            <div class="flex flex-wrap gap-2 mb-6">
                <button id="log-general-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600 active">General Activities</button>
                <button id="log-new-issues-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <div id="generalLog" class="overflow-x-auto">
                <table class="min-w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header text-xs uppercase tracking-wider">
                            <th class="p-3 text-left">Timestamp</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Client</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">Buy/Sell</th>
                            <th class="p-3 text-left">Size (MM)</th>
                            <th class="p-3 text-left">Price/Level</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">CPTY</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="generalLogTable"></tbody>
                </table>
            </div>

            <div id="newIssuesLog" class="overflow-x-auto hidden">
                <table class="min-w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header text-xs uppercase tracking-wider">
                            <th class="p-3 text-left">Timestamp</th>
                            <th class="p-3 text-left">Client</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">IOI</th>
                            <th class="p-3 text-left">Order Size</th>
                            <th class="p-3 text-left">Real Interest</th>
                            <th class="p-3 text-left">Price Target</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">Remarks</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="newIssuesLogTable"></tbody>
                </table>
            </div>

        </div>
    </div>

    <script type="module">
        // Global appId correctly scoped
        let appId = "default-app-id";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        const allFormFields = document.querySelectorAll('#activityForm input, #activityForm select, #activityForm textarea');
        const clientNameSelect = document.getElementById('clientName');
        const clientNameInputForDb = document.getElementById('newClientName');
        const newClientTypeSelect = document.getElementById('newClientType');
        const addClientBtn = document.getElementById('addClientBtn');
        const clientsListDiv = document.getElementById('clientsList');
        const clientTypeInput = document.getElementById('clientType');
        const securitiesInput = document.getElementById('securities');
        const cptyTradedAwayInput = document.getElementById('cptyTradedAway');
        const activityTypeInput = document.getElementById('activityType');
        const usdEquivalentInput = document.getElementById('usdEquivalent');
        const sizeInput = document.getElementById('size');
        const currencySelect = document.getElementById('currency');
        const priceLabel = document.getElementById('priceLabel');
        const activityForm = document.getElementById('activityForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generalLogTable = document.getElementById('generalLogTable');
        const newIssuesLogTable = document.getElementById('newIssuesLogTable');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const activityHint = document.getElementById('activity-hint');

        // New Issues specific
        const ioiInput = document.getElementById('ioi');
        const orderSizeInput = document.getElementById('orderSize');
        const realInterestInput = document.getElementById('realInterest');
        const niCurrencySelect = document.getElementById('niCurrency');
        const niUsdEquivalentInput = document.getElementById('niUsdEquivalent');

        let db; let auth; let userId = null; let isAuthReady = false;

        const showMessage = (element, message, duration = 2500) => {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('translate-y-0');
            setTimeout(() => { element.classList.remove('translate-y-0'); element.classList.add('-translate-y-full'); }, duration);
            setTimeout(() => { element.classList.add('hidden'); element.classList.remove('-translate-y-full'); }, duration + 500);
        };

        const updateSubmitButtonState = () => {
            const isActivitySelected = activityTypeInput.value.trim() !== '';
            submitBtn.disabled = !(isAuthReady && isActivitySelected);
            if (isActivitySelected) activityHint.classList.add('hidden'); else activityHint.classList.remove('hidden');
        };

        // Realtime listeners for activities and clients
        const setupRealtimeListeners = () => {
            if (!isAuthReady || !userId) return;
            const generalActivitiesPath = `artifacts/${appId}/users/${userId}/general_activities`;
            const newIssuesPath = `artifacts/${appId}/users/${userId}/new_issues`;
            const clientsPath = `artifacts/${appId}/clients`;

            onSnapshot(collection(db, generalActivitiesPath), (snapshot) => {
                const activities = [];
                snapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));
                renderGeneralActivities(activities);
            }, (error) => { console.error('Error fetching general activities:', error); showMessage(errorMessage, `Failed to load activities: ${error.message}`); });

            onSnapshot(collection(db, newIssuesPath), (snapshot) => {
                const newIssues = [];
                snapshot.forEach(doc => newIssues.push({ id: doc.id, ...doc.data() }));
                renderNewIssues(newIssues);
            }, (error) => { console.error('Error fetching new issues:', error); showMessage(errorMessage, `Failed to load new issues: ${error.message}`); });

            // Clients listener
            onSnapshot(collection(db, clientsPath), (snapshot) => {
                const clients = [];
                snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                populateClientDropdown(clients);
            }, (error) => { console.error('Error fetching clients:', error); showMessage(errorMessage, `Failed to load clients: ${error.message}`); });
        };

        // UI Logic
        const tabButtons = document.querySelectorAll('#tab-enquiry, #tab-trade, #tab-missed-trades, #tab-new-issues');
        const generalTabs = document.querySelectorAll('#log-general-tab, #log-new-issues-tab');

        const showFormFields = (type) => {
            const commonFields = document.getElementById('commonFields');
            const missedTradeFields = document.getElementById('missedTradeFields');
            const newIssueFields = document.getElementById('newIssueFields');

            // Enable all common fields first
            allFormFields.forEach(field => field.disabled = false);

            // Reset visibilities
            commonFields.classList.remove('hidden');
            missedTradeFields.classList.add('hidden');
            newIssueFields.classList.add('hidden');
            cptyTradedAwayInput.disabled = true;
            ioiInput.disabled = true;
            orderSizeInput.disabled = true;
            realInterestInput.disabled = true;
            niCurrencySelect.disabled = true;
            niUsdEquivalentInput.disabled = true;
            document.getElementById('remarks').disabled = true;

            priceLabel.textContent = 'Price Target';

            switch(type.trim()) {
                case 'Enquiry':
                case 'Trade':
                    break;
                case 'Missed Trades':
                    priceLabel.textContent = 'Traded away level';
                    missedTradeFields.classList.remove('hidden');
                    cptyTradedAwayInput.disabled = false;
                    break;
                case 'New Issues':
                    commonFields.classList.add('hidden');
                    newIssueFields.classList.remove('hidden');
                    // Enable new issue inputs
                    ioiInput.disabled = false;
                    orderSizeInput.disabled = false;
                    realInterestInput.disabled = false;
                    niCurrencySelect.disabled = false;
                    niUsdEquivalentInput.disabled = false;
                    document.getElementById('remarks').disabled = false;
                    break;
                default:
                    allFormFields.forEach(field => field.disabled = true);
                    break;
            }
        };

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activityTypeInput.value = btn.textContent.trim();
                showFormFields(btn.textContent);
                updateSubmitButtonState();
            });
        });

        generalTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                generalTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('generalLog').classList.add('hidden');
                document.getElementById('newIssuesLog').classList.add('hidden');
                if (btn.id === 'log-general-tab') document.getElementById('generalLog').classList.remove('hidden'); else document.getElementById('newIssuesLog').classList.remove('hidden');
            });
        });

        // Convert inputs to uppercase where applicable
        clientNameSelect.addEventListener('input', (e) => {}); // select
        securitiesInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        cptyTradedAwayInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());

        // Currency conversion: using exchangerate.host as a reliable free endpoint.
        // NOTE: Google does not provide a free public currency conversion REST endpoint. If you specifically want a Google product, you would need to use a paid Google Cloud service or a Google Sheet with the GOOGLEFINANCE formula.
        const getUSDConversionRate = async (fromCurrency) => {
            // Returns: how many <fromCurrency> = 1 USD (i.e., units per USD). If fromCurrency is USD returns 1.
            const c = (fromCurrency || '').toUpperCase();
            if (c === 'USD' || c === '') return 1;
            try {
                // Using exchangerate.host (free, no-key) - base USD
                const res = await fetch(`https://api.exchangerate.host/latest?base=USD&symbols=${encodeURIComponent(c)}`);
                if (!res.ok) return null;
                const data = await res.json();
                const rate = data?.rates?.[c];
                if (!rate) return null;
                // rate is units of c per 1 USD => that's exactly what we asked for
                return rate;
            } catch (err) {
                console.error('Rate fetch error', err);
                return null;
            }
        };

        const updateUSDEquivalent = async () => {
            const activeTab = activityTypeInput.value.trim();
            let effectiveSize, effectiveCurrencySelect, effectiveUsdEquivalentInput;

            if (activeTab === 'New Issues') {
                effectiveSize = parseFloat(orderSizeInput.value);
                effectiveCurrencySelect = niCurrencySelect;
                effectiveUsdEquivalentInput = niUsdEquivalentInput;
            } else {
                effectiveSize = parseFloat(sizeInput.value);
                effectiveCurrencySelect = currencySelect;
                effectiveUsdEquivalentInput = usdEquivalentInput;
            }

            const currency = (effectiveCurrencySelect?.value || '').trim().toUpperCase();
            if (isNaN(effectiveSize) || !currency) { if (effectiveUsdEquivalentInput) effectiveUsdEquivalentInput.value = ''; return; }

            loadingIndicator.classList.remove('hidden');
            const rate = await getUSDConversionRate(currency);
            loadingIndicator.classList.add('hidden');
            if (rate !== null) {
                // rate = units of currency per 1 USD. USD equivalent = size / rate
                effectiveUsdEquivalentInput.value = (effectiveSize / rate).toFixed(2);
            } else {
                effectiveUsdEquivalentInput.value = 'N/A';
            }
        };

        sizeInput.addEventListener('input', updateUSDEquivalent);
        currencySelect.addEventListener('change', updateUSDEquivalent);
        orderSizeInput.addEventListener('input', updateUSDEquivalent);
        niCurrencySelect.addEventListener('change', updateUSDEquivalent);

        const resetFormState = () => {
            activityForm.reset();
            usdEquivalentInput.value = '';
            niUsdEquivalentInput.value = '';
            tabButtons.forEach(b => b.classList.remove('active'));
            activityTypeInput.value = '';
            showFormFields('');
            updateSubmitButtonState();
            clientTypeInput.value = '';
        };

        activityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const activityType = activityTypeInput.value.trim();
            if (!activityType) { showMessage(errorMessage, 'Please choose an activity type.'); return; }
            if (!isAuthReady || !userId) { showMessage(errorMessage, 'App not ready. Please wait a moment.'); return; }

            const clientName = (clientNameSelect.value || '').trim();
            const securities = securitiesInput.value.trim();
            if (!clientName || !securities) { showMessage(errorMessage, 'Client Name and Securities are required.'); return; }

            let docData = { clientName: clientName, clientType: clientTypeInput.value || '', securities: securities, timestamp: serverTimestamp() };
            let collectionPath = '';

            if (activityType === 'New Issues') {
                const ioi = ioiInput.value.trim();
                const orderSize = parseFloat(orderSizeInput.value);
                const realInterest = parseFloat(realInterestInput.value);
                const currency = niCurrencySelect.value.trim();
                const usdEquivalent = niUsdEquivalentInput.value.trim();

                if (!ioi || isNaN(orderSize) || isNaN(realInterest) || !currency) { showMessage(errorMessage, 'IOI, Order Size, Real Interest, and Currency are required for New Issues.'); return; }

                docData = { ...docData, ioi, orderSize, realInterest, priceTarget: document.getElementById('priceTarget').value, currency, usdEquivalent, remarks: document.getElementById('remarks').value };
                collectionPath = `artifacts/${appId}/users/${userId}/new_issues`;
            } else {
                const size = parseFloat(sizeInput.value);
                const priceTarget = document.getElementById('priceTarget').value.trim();
                const currency = currencySelect.value.trim();
                const usdEquivalent = usdEquivalentInput.value.trim();
                if (isNaN(size) || !priceTarget || !currency) { showMessage(errorMessage, 'Size, Price Target, and Currency are required.'); return; }

                docData = { ...docData, type: activityType, buySell: document.getElementById('buySell').value, size, priceTarget, currency, usdEquivalent };

                if (activityType === 'Missed Trades') {
                    const cptyTradedAway = document.getElementById('cptyTradedAway').value.trim();
                    if (!cptyTradedAway) { showMessage(errorMessage, 'CPTY Traded Away is required for Missed Trades.'); return; }
                    docData.tradedAwayLevel = priceTarget;
                    docData.cptyTradedAway = cptyTradedAway;
                    delete docData.priceTarget;
                }
                collectionPath = `artifacts/${appId}/users/${userId}/general_activities`;
            }

            try {
                await addDoc(collection(db, collectionPath), docData);
                resetFormState();
                showMessage(successMessage, 'Activity Logged!');
            } catch (error) {
                console.error('Error adding document: ', error);
                showMessage(errorMessage, `Failed to log activity: ${error.message}`);
            }
        });

        // Delete modal handling
        let docToDelete = null; let collectionToDelete = null;
        const showDeleteModal = (collectionName, docId) => { docToDelete = docId; collectionToDelete = collectionName; deleteModal.style.display = 'flex'; };
        const hideDeleteModal = () => { docToDelete = null; collectionToDelete = null; deleteModal.style.display = 'none'; };
        const handleDelete = async () => {
            if (docToDelete && collectionToDelete) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionToDelete}`, docToDelete);
                try { await deleteDoc(docRef); hideDeleteModal(); } catch (error) { console.error('Error removing document:', error); showMessage(errorMessage, 'Failed to delete entry.'); }
            }
        };
        confirmDeleteBtn.addEventListener('click', handleDelete);
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        window.showDeleteModal = showDeleteModal;

        const renderGeneralActivities = (activities) => {
            generalLogTable.innerHTML = '';
            activities.sort((a,b)=>{ const ta=a.timestamp?.toMillis()||0; const tb=b.timestamp?.toMillis()||0; return tb-ta; });
            activities.forEach(activity=>{
                const row = document.createElement('tr'); row.className='table-row text-sm';
                const priceValue = activity.type === 'Missed Trades' ? activity.tradedAwayLevel : activity.priceTarget;
                const cptyValue = activity.type === 'Missed Trades' ? activity.cptyTradedAway : 'N/A';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${activity.timestamp ? new Date(activity.timestamp.toMillis()).toLocaleString() : 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.type || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.clientName}</td>
                    <td class="p-3 whitespace-nowrap">${activity.clientType}</td>
                    <td class="p-3 whitespace-nowrap">${activity.securities}</td>
                    <td class="p-3 whitespace-nowrap">${activity.buySell || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.size || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${priceValue || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${cptyValue}</td>
                    <td class="p-3 text-right"><button class="btn-danger text-xs" onclick="showDeleteModal('general_activities','${activity.id}')">Delete</button></td>
                `;
                generalLogTable.appendChild(row);
            });
        };

        const renderNewIssues = (issues) => {
            newIssuesLogTable.innerHTML = '';
            issues.sort((a,b)=>{ const ta=a.timestamp?.toMillis()||0; const tb=b.timestamp?.toMillis()||0; return tb-ta; });
            issues.forEach(issue=>{
                const row = document.createElement('tr'); row.className='table-row text-sm';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${issue.timestamp ? new Date(issue.timestamp.toMillis()).toLocaleString() : 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.clientName}</td>
                    <td class="p-3 whitespace-nowrap">${issue.clientType}</td>
                    <td class="p-3 whitespace-nowrap">${issue.securities}</td>
                    <td class="p-3 whitespace-nowrap">${issue.ioi || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.orderSize || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.realInterest || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.priceTarget || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap max-w-xs overflow-hidden truncate" title="${issue.remarks || ''}">${issue.remarks || 'N/A'}</td>
                    <td class="p-3 text-right"><button class="btn-danger text-xs" onclick="showDeleteModal('new_issues','${issue.id}')">Delete</button></td>
                `;
                newIssuesLogTable.appendChild(row);
            });
        };

        // Clients management
        const populateClientDropdown = (clients) => {
            // clients is array of {id, name, type}
            clientNameSelect.innerHTML = '<option value="">(Select client from Client Database)</option>';
            clients.sort((a,b)=> (a.clientName || '').localeCompare(b.clientName || ''));
            clients.forEach(c=>{
                const opt = document.createElement('option'); opt.value = c.clientName; opt.textContent = c.clientName; opt.dataset.type = c.clientType || '';
                clientNameSelect.appendChild(opt);
            });
            clientsListDiv.textContent = `${clients.length} client(s) available.`;
            clientNameSelect.disabled = false;
        };

        addClientBtn.addEventListener('click', async () => {
            const nameRaw = (clientNameInputForDb.value || '').trim();
            const name = nameRaw.toUpperCase();
            const type = newClientTypeSelect.value;
            if (!name) { showMessage(errorMessage, 'Please enter a client name.'); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/clients`), { clientName: name, clientType: type, createdAt: serverTimestamp() });
                clientNameInputForDb.value = '';
                showMessage(successMessage, 'Client added.');
            } catch (err) { console.error('Add client error', err); showMessage(errorMessage, 'Failed to add client.'); }
        });

        clientNameSelect.addEventListener('change', (e)=>{
            const selected = e.target.selectedOptions[0];
            const type = selected?.dataset?.type || '';
            clientTypeInput.value = type;
        });

        // Initialization
        const initApp = async () => {
            const firebaseConfig = {
    apiKey: "AIzaSyA_CDa97jsoFr6rlUIUjF2PxJRzqTx6unU",
    authDomain: "bondtrackerdark3.firebaseapp.com",
    projectId: "bondtrackerdark3",
    storageBucket: "bondtrackerdark3.firebasestorage.app",
    messagingSenderId: "407269028098",
    appId: "1:407269028098:web:544d2c7b5002b524b8d21b",
            };
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) { console.error('Firebase init failed', e); showMessage(errorMessage, 'Firebase init failed'); return; }

            onAuthStateChanged(auth, (user)=>{
                if (user) { userId = user.uid; document.getElementById('userIdSpan').textContent = userId; isAuthReady = true; setupRealtimeListeners(); updateSubmitButtonState(); }
                else { signInAnonymously(auth).then(()=>console.log('Signed in anonymously')).catch(err=>{ console.error('Anon sign-in failed',err); document.getElementById('userIdSpan').textContent='Auth Error'; showMessage(errorMessage,'Authentication failed.'); }); }
            });

            if (initialAuthToken) { try { await signInWithCustomToken(auth, initialAuthToken); } catch(err){ console.error('Custom token sign-in failed', err); signInAnonymously(auth).catch(()=>{}); } } else { signInAnonymously(auth).catch(()=>{}); }
        };

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
