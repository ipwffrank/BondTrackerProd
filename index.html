<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Sales Activity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .container { max-width: 1200px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; color: #e2e8f0; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #63b3ed; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled { background-color: #4a5568; cursor: not-allowed; }
        .btn-primary { background-color: #4c51bf; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #667eea; }
        .btn-primary:disabled { background-color: #3b4252; cursor: not-allowed; color: #a0aec0; }
        .btn-secondary { background-color: #2b6cb0; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #4299e1; }
        .btn-secondary:disabled { background-color: #2c5282; cursor: not-allowed; opacity: 0.6; }
        .btn-muted { background-color: #4a5568; color: #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-muted:hover { background-color: #2d3748; }
        .btn-muted:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-danger { background-color: #e53e3e; color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #fc8181; }
        .tab-btn.active { background-color: #4c51bf; color: white; font-weight: 600; }
        .tab-btn:hover { background-color: #4a5568; }
        .tab-btn { transition: background-color 0.2s; }
        .table-header { background-color: #2d3748; color: #a0aec0; }
        .table-row:nth-child(odd) { background-color: #2d3748; }
        .table-row:nth-child(even) { background-color: #1a202c; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: #2d3748; margin: auto; padding: 24px; border: 1px solid #4a5568; width: 90%; max-width: 400px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center; }
        .auth-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top, rgba(76, 81, 191, 0.25), transparent), rgba(17, 24, 39, 0.95); z-index: 200; padding: 24px; }
        .auth-card { border: 1px solid rgba(99, 179, 237, 0.2); backdrop-filter: blur(6px); }
        .auth-card .btn-primary { width: 100%; }
        .tooltip { position: relative; cursor: help; }
        .tooltip::after { content: attr(data-tooltip); position: absolute; top: 50%; left: 100%; transform: translate(12px, -50%) scale(0.95); background-color: rgba(45, 55, 72, 0.95); color: #e2e8f0; padding: 6px 10px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35); z-index: 50; }
        .tooltip:hover::after { opacity: 1; transform: translate(12px, -50%) scale(1); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-card bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="authTitle" class="text-3xl font-bold text-center mb-6 text-indigo-400">Sign In</h2>
            <div id="authMessage" class="text-sm text-center mb-4 hidden"></div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input id="loginEmail" type="email" class="form-input" required autocomplete="email">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input id="loginPassword" type="password" class="form-input" required autocomplete="current-password">
                </div>
                <div class="text-right">
                    <button type="button" id="forgotPasswordBtn" class="text-indigo-400 text-sm font-semibold hover:underline">
                        Forgot Password?
                    </button>
                </div>
                <button type="submit" class="btn-primary w-full">Sign In</button>
            </form>

            <form id="registerForm" class="space-y-4 hidden">
                <div>
                    <label for="registerEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input id="registerEmail" type="email" class="form-input" required autocomplete="email">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input id="registerPassword" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <div>
                    <label for="registerPasswordConfirm" class="block text-sm font-medium mb-1">Confirm Password</label>
                    <input id="registerPasswordConfirm" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary w-full">Create Account</button>
            </form>

            <form id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-sm text-gray-300">Confirm your current credentials below to immediately set a new password.</p>
                <div>
                    <label for="forgotPasswordEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input id="forgotPasswordEmail" type="email" class="form-input" required autocomplete="email">
                </div>
                <div>
                    <label for="forgotPasswordCurrent" class="block text-sm font-medium mb-1">Current Password</label>
                    <input id="forgotPasswordCurrent" type="password" class="form-input" required autocomplete="current-password">
                </div>
                <div>
                    <label for="forgotPasswordNew" class="block text-sm font-medium mb-1">New Password</label>
                    <input id="forgotPasswordNew" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <div>
                    <label for="forgotPasswordConfirm" class="block text-sm font-medium mb-1">Confirm New Password</label>
                    <input id="forgotPasswordConfirm" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary w-full">Update Password</button>
                <button type="button" id="forgotPasswordBackBtn" class="w-full btn-muted">Back to Sign In</button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-400">
                <span id="toggleAuthText">Don't have an account?</span>
                <button id="toggleAuthBtn" type="button" class="text-indigo-400 font-semibold hover:underline ml-1">Register</button>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
            <div class="ml-4 text-white">Fetching rates...</div>
        </div>

        <div id="successMessage" class="fixed top-4 right-4 bg-green-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform translate-x-full hidden">Activity Logged!</div>
        <div id="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform hidden">Failed to log activity. Please try again.</div>

        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                <p class="mb-6">Are you sure you want to delete this entry?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Delete</button>
                    <button id="cancelDeleteBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
                </div>
            </div>
        </div>

        <div id="accountModal" class="modal">
            <div class="modal-content max-w-lg text-left">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-white">Account Overview</h3>
                    <button id="closeAccountModal" type="button" class="text-gray-400 hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm text-gray-400">Email</p>
                        <p id="accountEmail" class="text-lg font-semibold text-white">-</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wider text-gray-400">Total Logs</p>
                            <p id="accountLogsCount" class="text-2xl font-bold text-indigo-300 mt-1">0</p>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wider text-gray-400">Last Update</p>
                            <p id="accountLastUpdate" class="text-sm font-semibold text-white mt-1">N/A</p>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wider text-gray-400">Total Size (MM)</p>
                            <p id="accountTotalSize" class="text-2xl font-bold text-green-300 mt-1">0</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400">Password changes can now be made directly from the sign-in screen by selecting "Forgot Password?".</p>
                </div>
            </div>
        </div>

        <div id="editGeneralModal" class="modal">
            <div class="modal-content max-w-2xl text-left">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-white">Modify Activity</h3>
                    <button type="button" id="closeEditGeneralModal" class="text-gray-400 hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
                <form id="editGeneralForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-400">Client</p>
                            <p id="editGeneralClient" class="text-lg font-semibold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-400">Activity Type</p>
                            <p id="editGeneralType" class="text-lg font-semibold text-white">-</p>
                        </div>
                    </div>
                    <div id="editGeneralBuySellGroup">
                        <label for="editGeneralBuySell" class="block text-sm font-medium mb-1">Buy/Sell</label>
                        <select id="editGeneralBuySell" class="form-select">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editGeneralSize" class="block text-sm font-medium mb-1">Size (MM)</label>
                            <input id="editGeneralSize" type="number" step="any" min="0" class="form-input" required>
                        </div>
                        <div>
                            <label for="editGeneralCurrency" class="block text-sm font-medium mb-1">Currency</label>
                            <select id="editGeneralCurrency" class="form-select" required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="editGeneralPrice" id="editGeneralPriceLabel" class="block text-sm font-medium mb-1">Price Target</label>
                        <input id="editGeneralPrice" type="text" class="form-input" required>
                    </div>
                    <div>
                        <label for="editGeneralUsdEquivalent" class="block text-sm font-medium mb-1">USD Equivalent (MM)</label>
                        <input id="editGeneralUsdEquivalent" type="text" class="form-input" readonly>
                        <p class="text-xs text-gray-400 mt-1">USD equivalent recalculates automatically when size or currency changes.</p>
                    </div>
                    <div id="editGeneralCptyGroup" class="hidden">
                        <label for="editGeneralCpty" class="block text-sm font-medium mb-1">CPTY Traded Away</label>
                        <input id="editGeneralCpty" type="text" class="form-input">
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" class="btn-muted" id="cancelEditGeneral">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editNewIssueModal" class="modal">
            <div class="modal-content max-w-2xl text-left">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-white">Modify New Issue</h3>
                    <button type="button" id="closeEditNewIssueModal" class="text-gray-400 hover:text-gray-200 text-2xl leading-none">&times;</button>
                </div>
                <form id="editNewIssueForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-400">Client</p>
                            <p id="editNewIssueClient" class="text-lg font-semibold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase tracking-wider text-gray-400">Region</p>
                            <p id="editNewIssueRegion" class="text-lg font-semibold text-white">-</p>
                        </div>
                    </div>
                    <div>
                        <label for="editNewIssueIoi" class="block text-sm font-medium mb-1">IOI</label>
                        <input id="editNewIssueIoi" type="text" class="form-input" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editNewIssueSize" class="block text-sm font-medium mb-1">Size (MM)</label>
                            <input id="editNewIssueSize" type="number" step="any" min="0" class="form-input" required>
                        </div>
                        <div>
                            <label for="editNewIssueOrderSize" class="block text-sm font-medium mb-1">Order Size (MM)</label>
                            <input id="editNewIssueOrderSize" type="number" step="any" min="0" class="form-input" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editNewIssueRealInterest" class="block text-sm font-medium mb-1">Real Interest (MM)</label>
                            <input id="editNewIssueRealInterest" type="number" step="any" min="0" class="form-input" required>
                        </div>
                        <div>
                            <label for="editNewIssueCurrency" class="block text-sm font-medium mb-1">Currency</label>
                            <select id="editNewIssueCurrency" class="form-select" required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="editNewIssuePriceTarget" class="block text-sm font-medium mb-1">Price Target</label>
                        <input id="editNewIssuePriceTarget" type="text" class="form-input">
                    </div>
                    <div>
                        <label for="editNewIssueUsdEquivalent" class="block text-sm font-medium mb-1">USD Equivalent (MM)</label>
                        <input id="editNewIssueUsdEquivalent" type="text" class="form-input" readonly>
                        <p class="text-xs text-gray-400 mt-1">USD equivalent is based on Order Size and currency.</p>
                    </div>
                    <div>
                        <label for="editNewIssueRemarks" class="block text-sm font-medium mb-1">Remarks</label>
                        <textarea id="editNewIssueRemarks" rows="3" class="form-textarea"></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" class="btn-muted" id="cancelEditNewIssue">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="container mx-auto p-8 lg:p-12">
        <h1 class="text-4xl lg:text-5xl font-extrabold text-center mb-6 text-indigo-400">Bond Sales Activity Tracker</h1>
        <div id="userControls" class="flex flex-col md:flex-row items-center justify-center md:justify-between gap-3 text-sm mb-6 text-gray-500">
            <div id="userGreeting" class="text-center md:text-left">Signed in as <span id="userEmailSpan" class="text-gray-200 font-medium">Loading...</span></div>
            <div class="flex gap-2">
                <button id="accountBtn" type="button" class="btn-secondary py-2 px-4 md:px-6 text-xs md:text-sm" disabled>Account</button>
                <button id="signOutBtn" type="button" class="btn-primary py-2 px-4 md:px-6 text-xs md:text-sm">Sign Out</button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Client Database</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input id="newClientName" class="form-input" placeholder="Client Name" />
                <select id="newClientType" class="form-select">
                    <option value="">Select Type</option>
                    <option value="TREASURY">TREASURY</option>
                    <option value="ASSET MANAGER">ASSET MANAGER</option>
                    <option value="HEDGE FUND">HEDGE FUND</option>
                    <option value="SWF">SWF</option>
                    <option value="CENTRAL BANK">CENTRAL BANK</option>
                    <option value="PROP">PROP</option>
                    <option value="WM">WM</option>
                </select>
                <input id="newClientRegion" class="form-input" placeholder="Region (E.g., APAC, EMEA, AMER)" />
                <div class="flex items-center">
                    <button id="addClientBtn" class="btn-primary w-full py-2">Add Client</button>
                </div>
            </div>
            <div id="clientsList" class="text-sm text-gray-300">Clients will appear in the dropdown when added.</div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Log New Activity</h2>
            <div id="activity-hint" class="text-sm text-center mb-4 text-gray-400">Please select an activity type below to enable the form.</div>

            <div class="flex flex-wrap gap-2 mb-6 justify-center lg:justify-start">
                <button id="tab-enquiry" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Enquiry</button>
                <button id="tab-trade" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Trade</button>
                <button id="tab-missed-trades" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Missed Trades</button>
                <button id="tab-new-issues" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <form id="activityForm">
                <input type="hidden" id="activityType" value="" required>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="form-group">
                        <label for="clientName" class="block mb-2 text-sm font-medium">Client Name</label>
                        <select id="clientName" class="form-select" disabled required>
                            <option value="">(Select client from Client Database)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientType" class="block mb-2 text-sm font-medium">Client Type</label>
                        <input type="text" id="clientType" class="form-input" disabled placeholder="Auto-filled from client database" />
                    </div>
                    <div class="form-group">
                        <label for="clientRegion" class="block mb-2 text-sm font-medium">Client Region</label>
                        <input type="text" id="clientRegion" class="form-input" disabled placeholder="Auto-filled from client database" />
                    </div>
                    <div class="form-group">
                        <label for="securities" class="block mb-2 text-sm font-medium">Securities</label>
                        <input type="text" id="securities" class="form-input" disabled required>
                    </div>

                    <!-- General fields for all activity types -->
                    <div id="commonFields" class="contents">
                        <div class="form-group">
                            <label for="buySell" class="block mb-2 text-sm font-medium">Buy/Sell</label>
                            <select id="buySell" class="form-select" disabled>
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="size" class="block mb-2 text-sm font-medium">Size (MM)</label>
                            <input type="number" id="size" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="priceTarget" class="block mb-2 text-sm font-medium" id="priceLabel">Price Target</label>
                            <input type="text" id="priceTarget" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="currency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="currency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="usdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="usdEquivalent" class="form-input" disabled readonly>
                        </div>
                    </div>

                    <!-- Specific field for Missed Trades -->
                    <div id="missedTradeFields" class="form-group hidden">
                        <label for="cptyTradedAway" class="block mb-2 text-sm font-medium">CPTY Traded Away</label>
                        <input type="text" id="cptyTradedAway" class="form-input" disabled required>
                    </div>

                    <!-- Specific fields for New Issues -->
                    <div id="newIssueFields" class="contents hidden">
                        <div class="form-group">
                            <label for="ioi" class="block mb-2 text-sm font-medium">IOI</label>
                            <input type="text" id="ioi" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="orderSize" class="block mb-2 text-sm font-medium">Order Size (MM)</label>
                            <input type="number" id="orderSize" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="realInterest" class="block mb-2 text-sm font-medium">Real Interest (MM)</label>
                            <input type="number" id="realInterest" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="niCurrency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="niCurrency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="niUsdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="niUsdEquivalent" class="form-input" disabled readonly>
                        </div>

                        <div class="form-group lg:col-span-3">
                            <label for="remarks" class="block mb-2 text-sm font-medium">Remarks</label>
                            <textarea id="remarks" class="form-textarea" disabled rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center md:text-right">
                    <button type="submit" id="submitBtn" class="btn-primary mt-4" disabled>Log Activity</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Activity Log</h2>

            <div class="flex flex-wrap gap-2 mb-6">
                <button id="log-general-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600 active">General Activities</button>
                <button id="log-new-issues-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <div id="generalLog" class="space-y-4">
                <div id="generalLogControls" class="flex flex-wrap gap-3 text-sm text-gray-300">
                    <div class="flex flex-col">
                        <label for="generalSortColumn" class="text-xs uppercase tracking-wider text-gray-400">Sort Column</label>
                        <select id="generalSortColumn" class="form-select text-sm">
                            <option value="timestamp">Timestamp</option>
                            <option value="type">Activity Type</option>
                            <option value="clientName">Client</option>
                            <option value="clientType">Client Type</option>
                            <option value="clientRegion">Region</option>
                            <option value="securities">Securities</option>
                            <option value="buySell">Buy/Sell</option>
                            <option value="size">Size (MM)</option>
                            <option value="price">Price/Level</option>
                            <option value="currency">Currency</option>
                            <option value="usdEquivalent">USD Eq.</option>
                            <option value="cpty">CPTY</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="generalSortDirection" class="text-xs uppercase tracking-wider text-gray-400">Direction</label>
                        <select id="generalSortDirection" class="form-select text-sm">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="generalFilterColumn" class="text-xs uppercase tracking-wider text-gray-400">Filter Column</label>
                        <select id="generalFilterColumn" class="form-select text-sm">
                            <option value="all">All Columns</option>
                            <option value="timestamp">Timestamp</option>
                            <option value="type">Activity Type</option>
                            <option value="clientName">Client</option>
                            <option value="clientType">Client Type</option>
                            <option value="clientRegion">Region</option>
                            <option value="securities">Securities</option>
                            <option value="buySell">Buy/Sell</option>
                            <option value="size">Size (MM)</option>
                            <option value="price">Price/Level</option>
                            <option value="currency">Currency</option>
                            <option value="usdEquivalent">USD Eq.</option>
                            <option value="cpty">CPTY</option>
                        </select>
                    </div>
                    <div class="flex flex-col flex-1 min-w-[180px]">
                        <label for="generalFilterValue" class="text-xs uppercase tracking-wider text-gray-400">Filter Value</label>
                        <input id="generalFilterValue" type="text" class="form-input text-sm" placeholder="Type to filter...">
                    </div>
                    <div class="flex items-end">
                        <button type="button" id="generalClearFilters" class="btn-muted px-4 py-2 text-sm">Clear</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full rounded-lg overflow-hidden">
                        <thead>
                            <tr class="table-header text-xs uppercase tracking-wider">
                                <th class="p-3 text-left">Timestamp</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">Client</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Region</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">Buy/Sell</th>
                            <th class="p-3 text-left">Size (MM)</th>
                            <th class="p-3 text-left">Price/Level</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">CPTY</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                        <tbody id="generalLogTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="newIssuesLog" class="space-y-4 hidden">
                <div id="newIssuesLogControls" class="flex flex-wrap gap-3 text-sm text-gray-300">
                    <div class="flex flex-col">
                        <label for="newIssuesSortColumn" class="text-xs uppercase tracking-wider text-gray-400">Sort Column</label>
                        <select id="newIssuesSortColumn" class="form-select text-sm">
                            <option value="timestamp">Timestamp</option>
                            <option value="clientName">Client</option>
                            <option value="clientType">Client Type</option>
                            <option value="clientRegion">Region</option>
                            <option value="securities">Securities</option>
                            <option value="ioi">IOI</option>
                            <option value="orderSize">Order Size</option>
                            <option value="realInterest">Real Interest</option>
                            <option value="priceTarget">Price Target</option>
                            <option value="currency">Currency</option>
                            <option value="usdEquivalent">USD Eq.</option>
                            <option value="remarks">Remarks</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="newIssuesSortDirection" class="text-xs uppercase tracking-wider text-gray-400">Direction</label>
                        <select id="newIssuesSortDirection" class="form-select text-sm">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="newIssuesFilterColumn" class="text-xs uppercase tracking-wider text-gray-400">Filter Column</label>
                        <select id="newIssuesFilterColumn" class="form-select text-sm">
                            <option value="all">All Columns</option>
                            <option value="timestamp">Timestamp</option>
                            <option value="clientName">Client</option>
                            <option value="clientType">Client Type</option>
                            <option value="clientRegion">Region</option>
                            <option value="securities">Securities</option>
                            <option value="ioi">IOI</option>
                            <option value="orderSize">Order Size</option>
                            <option value="realInterest">Real Interest</option>
                            <option value="priceTarget">Price Target</option>
                            <option value="currency">Currency</option>
                            <option value="usdEquivalent">USD Eq.</option>
                            <option value="remarks">Remarks</option>
                        </select>
                    </div>
                    <div class="flex flex-col flex-1 min-w-[180px]">
                        <label for="newIssuesFilterValue" class="text-xs uppercase tracking-wider text-gray-400">Filter Value</label>
                        <input id="newIssuesFilterValue" type="text" class="form-input text-sm" placeholder="Type to filter...">
                    </div>
                    <div class="flex items-end">
                        <button type="button" id="newIssuesClearFilters" class="btn-muted px-4 py-2 text-sm">Clear</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full rounded-lg overflow-hidden">
                        <thead>
                            <tr class="table-header text-xs uppercase tracking-wider">
                                <th class="p-3 text-left">Timestamp</th>
                                <th class="p-3 text-left">Client</th>
                                <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Region</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">IOI</th>
                            <th class="p-3 text-left">Order Size</th>
                            <th class="p-3 text-left">Real Interest</th>
                            <th class="p-3 text-left">Price Target</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">Remarks</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                        <tbody id="newIssuesLogTable"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // IMPORTANT: For debugging, enable Firestore logging
        setLogLevel('debug');

        // Global variables for Firebase and auth

let app;   // ✅ declare app here
let db;
let auth;
let userId = null;
let isAuthReady = false;
let appId;
let generalUnsub = null;
let newIssuesUnsub = null;
let clientsUnsub = null;
let generalActivities = [];
let newIssueActivities = [];
let activeGeneralDocId = null;
let activeGeneralActivityType = '';
let activeNewIssueDocId = null;


        const appContent = document.getElementById('appContent');
        const authOverlay = document.getElementById('authOverlay');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleAuthBtn = document.getElementById('toggleAuthBtn');
        const toggleAuthText = document.getElementById('toggleAuthText');
        const authTitle = document.getElementById('authTitle');
        const authMessage = document.getElementById('authMessage');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerPasswordConfirmInput = document.getElementById('registerPasswordConfirm');
        const allFormFields = document.querySelectorAll('#activityForm input, #activityForm select, #activityForm textarea');
        const clientNameSelect = document.getElementById('clientName');
        const clientNameInputForDb = document.getElementById('newClientName');
        const newClientTypeSelect = document.getElementById('newClientType');
        const newClientRegionInput = document.getElementById('newClientRegion');
        const addClientBtn = document.getElementById('addClientBtn');
        const clientsListDiv = document.getElementById('clientsList');
        const clientTypeInput = document.getElementById('clientType');
        const clientRegionInput = document.getElementById('clientRegion');
        const securitiesInput = document.getElementById('securities');
        const buySell = document.getElementById('buySell');
        const cptyTradedAwayInput = document.getElementById('cptyTradedAway');
        const activityTypeInput = document.getElementById('activityType');
        const usdEquivalentInput = document.getElementById('usdEquivalent');
        const sizeInput = document.getElementById('size');
        const currencySelect = document.getElementById('currency');
        const priceLabel = document.getElementById('priceLabel');
        const activityForm = document.getElementById('activityForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generalLogTable = document.getElementById('generalLogTable');
        const newIssuesLogTable = document.getElementById('newIssuesLogTable');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const activityHint = document.getElementById('activity-hint');
        const signOutBtn = document.getElementById('signOutBtn');
        const userEmailSpan = document.getElementById('userEmailSpan');
        const accountBtn = document.getElementById('accountBtn');
        const accountModal = document.getElementById('accountModal');
        const closeAccountModalBtn = document.getElementById('closeAccountModal');
        const accountEmailDisplay = document.getElementById('accountEmail');
        const accountLogsCount = document.getElementById('accountLogsCount');
        const accountLastUpdate = document.getElementById('accountLastUpdate');
        const accountTotalSize = document.getElementById('accountTotalSize');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const forgotPasswordBackBtn = document.getElementById('forgotPasswordBackBtn');
        const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
        const forgotPasswordCurrentInput = document.getElementById('forgotPasswordCurrent');
        const forgotPasswordNewInput = document.getElementById('forgotPasswordNew');
        const forgotPasswordConfirmInput = document.getElementById('forgotPasswordConfirm');

        const generalSortColumnSelect = document.getElementById('generalSortColumn');
        const generalSortDirectionSelect = document.getElementById('generalSortDirection');
        const generalFilterColumnSelect = document.getElementById('generalFilterColumn');
        const generalFilterValueInput = document.getElementById('generalFilterValue');
        const generalClearFiltersBtn = document.getElementById('generalClearFilters');

        const newIssuesSortColumnSelect = document.getElementById('newIssuesSortColumn');
        const newIssuesSortDirectionSelect = document.getElementById('newIssuesSortDirection');
        const newIssuesFilterColumnSelect = document.getElementById('newIssuesFilterColumn');
        const newIssuesFilterValueInput = document.getElementById('newIssuesFilterValue');
        const newIssuesClearFiltersBtn = document.getElementById('newIssuesClearFilters');

        const generalSortState = {
            column: 'timestamp',
            direction: 'desc',
            filterColumn: 'all',
            filterValue: ''
        };

        const newIssuesSortState = {
            column: 'timestamp',
            direction: 'desc',
            filterColumn: 'all',
            filterValue: ''
        };

        const editGeneralModal = document.getElementById('editGeneralModal');
        const editGeneralForm = document.getElementById('editGeneralForm');
        const editGeneralClient = document.getElementById('editGeneralClient');
        const editGeneralType = document.getElementById('editGeneralType');
        const editGeneralBuySellGroup = document.getElementById('editGeneralBuySellGroup');
        const editGeneralBuySell = document.getElementById('editGeneralBuySell');
        const editGeneralSize = document.getElementById('editGeneralSize');
        const editGeneralCurrency = document.getElementById('editGeneralCurrency');
        const editGeneralPriceLabel = document.getElementById('editGeneralPriceLabel');
        const editGeneralPrice = document.getElementById('editGeneralPrice');
        const editGeneralUsdEquivalent = document.getElementById('editGeneralUsdEquivalent');
        const editGeneralCptyGroup = document.getElementById('editGeneralCptyGroup');
        const editGeneralCpty = document.getElementById('editGeneralCpty');
        const closeEditGeneralModalBtn = document.getElementById('closeEditGeneralModal');
        const cancelEditGeneralBtn = document.getElementById('cancelEditGeneral');

        const editNewIssueModal = document.getElementById('editNewIssueModal');
        const editNewIssueForm = document.getElementById('editNewIssueForm');
        const editNewIssueClient = document.getElementById('editNewIssueClient');
        const editNewIssueRegion = document.getElementById('editNewIssueRegion');
        const editNewIssueIoi = document.getElementById('editNewIssueIoi');
        const editNewIssueSize = document.getElementById('editNewIssueSize');
        const editNewIssueOrderSize = document.getElementById('editNewIssueOrderSize');
        const editNewIssueRealInterest = document.getElementById('editNewIssueRealInterest');
        const editNewIssueCurrency = document.getElementById('editNewIssueCurrency');
        const editNewIssuePriceTarget = document.getElementById('editNewIssuePriceTarget');
        const editNewIssueUsdEquivalent = document.getElementById('editNewIssueUsdEquivalent');
        const editNewIssueRemarks = document.getElementById('editNewIssueRemarks');
        const closeEditNewIssueModalBtn = document.getElementById('closeEditNewIssueModal');
        const cancelEditNewIssueBtn = document.getElementById('cancelEditNewIssue');

        // New Issues specific
        const ioiInput = document.getElementById('ioi');
        const orderSizeInput = document.getElementById('orderSize');
        const realInterestInput = document.getElementById('realInterest');
        const niCurrencySelect = document.getElementById('niCurrency');
        const niUsdEquivalentInput = document.getElementById('niUsdEquivalent');

        const setAuthMessage = (message = '', type = 'error') => {
            if (!authMessage) return;
            authMessage.textContent = message;
            if (!message) {
                authMessage.classList.add('hidden');
                return;
            }
            authMessage.classList.remove('hidden');
            authMessage.classList.remove('text-red-400', 'text-green-400');
            authMessage.classList.add(type === 'success' ? 'text-green-400' : 'text-red-400');
        };

        const resetForgotPasswordForm = () => {
            if (forgotPasswordForm) forgotPasswordForm.reset();
        };

        const openModal = (modal) => { if (modal) modal.style.display = 'flex'; };
        const closeModal = (modal) => { if (modal) modal.style.display = 'none'; };

        const updateAccountOverview = () => {
            if (!accountLogsCount || !accountLastUpdate || !accountTotalSize) return;
            const totalLogs = generalActivities.length + newIssueActivities.length;
            accountLogsCount.textContent = totalLogs.toString();

            const timestamps = [];
            generalActivities.forEach(activity => {
                const ts = activity.lastModifiedAt?.toMillis?.() || activity.timestamp?.toMillis?.();
                if (ts) timestamps.push(ts);
            });
            newIssueActivities.forEach(issue => {
                const ts = issue.lastModifiedAt?.toMillis?.() || issue.timestamp?.toMillis?.();
                if (ts) timestamps.push(ts);
            });

            const lastTimestamp = timestamps.length ? Math.max(...timestamps) : null;
            accountLastUpdate.textContent = lastTimestamp ? new Date(lastTimestamp).toLocaleString() : 'N/A';

            const totalGeneralSize = generalActivities.reduce((sum, act) => sum + (parseFloat(act.size) || 0), 0);
            const totalNewIssueSize = newIssueActivities.reduce((sum, issue) => sum + (parseFloat(issue.orderSize) || 0), 0);
            const totalSize = totalGeneralSize + totalNewIssueSize;
            accountTotalSize.textContent = totalSize ? totalSize.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '0';
        };

        const authToggleContainer = toggleAuthText ? toggleAuthText.parentElement : null;

        const switchAuthView = (view = 'login') => {
            if (loginForm) loginForm.classList.toggle('hidden', view !== 'login');
            if (registerForm) registerForm.classList.toggle('hidden', view !== 'register');
            if (forgotPasswordForm) forgotPasswordForm.classList.toggle('hidden', view !== 'forgot');

            if (view === 'register') {
                authTitle.textContent = 'Create Account';
                toggleAuthText.textContent = 'Already have an account?';
                toggleAuthBtn.textContent = 'Sign In';
                if (authToggleContainer) authToggleContainer.classList.remove('hidden');
            } else if (view === 'forgot') {
                authTitle.textContent = 'Reset Password';
                if (authToggleContainer) authToggleContainer.classList.add('hidden');
            } else {
                authTitle.textContent = 'Sign In';
                toggleAuthText.textContent = "Don't have an account?";
                toggleAuthBtn.textContent = 'Register';
                if (authToggleContainer) authToggleContainer.classList.remove('hidden');
            }

            if (view !== 'forgot') resetForgotPasswordForm();
            setAuthMessage('');
        };

        const showMessage = (element, message, duration = 2500) => {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('translate-y-0');
            setTimeout(() => { element.classList.remove('translate-y-0'); element.classList.add('-translate-y-full'); }, duration);
            setTimeout(() => { element.classList.add('hidden'); element.classList.remove('-translate-y-full'); }, duration + 500);
        };

        const updateSubmitButtonState = () => {
            const isActivitySelected = activityTypeInput.value.trim() !== '';
            submitBtn.disabled = !(isAuthReady && isActivitySelected);
            if (isActivitySelected) activityHint.classList.add('hidden'); else activityHint.classList.remove('hidden');
        };

        const setupRealtimeListeners = () => {
            if (!isAuthReady || !userId || !appId) return;
            const generalActivitiesPath = `artifacts/${appId}/users/${userId}/general_activities`;
            const newIssuesPath = `artifacts/${appId}/users/${userId}/new_issues`;
            const clientsPath = `artifacts/${appId}/clients`;

            if (generalUnsub) generalUnsub();
            generalUnsub = onSnapshot(collection(db, generalActivitiesPath), (snapshot) => {
                const activities = [];
                snapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));
                renderGeneralActivities(activities);
            }, (error) => { console.error('Error fetching general activities:', error); showMessage(errorMessage, `Failed to load activities: ${error.message}`); });

            if (newIssuesUnsub) newIssuesUnsub();
            newIssuesUnsub = onSnapshot(collection(db, newIssuesPath), (snapshot) => {
                const newIssues = [];
                snapshot.forEach(doc => newIssues.push({ id: doc.id, ...doc.data() }));
                renderNewIssues(newIssues);
            }, (error) => { console.error('Error fetching new issues:', error); showMessage(errorMessage, `Failed to load new issues: ${error.message}`); });

            if (clientsUnsub) clientsUnsub();
            clientsUnsub = onSnapshot(collection(db, clientsPath), (snapshot) => {
                const clients = [];
                snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                populateClientDropdown(clients);
            }, (error) => { console.error('Error fetching clients:', error); showMessage(errorMessage, `Failed to load clients: ${error.message}`); });
        };

        const clearRealtimeListeners = () => {
            if (generalUnsub) { generalUnsub(); generalUnsub = null; }
            if (newIssuesUnsub) { newIssuesUnsub(); newIssuesUnsub = null; }
            if (clientsUnsub) { clientsUnsub(); clientsUnsub = null; }
        };

        const resetAppState = () => {
            generalLogTable.innerHTML = '';
            newIssuesLogTable.innerHTML = '';
            clientsListDiv.textContent = 'Sign in to view clients.';
            clientNameSelect.innerHTML = '<option value="">(Select client from Client Database)</option>';
            clientNameSelect.disabled = true;
            clientTypeInput.value = '';
            clientRegionInput.value = '';
            securitiesInput.value = '';
            cptyTradedAwayInput.value = '';
            activityForm.reset();
            activityTypeInput.value = '';
            tabButtons.forEach(btn => btn.classList.remove('active'));
            const generalTab = document.getElementById('log-general-tab');
            const newIssuesTab = document.getElementById('log-new-issues-tab');
            if (generalTab) generalTab.classList.add('active');
            if (newIssuesTab) newIssuesTab.classList.remove('active');
            document.getElementById('generalLog').classList.remove('hidden');
            document.getElementById('newIssuesLog').classList.add('hidden');
            showFormFields('');
            activityHint.classList.remove('hidden');
            submitBtn.disabled = true;
            if (userEmailSpan) userEmailSpan.textContent = 'Guest';
            if (accountBtn) accountBtn.disabled = true;
            if (accountEmailDisplay) accountEmailDisplay.textContent = '-';
            if (accountLogsCount) accountLogsCount.textContent = '0';
            if (accountLastUpdate) accountLastUpdate.textContent = 'N/A';
            if (accountTotalSize) accountTotalSize.textContent = '0';
            closeModal(accountModal);
            closeModal(editGeneralModal);
            closeModal(editNewIssueModal);
            generalActivities = [];
            newIssueActivities = [];
            activeGeneralDocId = null;
            activeNewIssueDocId = null;
            updateAccountOverview();
        };

        switchAuthView('login');

        toggleAuthBtn.addEventListener('click', () => {
            const isShowingLogin = !loginForm.classList.contains('hidden');
            switchAuthView(isShowingLogin ? 'register' : 'login');
        });

        if (forgotPasswordBtn) {
            forgotPasswordBtn.addEventListener('click', () => switchAuthView('forgot'));
        }

        if (forgotPasswordBackBtn) {
            forgotPasswordBackBtn.addEventListener('click', () => switchAuthView('login'));
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) return;
                const email = (loginEmailInput.value || '').trim();
                const password = loginPasswordInput.value || '';
                if (!email || !password) {
                    setAuthMessage('Please provide your email and password.');
                    return;
                }

                const submitButton = loginForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Signing In...';
                setAuthMessage('Signing in...', 'success');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    setAuthMessage('Signed in successfully!', 'success');
                } catch (err) {
                    console.error('Sign in failed', err);
                    setAuthMessage(err.message || 'Failed to sign in.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) return;
                const email = (registerEmailInput.value || '').trim();
                const password = registerPasswordInput.value || '';
                const confirmPassword = registerPasswordConfirmInput.value || '';

                if (!email || !password || !confirmPassword) {
                    setAuthMessage('Please complete all fields.');
                    return;
                }

                if (password !== confirmPassword) {
                    setAuthMessage('Passwords do not match.');
                    return;
                }

                const submitButton = registerForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Creating...';
                setAuthMessage('Creating your account...', 'success');

                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    setAuthMessage('Account created! You are now signed in.', 'success');
                } catch (err) {
                    console.error('Registration failed', err);
                    setAuthMessage(err.message || 'Failed to create account.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }

        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) return;

                const email = (forgotPasswordEmailInput?.value || '').trim();
                const currentPassword = forgotPasswordCurrentInput?.value || '';
                const newPassword = forgotPasswordNewInput?.value || '';
                const confirmPassword = forgotPasswordConfirmInput?.value || '';

                if (!email || !currentPassword || !newPassword || !confirmPassword) {
                    setAuthMessage('All fields are required to reset your password.');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    setAuthMessage('New passwords do not match.');
                    return;
                }

                const submitButton = forgotPasswordForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Updating...';
                setAuthMessage('Verifying credentials...', 'success');

                try {
                    const credential = EmailAuthProvider.credential(email, currentPassword);
                    const userCredential = await signInWithEmailAndPassword(auth, email, currentPassword);
                    await reauthenticateWithCredential(userCredential.user, credential);
                    await updatePassword(userCredential.user, newPassword);
                    resetForgotPasswordForm();
                    setAuthMessage('Password updated successfully. You are now signed in.', 'success');
                } catch (err) {
                    console.error('Password reset failed', err);
                    setAuthMessage(err.message || 'Failed to update password.');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }

        if (signOutBtn) {
            signOutBtn.addEventListener('click', async () => {
                if (!auth) return;
                try {
                    await signOut(auth);
                } catch (err) {
                    console.error('Sign out failed', err);
                    showMessage(errorMessage, 'Failed to sign out.');
                }
            });
        }

        const hideAccountModal = () => {
            closeModal(accountModal);
        };

        if (accountBtn) {
            accountBtn.addEventListener('click', () => {
                if (!auth || !auth.currentUser) {
                    showMessage(errorMessage, 'You must be signed in to view account details.');
                    return;
                }
                accountEmailDisplay.textContent = auth.currentUser.email || '-';
                updateAccountOverview();
                openModal(accountModal);
            });
        }

        if (closeAccountModalBtn) {
            closeAccountModalBtn.addEventListener('click', hideAccountModal);
        }

        if (accountModal) {
            accountModal.addEventListener('click', (event) => {
                if (event.target === accountModal) {
                    hideAccountModal();
                }
            });
        }

        const tabButtons = document.querySelectorAll('#tab-enquiry, #tab-trade, #tab-missed-trades, #tab-new-issues');
        const generalTabs = document.querySelectorAll('#log-general-tab, #log-new-issues-tab');

 
const showFormFields = (type) => {
    const commonFields = document.getElementById('commonFields');
    const missedTradeFields = document.getElementById('missedTradeFields');
    const newIssueFields = document.getElementById('newIssueFields');

    // Reset all fields
// Reset all fields EXCEPT client-related ones
allFormFields.forEach(field => {
    if (field.id !== "clientName" && field.id !== "clientType" && field.id !== "clientRegion") {
        field.disabled = true;
        field.required = false;
    }
});

// Always keep client dropdown enabled if there are clients
if (clientNameSelect.options.length > 1) {
    clientNameSelect.disabled = false;
}

    // Helper: restore hidden fields
    const restoreFields = () => {
        document.getElementById('priceTarget').parentElement.style.display = "";
        buySell.parentElement.style.display = "";
        currencySelect.parentElement.style.display = "";
        usdEquivalentInput.parentElement.style.display = "";
        niCurrencySelect.parentElement.style.display = "";
        niUsdEquivalentInput.parentElement.style.display = "";
    };

    // Default: show common fields, hide extras
    commonFields.classList.remove('hidden');
    missedTradeFields.classList.add('hidden');
    newIssueFields.classList.add('hidden');
    priceLabel.textContent = 'Price Target';

    switch(type.trim().toUpperCase()) {
        case 'ENQUIRY':
        case 'TRADE':
            restoreFields();

            sizeInput.disabled = false;
            sizeInput.required = true;

            document.getElementById('priceTarget').disabled = false;
            document.getElementById('priceTarget').required = true;

            securitiesInput.disabled = false;
            securitiesInput.required = true;

            buySell.disabled = false;

            currencySelect.disabled = false;
            currencySelect.required = true;

            usdEquivalentInput.disabled = false;
            break;

        case 'MISSED TRADES':
            restoreFields();
            priceLabel.textContent = 'Traded away level';
            missedTradeFields.classList.remove('hidden');

            sizeInput.disabled = false;
            sizeInput.required = true;

            document.getElementById('priceTarget').disabled = false;
            document.getElementById('priceTarget').required = true;

            securitiesInput.disabled = false;
            securitiesInput.required = true;

            buySell.disabled = false;

            currencySelect.disabled = false;
            currencySelect.required = true;

            usdEquivalentInput.disabled = false;

            cptyTradedAwayInput.disabled = false;
            cptyTradedAwayInput.required = true;
            break;

        case 'NEW ISSUES':
            // Show only relevant fields
            commonFields.classList.remove('hidden');
            newIssueFields.classList.remove('hidden');

            // Securities
            securitiesInput.disabled = false;
            securitiesInput.required = true;

            // Size
            sizeInput.disabled = false;
            sizeInput.required = true;

            // IOI
            ioiInput.disabled = false;
            ioiInput.required = true;

            // Order Size
            orderSizeInput.disabled = false;
            orderSizeInput.required = true;

            // Real Interest
            realInterestInput.disabled = false;
            realInterestInput.required = true;

            // Remarks
            document.getElementById('remarks').disabled = false;
            document.getElementById('remarks').required = true;

            // Hide unused fields
            document.getElementById('priceTarget').disabled = true;
            document.getElementById('priceTarget').required = false;
            document.getElementById('priceTarget').parentElement.style.display = "none";

            buySell.disabled = true;
            buySell.parentElement.style.display = "none";

            currencySelect.disabled = true;
            currencySelect.required = false;
            currencySelect.parentElement.style.display = "none";

            usdEquivalentInput.disabled = true;
            usdEquivalentInput.parentElement.style.display = "none";

            niCurrencySelect.disabled = false;
            niCurrencySelect.required = true;
            niCurrencySelect.parentElement.style.display = "";

            niUsdEquivalentInput.disabled = false;
            niUsdEquivalentInput.readOnly = true;
            niUsdEquivalentInput.parentElement.style.display = "";
            break;

        default:
            // leave everything disabled
            restoreFields();
            break;
    }
};



        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activityTypeInput.value = btn.textContent.trim().toUpperCase();
                showFormFields(btn.textContent);
                updateSubmitButtonState();
            });
        });

        generalTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                generalTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('generalLog').classList.add('hidden');
                document.getElementById('newIssuesLog').classList.add('hidden');
                if (btn.id === 'log-general-tab') document.getElementById('generalLog').classList.remove('hidden'); else document.getElementById('newIssuesLog').classList.remove('hidden');
            });
        });

        // Case-insensitivity logic
        clientNameInputForDb.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        newClientRegionInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        securitiesInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        cptyTradedAwayInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());

        const getUSDConversionRate = async (fromCurrency) => {
            const c = (fromCurrency || '').toUpperCase();
            if (c === 'USD' || c === '') return 1;
            try {
                const res = await fetch(`https://api.exchangerate.host/latest?base=${c}&symbols=USD`);
                if (!res.ok) return null;
                const data = await res.json();
                const rate = data?.rates?.USD;
                return rate;
            } catch (err) {
                console.error('Rate fetch error', err);
                return null;
            }
        };

        const updateUSDEquivalent = async () => {
            const activeTab = activityTypeInput.value.trim().toUpperCase();
            let effectiveSize, effectiveCurrencySelect, effectiveUsdEquivalentInput;

            if (activeTab === 'NEW ISSUES') {
                effectiveSize = parseFloat(orderSizeInput.value);
                effectiveCurrencySelect = niCurrencySelect;
                effectiveUsdEquivalentInput = niUsdEquivalentInput;
            } else {
                effectiveSize = parseFloat(sizeInput.value);
                effectiveCurrencySelect = currencySelect;
                effectiveUsdEquivalentInput = usdEquivalentInput;
            }

            const currency = (effectiveCurrencySelect?.value || '').trim().toUpperCase();
            if (isNaN(effectiveSize) || !currency) { if (effectiveUsdEquivalentInput) effectiveUsdEquivalentInput.value = ''; return; }

            loadingIndicator.classList.remove('hidden');
            const rate = await getUSDConversionRate(currency);
            loadingIndicator.classList.add('hidden');
            if (rate !== null) {
                effectiveUsdEquivalentInput.value = (effectiveSize * rate).toFixed(2);
            } else {
                effectiveUsdEquivalentInput.value = 'N/A';
            }
        };

        sizeInput.addEventListener('input', updateUSDEquivalent);
        currencySelect.addEventListener('change', updateUSDEquivalent);
        orderSizeInput.addEventListener('input', updateUSDEquivalent);
        niCurrencySelect.addEventListener('change', updateUSDEquivalent);

        const recalcEditGeneralUsdEquivalent = async () => {
            if (!editGeneralSize || !editGeneralCurrency || !editGeneralUsdEquivalent) return;
            const size = parseFloat(editGeneralSize.value);
            const currency = (editGeneralCurrency.value || '').trim().toUpperCase();
            if (Number.isNaN(size) || !currency) {
                editGeneralUsdEquivalent.value = '';
                return;
            }
            const rate = await getUSDConversionRate(currency);
            editGeneralUsdEquivalent.value = rate !== null ? (size * rate).toFixed(2) : 'N/A';
        };

        const recalcEditNewIssueUsdEquivalent = async () => {
            if (!editNewIssueOrderSize || !editNewIssueCurrency || !editNewIssueUsdEquivalent) return;
            const orderSize = parseFloat(editNewIssueOrderSize.value);
            const currency = (editNewIssueCurrency.value || '').trim().toUpperCase();
            if (Number.isNaN(orderSize) || !currency) {
                editNewIssueUsdEquivalent.value = '';
                return;
            }
            const rate = await getUSDConversionRate(currency);
            editNewIssueUsdEquivalent.value = rate !== null ? (orderSize * rate).toFixed(2) : 'N/A';
        };

        if (editGeneralSize) editGeneralSize.addEventListener('input', recalcEditGeneralUsdEquivalent);
        if (editGeneralCurrency) editGeneralCurrency.addEventListener('change', recalcEditGeneralUsdEquivalent);
        if (editNewIssueOrderSize) editNewIssueOrderSize.addEventListener('input', recalcEditNewIssueUsdEquivalent);
        if (editNewIssueCurrency) editNewIssueCurrency.addEventListener('change', recalcEditNewIssueUsdEquivalent);

const resetFormState = () => {
    activityForm.reset();
    usdEquivalentInput.value = '';
    niUsdEquivalentInput.value = '';
    tabButtons.forEach(b => b.classList.remove('active'));
    activityTypeInput.value = '';
    showFormFields('');
    updateSubmitButtonState();

    // ✅ Reset client dropdown & autofill fields
    clientNameSelect.value = "";
    clientNameSelect.selectedIndex = 0;
    clientTypeInput.value = '';
    clientRegionInput.value = '';

    // Keep dropdown enabled if clients exist
    if (clientNameSelect.options.length > 1) {
        clientNameSelect.disabled = false;
    } else {
        clientNameSelect.disabled = true;
    }
};


activityForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const activityType = activityTypeInput.value.trim().toUpperCase();
    if (!activityType) { showMessage(errorMessage, 'Please choose an activity type.'); return; }
    if (!isAuthReady || !userId || !appId) { showMessage(errorMessage, 'App not ready. Please wait a moment.'); return; }

    const clientName = (clientNameSelect.value || '').trim().toUpperCase();
    const securities = securitiesInput.value.trim().toUpperCase();
    const clientType = clientTypeInput.value.trim().toUpperCase();
    const clientRegion = clientRegionInput.value.trim().toUpperCase();

    if (!clientName || !securities) { showMessage(errorMessage, 'Client Name and Securities are required.'); return; }

    let docData = { clientName, clientType, clientRegion, securities, timestamp: serverTimestamp() };
    let collectionPath = '';

 if (activityType === 'NEW ISSUES') {
    const ioi = ioiInput.value.trim().toUpperCase();
    const orderSize = parseFloat(orderSizeInput.value);
    const realInterest = parseFloat(realInterestInput.value);
    const currency = niCurrencySelect.value.trim().toUpperCase();
    const usdEquivalent = niUsdEquivalentInput.value.trim();
    const size = parseFloat(sizeInput.value);

    if (!ioi || isNaN(orderSize) || isNaN(realInterest) || !currency || isNaN(size)) {
        showMessage(errorMessage, 'IOI, Size, Order Size, Real Interest, and Currency are required for New Issues.');
        return;
    }

    docData = {
        ...docData,
        ioi,
        size,
        orderSize,
        realInterest,
        currency,
        usdEquivalent,
        remarks: document.getElementById('remarks').value
    };
    collectionPath = `artifacts/${appId}/users/${userId}/new_issues`;
}
 else {
        const size = parseFloat(sizeInput.value);
        const priceTarget = document.getElementById('priceTarget').value.trim();
        const currency = currencySelect.value.trim().toUpperCase();
        const usdEquivalent = usdEquivalentInput.value.trim();
        if (isNaN(size) || !priceTarget || !currency) { showMessage(errorMessage, 'Size, Price Target, and Currency are required.'); return; }

        docData = { 
            ...docData,
            type: activityType,
            buySell: document.getElementById('buySell').value.toUpperCase(),
            size,
            priceTarget,
            currency,
            usdEquivalent
        };

        if (activityType === 'MISSED TRADES') {
            const cptyTradedAway = document.getElementById('cptyTradedAway').value.trim().toUpperCase();
            if (!cptyTradedAway) { showMessage(errorMessage, 'CPTY Traded Away is required for Missed Trades.'); return; }
            docData.tradedAwayLevel = priceTarget;
            docData.cptyTradedAway = cptyTradedAway;
            delete docData.priceTarget;
        }
        collectionPath = `artifacts/${appId}/users/${userId}/general_activities`;
    }

    try {
        await addDoc(collection(db, collectionPath), docData);
        resetFormState();
        showMessage(successMessage, 'Activity Logged!');
    } catch (error) {
        console.error('Error adding document: ', error);
        showMessage(errorMessage, `Failed to log activity: ${error.message}`);
    }
});



        let docToDelete = null; let collectionToDelete = null;
        const showDeleteModal = (collectionName, docId) => { docToDelete = docId; collectionToDelete = collectionName; deleteModal.style.display = 'flex'; };
        const hideDeleteModal = () => { docToDelete = null; collectionToDelete = null; deleteModal.style.display = 'none'; };
        const handleDelete = async () => {
            if (!appId || !userId) { console.error('App or user not ready.'); showMessage(errorMessage, 'App or user not ready. Please try again.'); return; }
            if (docToDelete && collectionToDelete) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionToDelete}`, docToDelete);
                try { await deleteDoc(docRef); hideDeleteModal(); } catch (error) { console.error('Error removing document:', error); showMessage(errorMessage, 'Failed to delete entry.'); }
            }
        };
        confirmDeleteBtn.addEventListener('click', handleDelete);
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        window.showDeleteModal = showDeleteModal;

        const getTimestampMillis = (timestamp) => {
            if (timestamp && typeof timestamp.toMillis === 'function') return timestamp.toMillis();
            if (typeof timestamp === 'number') return timestamp;
            return null;
        };

        const compareValues = (a, b) => {
            const aVal = a ?? (typeof a === 'number' ? 0 : '');
            const bVal = b ?? (typeof b === 'number' ? 0 : '');
            if (typeof aVal === 'number' && typeof bVal === 'number') return aVal - bVal;
            return aVal.toString().toLowerCase().localeCompare(bVal.toString().toLowerCase(), undefined, { numeric: true, sensitivity: 'base' });
        };

        const generalFilterableColumns = ['timestamp', 'type', 'clientName', 'clientType', 'clientRegion', 'securities', 'buySell', 'size', 'price', 'currency', 'usdEquivalent', 'cpty'];

        const getGeneralFieldValue = (activity, column, { forSort = false } = {}) => {
            switch (column) {
                case 'timestamp': {
                    const millis = getTimestampMillis(activity.timestamp);
                    if (forSort) return millis || 0;
                    return millis ? new Date(millis).toLocaleString() : 'N/A';
                }
                case 'type':
                    return activity.type || (forSort ? '' : 'N/A');
                case 'clientName':
                    return activity.clientName || (forSort ? '' : 'N/A');
                case 'clientType':
                    return activity.clientType || (forSort ? '' : 'N/A');
                case 'clientRegion':
                    return activity.clientRegion || (forSort ? '' : 'N/A');
                case 'securities':
                    return activity.securities || (forSort ? '' : 'N/A');
                case 'buySell':
                    return activity.buySell || (forSort ? '' : 'N/A');
                case 'size': {
                    const size = parseFloat(activity.size);
                    if (forSort) return Number.isNaN(size) ? 0 : size;
                    return activity.size ?? 'N/A';
                }
                case 'price': {
                    const priceValue = activity.type === 'MISSED TRADES' ? activity.tradedAwayLevel : activity.priceTarget;
                    if (forSort) {
                        const numericPrice = parseFloat(priceValue);
                        return Number.isNaN(numericPrice) ? (priceValue || '').toString().toUpperCase() : numericPrice;
                    }
                    return priceValue || 'N/A';
                }
                case 'currency':
                    return activity.currency || (forSort ? '' : 'N/A');
                case 'usdEquivalent': {
                    const usdValue = parseFloat(activity.usdEquivalent);
                    if (forSort) return Number.isNaN(usdValue) ? 0 : usdValue;
                    return activity.usdEquivalent || 'N/A';
                }
                case 'cpty': {
                    const cpty = activity.type === 'MISSED TRADES' ? activity.cptyTradedAway : '';
                    return cpty || (forSort ? '' : 'N/A');
                }
                default:
                    return forSort ? '' : 'N/A';
            }
        };

        const matchesGeneralFilter = (activity) => {
            const query = (generalSortState.filterValue || '').trim().toLowerCase();
            if (!query) return true;
            const columns = generalSortState.filterColumn === 'all' ? generalFilterableColumns : [generalSortState.filterColumn];
            return columns.some((column) => {
                const value = getGeneralFieldValue(activity, column);
                return value !== undefined && value !== null && value.toString().toLowerCase().includes(query);
            });
        };

        const getProcessedGeneralActivities = () => {
            const filtered = generalActivities.filter(matchesGeneralFilter);
            const directionMultiplier = generalSortState.direction === 'asc' ? 1 : -1;
            const sorted = [...filtered].sort((a, b) => {
                const column = generalSortState.column;
                const comparison = compareValues(
                    getGeneralFieldValue(a, column, { forSort: true }),
                    getGeneralFieldValue(b, column, { forSort: true })
                );
                if (comparison !== 0) return comparison * directionMultiplier;
                const fallback = compareValues(
                    getGeneralFieldValue(a, 'timestamp', { forSort: true }),
                    getGeneralFieldValue(b, 'timestamp', { forSort: true })
                );
                return fallback * -1;
            });
            return sorted;
        };

        const refreshGeneralLog = () => {
            if (!generalLogTable) return;
            generalLogTable.innerHTML = '';
            const processed = getProcessedGeneralActivities();

            if (!processed.length) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="13" class="p-4 text-center text-gray-400">No activities match the current filters.</td>';
                generalLogTable.appendChild(emptyRow);
                return;
            }

            processed.forEach((activity) => {
                const row = document.createElement('tr');
                row.className = 'table-row text-sm';
                const priceDisplay = getGeneralFieldValue(activity, 'price');
                const cptyDisplay = getGeneralFieldValue(activity, 'cpty');
                const timestampDisplay = getGeneralFieldValue(activity, 'timestamp');
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${timestampDisplay}</td>
                    <td class="p-3 whitespace-nowrap">${getGeneralFieldValue(activity, 'type')}</td>
                    <td class="p-3 whitespace-nowrap"><span class="tooltip" data-tooltip="${(activity.clientType || 'N/A').toString()}">${activity.clientName || 'N/A'}</span></td>
                    <td class="p-3 whitespace-nowrap">${activity.clientType || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${getGeneralFieldValue(activity, 'clientRegion')}</td>
                    <td class="p-3 whitespace-nowrap">${activity.securities || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.buySell || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.size ?? 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${priceDisplay}</td>
                    <td class="p-3 whitespace-nowrap">${activity.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${cptyDisplay}</td>
                    <td class="p-3 text-right space-x-2">
                        <button class="btn-secondary text-xs px-3 py-1" onclick="window.showEditGeneralModal('${activity.id}')">Modify</button>
                        <button class="btn-danger text-xs px-3 py-1" onclick="showDeleteModal('general_activities','${activity.id}')">Delete</button>
                    </td>
                `;
                generalLogTable.appendChild(row);
            });
        };

        const newIssuesFilterableColumns = ['timestamp', 'clientName', 'clientType', 'clientRegion', 'securities', 'ioi', 'orderSize', 'realInterest', 'priceTarget', 'currency', 'usdEquivalent', 'remarks'];

        const getNewIssueFieldValue = (issue, column, { forSort = false } = {}) => {
            switch (column) {
                case 'timestamp': {
                    const millis = getTimestampMillis(issue.timestamp);
                    if (forSort) return millis || 0;
                    return millis ? new Date(millis).toLocaleString() : 'N/A';
                }
                case 'clientName':
                    return issue.clientName || (forSort ? '' : 'N/A');
                case 'clientType':
                    return issue.clientType || (forSort ? '' : 'N/A');
                case 'clientRegion':
                    return issue.clientRegion || (forSort ? '' : 'N/A');
                case 'securities':
                    return issue.securities || (forSort ? '' : 'N/A');
                case 'ioi':
                    return issue.ioi || (forSort ? '' : 'N/A');
                case 'orderSize': {
                    const orderSize = parseFloat(issue.orderSize);
                    if (forSort) return Number.isNaN(orderSize) ? 0 : orderSize;
                    return issue.orderSize ?? 'N/A';
                }
                case 'realInterest': {
                    const interest = parseFloat(issue.realInterest);
                    if (forSort) return Number.isNaN(interest) ? 0 : interest;
                    return issue.realInterest ?? 'N/A';
                }
                case 'priceTarget': {
                    const price = issue.priceTarget;
                    if (forSort) {
                        const numericPrice = parseFloat(price);
                        return Number.isNaN(numericPrice) ? (price || '').toString().toUpperCase() : numericPrice;
                    }
                    return price || 'N/A';
                }
                case 'currency':
                    return issue.currency || (forSort ? '' : 'N/A');
                case 'usdEquivalent': {
                    const usd = parseFloat(issue.usdEquivalent);
                    if (forSort) return Number.isNaN(usd) ? 0 : usd;
                    return issue.usdEquivalent || 'N/A';
                }
                case 'remarks':
                    return issue.remarks || (forSort ? '' : 'N/A');
                default:
                    return forSort ? '' : 'N/A';
            }
        };

        const matchesNewIssuesFilter = (issue) => {
            const query = (newIssuesSortState.filterValue || '').trim().toLowerCase();
            if (!query) return true;
            const columns = newIssuesSortState.filterColumn === 'all' ? newIssuesFilterableColumns : [newIssuesSortState.filterColumn];
            return columns.some((column) => {
                const value = getNewIssueFieldValue(issue, column);
                return value !== undefined && value !== null && value.toString().toLowerCase().includes(query);
            });
        };

        const getProcessedNewIssueActivities = () => {
            const filtered = newIssueActivities.filter(matchesNewIssuesFilter);
            const directionMultiplier = newIssuesSortState.direction === 'asc' ? 1 : -1;
            const sorted = [...filtered].sort((a, b) => {
                const column = newIssuesSortState.column;
                const comparison = compareValues(
                    getNewIssueFieldValue(a, column, { forSort: true }),
                    getNewIssueFieldValue(b, column, { forSort: true })
                );
                if (comparison !== 0) return comparison * directionMultiplier;
                const fallback = compareValues(
                    getNewIssueFieldValue(a, 'timestamp', { forSort: true }),
                    getNewIssueFieldValue(b, 'timestamp', { forSort: true })
                );
                return fallback * -1;
            });
            return sorted;
        };

        const refreshNewIssuesLog = () => {
            if (!newIssuesLogTable) return;
            newIssuesLogTable.innerHTML = '';
            const processed = getProcessedNewIssueActivities();

            if (!processed.length) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="13" class="p-4 text-center text-gray-400">No new issues match the current filters.</td>';
                newIssuesLogTable.appendChild(emptyRow);
                return;
            }

            processed.forEach((issue) => {
                const row = document.createElement('tr');
                row.className = 'table-row text-sm';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${getNewIssueFieldValue(issue, 'timestamp')}</td>
                    <td class="p-3 whitespace-nowrap"><span class="tooltip" data-tooltip="${(issue.clientType || 'N/A').toString()}">${issue.clientName || 'N/A'}</span></td>
                    <td class="p-3 whitespace-nowrap">${issue.clientType || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${getNewIssueFieldValue(issue, 'clientRegion')}</td>
                    <td class="p-3 whitespace-nowrap">${issue.securities || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.ioi || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.orderSize ?? 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.realInterest ?? 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${getNewIssueFieldValue(issue, 'priceTarget')}</td>
                    <td class="p-3 whitespace-nowrap">${issue.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap max-w-xs overflow-hidden truncate" title="${issue.remarks || ''}">${issue.remarks || 'N/A'}</td>
                    <td class="p-3 text-right space-x-2">
                        <button class="btn-secondary text-xs px-3 py-1" onclick="window.showEditNewIssueModal('${issue.id}')">Modify</button>
                        <button class="btn-danger text-xs px-3 py-1" onclick="showDeleteModal('new_issues','${issue.id}')">Delete</button>
                    </td>
                `;
                newIssuesLogTable.appendChild(row);
            });
        };

        const renderGeneralActivities = (activities) => {
            generalActivities = [...activities];
            refreshGeneralLog();
            updateAccountOverview();
        };

        const renderNewIssues = (issues) => {
            newIssueActivities = [...issues];
            refreshNewIssuesLog();
            updateAccountOverview();
        };

        const resetGeneralControls = () => {
            generalSortState.column = 'timestamp';
            generalSortState.direction = 'desc';
            generalSortState.filterColumn = 'all';
            generalSortState.filterValue = '';
            if (generalSortColumnSelect) generalSortColumnSelect.value = 'timestamp';
            if (generalSortDirectionSelect) generalSortDirectionSelect.value = 'desc';
            if (generalFilterColumnSelect) generalFilterColumnSelect.value = 'all';
            if (generalFilterValueInput) generalFilterValueInput.value = '';
        };

        const resetNewIssuesControls = () => {
            newIssuesSortState.column = 'timestamp';
            newIssuesSortState.direction = 'desc';
            newIssuesSortState.filterColumn = 'all';
            newIssuesSortState.filterValue = '';
            if (newIssuesSortColumnSelect) newIssuesSortColumnSelect.value = 'timestamp';
            if (newIssuesSortDirectionSelect) newIssuesSortDirectionSelect.value = 'desc';
            if (newIssuesFilterColumnSelect) newIssuesFilterColumnSelect.value = 'all';
            if (newIssuesFilterValueInput) newIssuesFilterValueInput.value = '';
        };

        if (generalSortColumnSelect) {
            generalSortColumnSelect.addEventListener('change', (event) => {
                generalSortState.column = event.target.value;
                refreshGeneralLog();
            });
        }

        if (generalSortDirectionSelect) {
            generalSortDirectionSelect.addEventListener('change', (event) => {
                generalSortState.direction = event.target.value;
                refreshGeneralLog();
            });
        }

        if (generalFilterColumnSelect) {
            generalFilterColumnSelect.addEventListener('change', (event) => {
                generalSortState.filterColumn = event.target.value;
                refreshGeneralLog();
            });
        }

        if (generalFilterValueInput) {
            generalFilterValueInput.addEventListener('input', (event) => {
                generalSortState.filterValue = event.target.value;
                refreshGeneralLog();
            });
        }

        if (generalClearFiltersBtn) {
            generalClearFiltersBtn.addEventListener('click', () => {
                resetGeneralControls();
                refreshGeneralLog();
            });
        }

        if (newIssuesSortColumnSelect) {
            newIssuesSortColumnSelect.addEventListener('change', (event) => {
                newIssuesSortState.column = event.target.value;
                refreshNewIssuesLog();
            });
        }

        if (newIssuesSortDirectionSelect) {
            newIssuesSortDirectionSelect.addEventListener('change', (event) => {
                newIssuesSortState.direction = event.target.value;
                refreshNewIssuesLog();
            });
        }

        if (newIssuesFilterColumnSelect) {
            newIssuesFilterColumnSelect.addEventListener('change', (event) => {
                newIssuesSortState.filterColumn = event.target.value;
                refreshNewIssuesLog();
            });
        }

        if (newIssuesFilterValueInput) {
            newIssuesFilterValueInput.addEventListener('input', (event) => {
                newIssuesSortState.filterValue = event.target.value;
                refreshNewIssuesLog();
            });
        }

        if (newIssuesClearFiltersBtn) {
            newIssuesClearFiltersBtn.addEventListener('click', () => {
                resetNewIssuesControls();
                refreshNewIssuesLog();
            });
        }

        const closeEditGeneralModal = () => {
            activeGeneralDocId = null;
            activeGeneralActivityType = '';
            if (editGeneralForm) editGeneralForm.reset();
            if (editGeneralClient) editGeneralClient.textContent = '-';
            if (editGeneralType) editGeneralType.textContent = '-';
            if (editGeneralCptyGroup) editGeneralCptyGroup.classList.add('hidden');
            if (editGeneralBuySellGroup) editGeneralBuySellGroup.classList.remove('hidden');
            closeModal(editGeneralModal);
        };

        const closeEditNewIssueModal = () => {
            activeNewIssueDocId = null;
            if (editNewIssueForm) editNewIssueForm.reset();
            if (editNewIssueClient) editNewIssueClient.textContent = '-';
            if (editNewIssueRegion) editNewIssueRegion.textContent = '-';
            closeModal(editNewIssueModal);
        };

        const openEditGeneralModal = (docId) => {
            const activity = generalActivities.find(item => item.id === docId);
            if (!activity) return;
            activeGeneralDocId = docId;
            activeGeneralActivityType = activity.type || '';
            if (editGeneralClient) editGeneralClient.textContent = activity.clientName || '-';
            if (editGeneralType) editGeneralType.textContent = activity.type || 'N/A';
            if (editGeneralSize) editGeneralSize.value = activity.size ?? '';
            if (editGeneralCurrency) editGeneralCurrency.value = (activity.currency || 'USD').toUpperCase();
            const priceValue = activity.type === 'MISSED TRADES' ? (activity.tradedAwayLevel || '') : (activity.priceTarget || '');
            if (editGeneralPrice) editGeneralPrice.value = priceValue;
            if (editGeneralUsdEquivalent) editGeneralUsdEquivalent.value = activity.usdEquivalent || '';

            if (activity.type === 'MISSED TRADES') {
                if (editGeneralPriceLabel) editGeneralPriceLabel.textContent = 'Traded Away Level';
                if (editGeneralCptyGroup) {
                    editGeneralCptyGroup.classList.remove('hidden');
                    if (editGeneralCpty) editGeneralCpty.value = activity.cptyTradedAway || '';
                }
                if (editGeneralBuySellGroup) editGeneralBuySellGroup.classList.add('hidden');
            } else {
                if (editGeneralPriceLabel) editGeneralPriceLabel.textContent = 'Price Target';
                if (editGeneralCptyGroup) editGeneralCptyGroup.classList.add('hidden');
                if (editGeneralCpty) editGeneralCpty.value = '';
                if (editGeneralBuySellGroup) editGeneralBuySellGroup.classList.remove('hidden');
                if (editGeneralBuySell) editGeneralBuySell.value = (activity.buySell || 'BUY').toUpperCase();
            }

            openModal(editGeneralModal);
            recalcEditGeneralUsdEquivalent();
        };

        const openEditNewIssueModal = (docId) => {
            const issue = newIssueActivities.find(item => item.id === docId);
            if (!issue) return;
            activeNewIssueDocId = docId;
            if (editNewIssueClient) editNewIssueClient.textContent = issue.clientName || '-';
            if (editNewIssueRegion) editNewIssueRegion.textContent = issue.clientRegion || 'N/A';
            if (editNewIssueIoi) editNewIssueIoi.value = issue.ioi || '';
            if (editNewIssueSize) editNewIssueSize.value = issue.size ?? '';
            if (editNewIssueOrderSize) editNewIssueOrderSize.value = issue.orderSize ?? '';
            if (editNewIssueRealInterest) editNewIssueRealInterest.value = issue.realInterest ?? '';
            if (editNewIssueCurrency) editNewIssueCurrency.value = (issue.currency || 'USD').toUpperCase();
            if (editNewIssueUsdEquivalent) editNewIssueUsdEquivalent.value = issue.usdEquivalent || '';
            if (editNewIssueRemarks) editNewIssueRemarks.value = issue.remarks || '';
            if (editNewIssuePriceTarget) editNewIssuePriceTarget.value = issue.priceTarget || '';

            openModal(editNewIssueModal);
            recalcEditNewIssueUsdEquivalent();
        };

        window.showEditGeneralModal = openEditGeneralModal;
        window.showEditNewIssueModal = openEditNewIssueModal;

        if (closeEditGeneralModalBtn) closeEditGeneralModalBtn.addEventListener('click', closeEditGeneralModal);
        if (cancelEditGeneralBtn) cancelEditGeneralBtn.addEventListener('click', (event) => { event.preventDefault(); closeEditGeneralModal(); });
        if (editGeneralModal) {
            editGeneralModal.addEventListener('click', (event) => {
                if (event.target === editGeneralModal) closeEditGeneralModal();
            });
        }

        if (closeEditNewIssueModalBtn) closeEditNewIssueModalBtn.addEventListener('click', closeEditNewIssueModal);
        if (cancelEditNewIssueBtn) cancelEditNewIssueBtn.addEventListener('click', (event) => { event.preventDefault(); closeEditNewIssueModal(); });
        if (editNewIssueModal) {
            editNewIssueModal.addEventListener('click', (event) => {
                if (event.target === editNewIssueModal) closeEditNewIssueModal();
            });
        }

        if (editGeneralForm) {
            editGeneralForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth || !auth.currentUser || !appId || !userId || !activeGeneralDocId) {
                    showMessage(errorMessage, 'Unable to update this activity right now.');
                    return;
                }

                const size = parseFloat(editGeneralSize.value);
                const currency = (editGeneralCurrency.value || '').trim().toUpperCase();
                let priceValue = (editGeneralPrice.value || '').trim().toUpperCase();
                if (Number.isNaN(size)) { showMessage(errorMessage, 'Please provide a valid size.'); return; }
                if (!currency) { showMessage(errorMessage, 'Currency is required.'); return; }
                if (!priceValue) { showMessage(errorMessage, 'Price information is required.'); return; }

                const updates = {
                    size,
                    currency,
                    usdEquivalent: (editGeneralUsdEquivalent.value || '').trim(),
                    lastModifiedAt: serverTimestamp()
                };

                if (activeGeneralActivityType === 'MISSED TRADES') {
                    const cpty = (editGeneralCpty.value || '').trim().toUpperCase();
                    if (!cpty) { showMessage(errorMessage, 'CPTY Traded Away is required.'); return; }
                    updates.tradedAwayLevel = priceValue;
                    updates.cptyTradedAway = cpty;
                } else {
                    updates.priceTarget = priceValue;
                    updates.buySell = (editGeneralBuySell.value || 'BUY').toUpperCase();
                }

                const docRef = doc(db, `artifacts/${appId}/users/${userId}/general_activities`, activeGeneralDocId);
                try {
                    await updateDoc(docRef, updates);
                    showMessage(successMessage, 'Activity updated.');
                    closeEditGeneralModal();
                } catch (err) {
                    console.error('Error updating activity', err);
                    showMessage(errorMessage, `Failed to update activity: ${err.message}`);
                }
            });
        }

        if (editNewIssueForm) {
            editNewIssueForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth || !auth.currentUser || !appId || !userId || !activeNewIssueDocId) {
                    showMessage(errorMessage, 'Unable to update this new issue right now.');
                    return;
                }

                const size = parseFloat(editNewIssueSize.value);
                const orderSize = parseFloat(editNewIssueOrderSize.value);
                const realInterest = parseFloat(editNewIssueRealInterest.value);
                const currency = (editNewIssueCurrency.value || '').trim().toUpperCase();
                const ioiValue = (editNewIssueIoi.value || '').trim().toUpperCase();
                const priceTargetValue = (editNewIssuePriceTarget?.value || '').trim().toUpperCase();
                if (Number.isNaN(size) || Number.isNaN(orderSize) || Number.isNaN(realInterest)) {
                    showMessage(errorMessage, 'Size, Order Size, and Real Interest must be valid numbers.');
                    return;
                }
                if (!ioiValue) { showMessage(errorMessage, 'IOI is required.'); return; }
                if (!currency) { showMessage(errorMessage, 'Currency is required.'); return; }

                const updates = {
                    size,
                    orderSize,
                    realInterest,
                    currency,
                    usdEquivalent: (editNewIssueUsdEquivalent.value || '').trim(),
                    ioi: ioiValue,
                    remarks: (editNewIssueRemarks.value || '').trim(),
                    lastModifiedAt: serverTimestamp()
                };

                if (editNewIssuePriceTarget) updates.priceTarget = priceTargetValue;

                const docRef = doc(db, `artifacts/${appId}/users/${userId}/new_issues`, activeNewIssueDocId);
                try {
                    await updateDoc(docRef, updates);
                    showMessage(successMessage, 'New issue updated.');
                    closeEditNewIssueModal();
                } catch (err) {
                    console.error('Error updating new issue', err);
                    showMessage(errorMessage, `Failed to update new issue: ${err.message}`);
                }
            });
        }

const populateClientDropdown = (clients) => {
    clientNameSelect.innerHTML = '<option value="">(Select client from Client Database)</option>';

    if (!clients || clients.length === 0) {
        clientsListDiv.textContent = "No clients yet. Add one above.";
        clientNameSelect.disabled = true;
        return;
    }

    // Sort alphabetically
    clients.sort((a, b) => (a.clientName || '').localeCompare(b.clientName || ''));

    clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.clientName;
        opt.textContent = c.clientName;
        opt.dataset.type = c.clientType || '';
        opt.dataset.region = c.clientRegion || '';
        clientNameSelect.appendChild(opt);
    });

    clientsListDiv.textContent = `${clients.length} client(s) available.`;
    clientNameSelect.disabled = false;
    clientNameSelect.value = ""; // reset to placeholder
};

        addClientBtn.addEventListener('click', async () => {
            if (!appId || !userId) { console.error('App or user not ready.'); showMessage(errorMessage, 'App or user not ready. Please try again.'); return; }
            const name = (clientNameInputForDb.value || '').trim().toUpperCase();
            const type = (newClientTypeSelect.value || '').trim().toUpperCase();
            const region = (newClientRegionInput.value || '').trim().toUpperCase();

            if (!name) { showMessage(errorMessage, 'Please enter a client name.'); return; }
            if (!type) { showMessage(errorMessage, 'Please select a client type.'); return; }
            if (!region) { showMessage(errorMessage, 'Please enter a region.'); return; }

            try {
                const clientsCollection = collection(db, `artifacts/${appId}/clients`);
                await addDoc(clientsCollection, { clientName: name, clientType: type, clientRegion: region, createdAt: serverTimestamp() });
                clientNameInputForDb.value = '';
                newClientRegionInput.value = '';
                showMessage(successMessage, 'Client added.');
            } catch (err) {
                console.error('Add client error', err);
                showMessage(errorMessage, `Failed to add client: ${err.message}`);
            }
        });

        clientNameSelect.addEventListener('change', (e)=>{
            const selected = e.target.selectedOptions[0];
            const type = selected?.dataset?.type || '';
            const region = selected?.dataset?.region || '';
            clientTypeInput.value = type;
            clientRegionInput.value = region;
        });

const initApp = async () => {

            const firebaseConfig = {

  apiKey: "AIzaSyBkQnlYdOsIki_VuEpMBsIFACLN-u2FYFo",
  authDomain: "bond-sales-tracker.firebaseapp.com",
  projectId: "bond-sales-tracker",
  storageBucket: "bond-sales-tracker.firebasestorage.app",
  messagingSenderId: "293591418173",
  appId: "1:293591418173:web:b0ca2b77f514dc6c9b3154",



            };



try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    appId = firebaseConfig.projectId;
} catch (e) {
    console.error('Firebase init failed', e);
    showMessage(errorMessage, 'Firebase initialization failed. Check your config.');
    return;
}

resetAppState();
resetGeneralControls();
resetNewIssuesControls();
refreshGeneralLog();
refreshNewIssuesLog();
appContent.classList.add('hidden');
authOverlay.classList.remove('hidden');

            onAuthStateChanged(auth, (user) => {
                clearRealtimeListeners();
                if (user) {
                    userId = user.uid;
                    if (userEmailSpan) userEmailSpan.textContent = user.email || user.uid;
                    if (accountEmailDisplay) accountEmailDisplay.textContent = user.email || user.uid;
                    if (accountBtn) accountBtn.disabled = false;
                    isAuthReady = true;
                    appContent.classList.remove('hidden');
                    authOverlay.classList.add('hidden');
                    switchAuthView('login');
                    setAuthMessage('');
                    if (loginForm) loginForm.reset();
                    if (registerForm) registerForm.reset();
                    if (forgotPasswordForm) forgotPasswordForm.reset();
                    setupRealtimeListeners();
                    updateSubmitButtonState();
                } else {
                    userId = null;
                    isAuthReady = false;
                    if (userEmailSpan) userEmailSpan.textContent = 'Guest';
                    if (accountBtn) accountBtn.disabled = true;
                    if (accountEmailDisplay) accountEmailDisplay.textContent = '-';
                    resetAppState();
                    resetGeneralControls();
                    resetNewIssuesControls();
                    refreshGeneralLog();
                    refreshNewIssuesLog();
                    appContent.classList.add('hidden');
                    authOverlay.classList.remove('hidden');
                    switchAuthView('login');
                    setAuthMessage('');
                    updateSubmitButtonState();
                }
            });
        };
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
