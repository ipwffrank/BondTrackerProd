<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BondTracker Enterprise</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%236366f1'/><text x='16' y='22' text-anchor='middle' font-family='sans-serif' font-weight='700' font-size='18' fill='white'>B</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.1/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { box-sizing: border-box; }

        /* ============ THEME VARIABLES ============ */
        :root[data-theme="dark"] {
            --bg-base: #0f172a;
            --bg-surface: #1e293b;
            --bg-raised: #1e293b;
            --bg-input: #1e293b;
            --bg-input-focus: #0f172a;
            --border: #334155;
            --border-focus: #6366f1;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-glow: rgba(99,102,241,0.15);
            --accent-glow-strong: rgba(99,102,241,0.3);
            --card-bg: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --nav-bg: rgba(15,23,42,0.85);
            --nav-border: #334155;
            --tab-active-color: #6366f1;
            --section-label-bg: rgba(99,102,241,0.08);
            --section-label-border: rgba(99,102,241,0.2);
            --autofill-bg: rgba(99,102,241,0.06);
            --autofill-border: rgba(99,102,241,0.25);
            --autofill-text: #a5b4fc;
            --table-odd: rgba(30,41,59,0.5);
            --table-even: rgba(15,23,42,0.5);
            --table-hover: rgba(99,102,241,0.08);
            --table-header-bg: #1e293b;
            --badge-primary-bg: rgba(99,102,241,0.15); --badge-primary-text: #a5b4fc;
            --badge-success-bg: rgba(34,197,94,0.15); --badge-success-text: #86efac;
            --badge-warning-bg: rgba(251,146,60,0.15); --badge-warning-text: #fdba74;
            --badge-danger-bg: rgba(239,68,68,0.15); --badge-danger-text: #fca5a5;
            --btn-muted-bg: #334155; --btn-muted-text: #e2e8f0; --btn-muted-hover: #475569;
            --btn-secondary-bg: #1e40af; --btn-secondary-hover: #1e3a8a;
            --modal-bg: linear-gradient(135deg,#1e293b 0%,#0f172a 100%);
            --auth-bg: radial-gradient(circle at top right,rgba(99,102,241,0.2),transparent 50%),radial-gradient(circle at bottom left,rgba(79,70,229,0.15),transparent 50%),linear-gradient(135deg,#0f172a 0%,#1e293b 100%);
            --auth-card-bg: linear-gradient(135deg,#1e293b 0%,#0f172a 100%);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --toggle-bg: #334155;
            --toggle-knob: #6366f1;
            --logo-color: #6366f1;
        }
        :root[data-theme="light"] {
            --bg-base: #f3f5f7;
            --bg-surface: #ffffff;
            --bg-raised: #ffffff;
            --bg-input: #ffffff;
            --bg-input-focus: #ffffff;
            --border: #d1d5db;
            --border-focus: #0066cc;
            --text-primary: #1a1a2e;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --accent-glow: rgba(0,102,204,0.1);
            --accent-glow-strong: rgba(0,102,204,0.25);
            --card-bg: #ffffff;
            --nav-bg: rgba(255,255,255,0.92);
            --nav-border: #e5e7eb;
            --tab-active-color: #0066cc;
            --section-label-bg: rgba(0,102,204,0.06);
            --section-label-border: rgba(0,102,204,0.2);
            --autofill-bg: #eef2f7;
            --autofill-border: #c5d5e8;
            --autofill-text: #0066cc;
            --table-odd: #ffffff;
            --table-even: #f9fafb;
            --table-hover: rgba(0,102,204,0.04);
            --table-header-bg: #f3f4f6;
            --badge-primary-bg: rgba(0,102,204,0.1); --badge-primary-text: #0066cc;
            --badge-success-bg: rgba(16,185,129,0.1); --badge-success-text: #059669;
            --badge-warning-bg: rgba(217,119,7,0.1); --badge-warning-text: #d97706;
            --badge-danger-bg: rgba(220,38,38,0.1); --badge-danger-text: #dc2626;
            --btn-muted-bg: #f3f4f6; --btn-muted-text: #374151; --btn-muted-hover: #e5e7eb;
            --btn-secondary-bg: #0052a3; --btn-secondary-hover: #003d7a;
            --modal-bg: #ffffff;
            --auth-bg: linear-gradient(135deg,#eef2f7 0%,#dbeafe 100%);
            --auth-card-bg: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --toggle-bg: #d1d5db;
            --toggle-knob: #0066cc;
            --logo-color: #0066cc;
        }

        /* ============ BASE ============ */
        body { font-family:'Inter',sans-serif; background:var(--bg-base); color:var(--text-primary); min-height:100vh; transition:background 0.3s, color 0.3s; }
        .hidden { display:none !important; }

        /* ============ FORMS ============ */
        .form-input, .form-select, .form-textarea {
            width:100%; padding:10px 14px; background:var(--bg-input); border:1.5px solid var(--border);
            border-radius:8px; color:var(--text-primary); font-size:14px; transition:all 0.2s ease; font-family:inherit;
        }
        .form-input:focus,.form-select:focus,.form-textarea:focus { outline:none; border-color:var(--border-focus); background:var(--bg-input-focus); box-shadow:0 0 0 3px var(--accent-glow); }
        .form-input:disabled,.form-select:disabled,.form-textarea:disabled { opacity:0.5; cursor:not-allowed; }
        .form-select { appearance:auto; }
        .form-label { display:block; font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:5px; }
        .form-hint { font-size:11.5px; color:var(--text-muted); margin-top:4px; }

        /* Autofill styling */
        .input-autofill { background:var(--autofill-bg) !important; border-color:var(--autofill-border) !important; color:var(--autofill-text) !important; cursor:default; }

        /* ============ BUTTONS ============ */
        .btn { padding:10px 18px; border-radius:8px; font-weight:600; font-size:13.5px; transition:all 0.2s ease; cursor:pointer; border:none; display:inline-flex; align-items:center; gap:7px; font-family:inherit; white-space:nowrap; }
        .btn-primary { background:linear-gradient(135deg,var(--accent),var(--accent-hover)); color:#fff; box-shadow:0 2px 8px var(--accent-glow-strong); }
        .btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 12px var(--accent-glow-strong); }
        .btn-primary:disabled { background:var(--btn-muted-bg); color:var(--text-muted); box-shadow:none; transform:none; cursor:not-allowed; }
        .btn-secondary { background:var(--btn-secondary-bg); color:#fff; }
        .btn-secondary:hover { background:var(--btn-secondary-hover); }
        .btn-secondary:disabled { opacity:0.45; cursor:not-allowed; }
        .btn-muted { background:var(--btn-muted-bg); color:var(--btn-muted-text); }
        .btn-muted:hover { background:var(--btn-muted-hover); }
        .btn-danger { background:#dc2626; color:#fff; }
        .btn-danger:hover { background:#b91c1c; }
        .btn-export { background:var(--btn-muted-bg); color:var(--btn-muted-text); border:1.5px solid var(--border); padding:8px 14px; font-size:13px; }
        .btn-export:hover { border-color:var(--accent); color:var(--accent); }

        /* ============ LAYOUT: TWO-PANEL FORM ============ */
        .form-panel { display:grid; grid-template-columns:1fr 1fr; gap:0; }
        .panel-left { padding:24px 20px 24px 24px; border-right:1px solid var(--border); }
        .panel-right { padding:24px 24px 24px 20px; background:var(--section-label-bg); border-radius:0 12px 12px 0; }
        .panel-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:6px; }
        .panel-label svg { width:13px; height:13px; opacity:0.7; }
        .field-group { margin-bottom:16px; }
        .field-group:last-child { margin-bottom:0; }
        @media(max-width:768px) { .form-panel { grid-template-columns:1fr; } .panel-left { border-right:none; border-bottom:1px solid var(--border); border-radius:12px 12px 0 0; padding:20px; } .panel-right { border-radius:0 0 12px 12px; padding:20px; } }

        /* ============ CARDS ============ */
        .card { background:var(--card-bg); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); transition:background 0.3s; }
        .card-header { font-size:17px; font-weight:700; color:var(--text-primary); margin-bottom:20px; padding-bottom:12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }

        /* ============ TABS ============ */
        .tab-bar { background:var(--bg-surface); border:1px solid var(--border); border-bottom:none; border-radius:12px 12px 0 0; display:flex; overflow-x:auto; transition:background 0.3s; }
        .tab-btn { padding:12px 22px; background:transparent; border:none; color:var(--text-muted); font-weight:500; font-size:13.5px; cursor:pointer; transition:all 0.2s; border-bottom:2.5px solid transparent; font-family:inherit; white-space:nowrap; }
        .tab-btn:hover { color:var(--text-secondary); background:var(--accent-glow); }
        .tab-btn.active { color:var(--tab-active-color); border-bottom-color:var(--tab-active-color); font-weight:600; }

        /* ============ TABLES ============ */
        .table-wrap { overflow-x:auto; border-radius:8px; border:1px solid var(--border); }
        table { width:100%; border-collapse:collapse; }
        .th { background:var(--table-header-bg); color:var(--text-muted); font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:0.05em; padding:10px 14px; text-align:left; white-space:nowrap; position:sticky; top:0; z-index:2; }
        .td { padding:10px 14px; font-size:13.5px; color:var(--text-secondary); border-bottom:1px solid var(--border); white-space:nowrap; }
        .tr:nth-child(odd) .td { background:var(--table-odd); }
        .tr:nth-child(even) .td { background:var(--table-even); }
        .tr:hover .td { background:var(--table-hover) !important; }

        /* ============ BADGES ============ */
        .badge { display:inline-block; padding:3px 9px; border-radius:5px; font-size:11.5px; font-weight:600; letter-spacing:0.02em; }
        .badge-primary { background:var(--badge-primary-bg); color:var(--badge-primary-text); }
        .badge-success { background:var(--badge-success-bg); color:var(--badge-success-text); }
        .badge-warning { background:var(--badge-warning-bg); color:var(--badge-warning-text); }
        .badge-danger { background:var(--badge-danger-bg); color:var(--badge-danger-text); }

        /* ============ MODALS ============ */
        .modal { display:none; position:fixed; inset:0; z-index:100; background:rgba(0,0,0,0.6); backdrop-filter:blur(6px); justify-content:center; align-items:center; }
        .modal-content { background:var(--modal-bg); padding:32px; border:1px solid var(--border); width:90%; max-width:480px; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.25); animation:slideUp 0.25s ease; }
        @keyframes slideUp { from{transform:translateY(18px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* ============ AUTH ============ */
        .auth-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--auth-bg); z-index:200; padding:24px; }
        .auth-card { position:absolute; background:var(--auth-card-bg); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.15); padding:40px 36px; width:100%; max-width:420px; transition:background 0.3s; }

        /* ============ NOTIFICATIONS ============ */
        .notif { position:fixed; top:24px; right:24px; padding:14px 20px; border-radius:10px; z-index:150; font-size:13.5px; font-weight:500; display:flex; align-items:center; gap:10px; min-width:280px; animation:slideIn 0.25s ease; box-shadow:0 8px 20px rgba(0,0,0,0.2); }
        @keyframes slideIn { from{transform:translateX(320px);opacity:0} to{transform:translateX(0);opacity:1} }
        .notif-success { background:#16a34a; color:#fff; }
        .notif-error { background:#dc2626; color:#fff; }

        /* ============ LOADING ============ */
        .loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:140; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; }
        .spinner { width:40px; height:40px; border:3px solid var(--accent-glow-strong); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* ============ NAV ============ */
        .nav { background:var(--nav-bg); border-bottom:1px solid var(--nav-border); position:sticky; top:0; z-index:40; backdrop-filter:blur(12px); transition:background 0.3s, border-color 0.3s; }

        /* ============ THEME TOGGLE ============ */
        .theme-toggle { display:flex; align-items:center; gap:8px; }
        .toggle-track { width:44px; height:24px; background:var(--toggle-bg); border-radius:12px; position:relative; cursor:pointer; transition:background 0.3s; }
        .toggle-knob { width:18px; height:18px; background:var(--toggle-knob); border-radius:50%; position:absolute; top:3px; left:3px; transition:all 0.3s; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
        [data-theme="light"] .toggle-knob { left:23px; }
        .toggle-icon { font-size:14px; color:var(--text-muted); }

        /* ============ ISIN/TICKER LINK ============ */
        .linked-pair { display:flex; align-items:center; gap:8px; }
        .linked-pair .form-input { flex:1; min-width:0; }
        .link-swap-btn { background:var(--btn-muted-bg); border:1.5px solid var(--border); color:var(--text-muted); width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; flex-shrink:0; }
        .link-swap-btn:hover { border-color:var(--accent); color:var(--accent); }

        /* ============ EXCHANGE RATE BOX ============ */
        .rate-box { padding:14px 18px; background:var(--section-label-bg); border:1px solid var(--section-label-border); border-radius:10px; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
        .rate-box-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); margin-bottom:4px; }
        .rate-box-value { font-size:22px; font-weight:700; color:var(--text-primary); }
        .rate-box-sub { font-size:12px; color:var(--text-muted); margin-top:2px; }
        .rate-box-footer { font-size:11px; color:var(--text-muted); grid-column:1/-1; padding-top:8px; border-top:1px solid var(--border); }

        /* ============ AI TAB ============ */
        .ai-badge { background:linear-gradient(135deg,#8b5cf6,#6366f1); color:#fff; padding:3px 7px; border-radius:4px; font-size:10.5px; font-weight:700; letter-spacing:0.05em; text-transform:uppercase; }
        .transcript-preview { background:var(--bg-base); border:1px solid var(--border); border-radius:8px; padding:14px; font-family:'Courier New',monospace; font-size:12.5px; color:var(--text-muted); }

        /* ============ STAT CARDS ============ */
        .stat-card { background:var(--section-label-bg); border:1px solid var(--section-label-border); border-radius:10px; padding:16px; }
        .stat-label { font-size:11px; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-weight:600; }
        .stat-value { font-size:24px; font-weight:700; color:var(--text-primary); margin-top:6px; }

        /* ============ EXPORT DROPDOWN ============ */
        .export-wrap { position:relative; display:inline-block; }
        .export-dropdown { display:none; position:absolute; top:calc(100% + 6px); right:0; background:var(--bg-raised); border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow); min-width:150px; z-index:20; overflow:hidden; }
        .export-dropdown.open { display:block; }
        .export-item { display:block; width:100%; padding:9px 16px; text-align:left; background:none; border:none; color:var(--text-secondary); font-size:13px; font-family:inherit; cursor:pointer; transition:background 0.15s; white-space:nowrap; }
        .export-item:hover { background:var(--accent-glow); color:var(--accent); }

        /* ============ CLIENT LIST TABLE ============ */
        .client-table-wrap { margin-top:24px; }
    </style>
</head>
<body>

<!-- AUTH OVERLAY -->
<div id="authOverlay" class="auth-overlay hidden">

    <!-- ‚ë† SIGN IN (default visible panel) -->
    <div id="authPanelLogin" class="auth-card">
        <div style="text-align:center;margin-bottom:32px">
            <h1 style="font-size:26px;font-weight:700;color:var(--logo-color);margin-bottom:6px">BondTracker Enterprise</h1>
            <p style="font-size:13px;color:var(--text-muted)">Professional Sales Activity Management</p>
        </div>
        <div id="authMessage" class="hidden" style="font-size:13px;text-align:center;padding:10px 14px;border-radius:8px;margin-bottom:16px"></div>
        <form id="loginForm" style="display:flex;flex-direction:column;gap:16px">
            <div>
                <label class="form-label">Email Address</label>
                <input id="loginEmail" type="email" class="form-input" required autocomplete="email" placeholder="you@company.com">
            </div>
            <div>
                <label class="form-label">Password</label>
                <input id="loginPassword" type="password" class="form-input" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px">Sign In</button>
        </form>
        <!-- two small links below -->
        <div style="display:flex;justify-content:space-between;margin-top:20px;padding-top:18px;border-top:1px solid var(--border)">
            <button type="button" id="goToRegister" style="background:none;border:none;color:var(--accent);font-size:13px;font-weight:600;cursor:pointer;padding:0;font-family:inherit">+ Create account</button>
            <button type="button" id="goToForgot" style="background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;padding:0;font-family:inherit;transition:color .2s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">Forgot password?</button>
        </div>
    </div>

    <!-- ‚ë° CREATE ACCOUNT (hidden by default) -->
    <div id="authPanelRegister" class="auth-card hidden">
        <!-- back arrow row -->
        <button type="button" id="backFromRegister" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;padding:0;margin-bottom:24px;font-family:inherit;transition:color .2s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Back to Sign In
        </button>
        <h2 style="font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:6px">Create Account</h2>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:22px">Set up your email and password to get started.</p>
        <div id="registerMessage" class="hidden" style="font-size:13px;text-align:center;padding:10px 14px;border-radius:8px;margin-bottom:14px"></div>
        <form id="registerForm" style="display:flex;flex-direction:column;gap:16px">
            <div>
                <label class="form-label">Email Address</label>
                <input id="registerEmail" type="email" class="form-input" required autocomplete="email" placeholder="you@company.com">
            </div>
            <div>
                <label class="form-label">Password</label>
                <input id="registerPassword" type="password" class="form-input" required minlength="6" autocomplete="new-password" placeholder="At least 6 characters">
                <!-- strength bar -->
                <div style="margin-top:6px;display:flex;gap:4px;height:3px">
                    <div id="strBar1" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                    <div id="strBar2" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                    <div id="strBar3" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                    <div id="strBar4" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                </div>
                <p id="strLabel" class="form-hint" style="margin-top:4px"></p>
            </div>
            <div>
                <label class="form-label">Re-enter Password</label>
                <input id="registerPasswordConfirm" type="password" class="form-input" required minlength="6" autocomplete="new-password" placeholder="Same password again">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px">Create Account</button>
        </form>
    </div>

    <!-- ‚ë¢ FORGOT PASSWORD (hidden by default) -->
    <div id="authPanelForgot" class="auth-card hidden">
        <button type="button" id="backFromForgot" style="display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--text-muted);font-size:13px;cursor:pointer;padding:0;margin-bottom:24px;font-family:inherit;transition:color .2s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Back to Sign In
        </button>
        <h2 style="font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:6px">Forgot Password</h2>
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:22px">Enter your email address and we'll send you a link to reset your password.</p>
        <div id="forgotMessage" class="hidden" style="font-size:13px;text-align:center;padding:10px 14px;border-radius:8px;margin-bottom:14px"></div>
        <form id="forgotPasswordForm" style="display:flex;flex-direction:column;gap:16px">
            <div>
                <label class="form-label">Email Address</label>
                <input id="forgotPasswordEmail" type="email" class="form-input" required placeholder="you@company.com">
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px">Send Reset Link</button>
        </form>
        <!-- success state (shown after email is sent) -->
        <div id="forgotSuccessState" class="hidden" style="text-align:center;margin-top:8px">
            <div style="width:52px;height:52px;background:var(--badge-success-bg);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
                <svg width="26" height="26" fill="none" stroke="var(--badge-success-text)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
            </div>
            <h3 style="font-size:17px;font-weight:700;color:var(--text-primary);margin-bottom:8px">Check your inbox</h3>
            <p style="font-size:13px;color:var(--text-muted);line-height:1.55">We've sent a reset link to <strong id="forgotEmailDisplay" style="color:var(--text-secondary)"></strong>. Click the link in that email ‚Äî it will open a page where you can set a new password and confirm it.</p>
            <button type="button" id="backFromForgotSuccess" class="btn btn-muted" style="width:100%;justify-content:center;margin-top:22px">Back to Sign In</button>
        </div>
    </div>

    <!-- ‚ë£ RESET PASSWORD (shown when redirected back from Firebase email link) -->
    <div id="authPanelReset" class="auth-card hidden">
        <!-- Form state -->
        <div id="resetFormState">
            <h2 style="font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:6px">Set new password</h2>
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:22px">Choose a new password for your account.</p>
            <div id="resetMessage" class="hidden" style="font-size:13px;text-align:center;padding:10px 14px;border-radius:8px;margin-bottom:14px"></div>
            <div style="display:flex;flex-direction:column;gap:16px">
                <div>
                    <label class="form-label">New Password</label>
                    <input id="resetPassword" type="password" class="form-input" required minlength="6" autocomplete="new-password" placeholder="At least 6 characters">
                    <div style="margin-top:6px;display:flex;gap:4px;height:3px">
                        <div id="resetStrBar1" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                        <div id="resetStrBar2" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                        <div id="resetStrBar3" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                        <div id="resetStrBar4" style="flex:1;border-radius:2px;background:var(--border);transition:background .25s"></div>
                    </div>
                    <p id="resetStrLabel" class="form-hint" style="margin-top:4px"></p>
                </div>
                <div>
                    <label class="form-label">Confirm Password</label>
                    <input id="resetPasswordConfirm" type="password" class="form-input" required minlength="6" autocomplete="new-password" placeholder="Same password again">
                </div>
                <button id="resetSubmitBtn" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px">Update Password</button>
            </div>
        </div>
        <!-- Success state -->
        <div id="resetSuccessState" class="hidden" style="text-align:center">
            <div style="width:52px;height:52px;background:var(--badge-success-bg);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
                <svg width="26" height="26" fill="none" stroke="var(--badge-success-text)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
            </div>
            <h3 style="font-size:17px;font-weight:700;color:var(--text-primary);margin-bottom:8px">Password updated</h3>
            <p style="font-size:13px;color:var(--text-muted);line-height:1.55">Your password has been changed successfully. You can now sign in with your new password.</p>
            <button id="resetDoneBtn" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:22px">Back to Sign In</button>
        </div>
    </div>
</div>

<!-- APP -->
<div id="appContent" class="hidden">

    <!-- Loading -->
    <div id="loadingIndicator" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div style="color:#fff;font-weight:500;font-size:14px">Fetching data‚Ä¶</div>
    </div>

    <!-- Notifications -->
    <div id="successMessage" class="notif notif-success hidden"><svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg><span>Success</span></div>
    <div id="errorMessage" class="notif notif-error hidden"><svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg><span>Error</span></div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <div style="width:56px;height:56px;background:rgba(220,38,38,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px"><svg width="28" height="28" fill="none" stroke="#dc2626" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></div>
            <h3 style="font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:6px">Confirm Deletion</h3>
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:22px">This action cannot be undone.</p>
            <div style="display:flex;justify-content:center;gap:10px"><button id="confirmDeleteBtn" class="btn btn-danger">Delete</button><button id="cancelDeleteBtn" class="btn btn-muted">Cancel</button></div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content" style="max-width:520px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3 style="font-size:19px;font-weight:700;color:var(--text-primary)">Account Overview</h3><button id="closeAccountModal" style="background:none;border:none;font-size:22px;color:var(--text-muted);cursor:pointer">&times;</button></div>
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:2px">Email</p><p id="accountEmail" style="font-size:15px;font-weight:600;color:var(--text-primary);margin-bottom:18px">-</p>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
                <div class="stat-card"><p class="stat-label">Activities</p><p id="accountLogsCount" class="stat-value">0</p></div>
                <div class="stat-card"><p class="stat-label">Last Update</p><p id="accountLastUpdate" style="font-size:12px;color:var(--text-secondary);margin-top:6px;font-weight:600">N/A</p></div>
                <div class="stat-card"><p class="stat-label">Total Size (MM)</p><p id="accountTotalSize" class="stat-value">0</p></div>
            </div>
            <div style="display:flex;gap:10px"><button id="logoutBtn" class="btn btn-danger" style="flex:1;justify-content:center">Sign Out</button><button id="closeAccountModalBtn" class="btn btn-muted" style="flex:1;justify-content:center">Close</button></div>
        </div>
    </div>

    <!-- Nav -->
    <nav class="nav">
        <div style="max-width:1280px;margin:0 auto;padding:0 20px;height:56px;display:flex;align-items:center;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:10px">
                <h1 style="font-size:20px;font-weight:700;color:var(--logo-color)">BondTracker</h1>
                <span class="ai-badge">AI Ready</span>
            </div>
            <div style="display:flex;align-items:center;gap:16px">
                <div class="theme-toggle">
                    <span class="toggle-icon">‚òÄÔ∏è</span>
                    <div class="toggle-track" id="themeToggle"><div class="toggle-knob"></div></div>
                    <span class="toggle-icon">üåô</span>
                </div>
                <span style="font-size:13px;color:var(--text-muted)" id="userEmail">Guest</span>
                <button id="accountBtn" class="btn btn-muted" disabled style="padding:8px 14px;font-size:13px">Account</button>
            </div>
        </div>
    </nav>

    <!-- Main -->
    <div style="max-width:1280px;margin:0 auto;padding:24px 20px">

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="activity">Activity Logging</button>
            <button class="tab-btn" data-tab="newIssues">New Issues</button>
            <button class="tab-btn" data-tab="clients">Client Database</button>
            <button class="tab-btn" data-tab="ai">AI Assistant <span class="ai-badge" style="margin-left:4px">Beta</span></button>
        </div>

        <!-- Tab content wrapper -->
        <div class="card" style="border-radius:0 0 12px 12px;border-top:none;padding:0">

            <!-- ========== ACTIVITY TAB ========== -->
            <div id="activityTab" class="tab-content" style="padding:28px">
                <div class="card-header">Log Sales Activity</div>

                <form id="activityForm">
                    <div class="form-panel">
                        <!-- LEFT: User inputs -->
                        <div class="panel-left">
                            <div class="panel-label"><svg viewBox="0 0 20 20" fill="currentColor"><path d="M13.707 5.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L6 10.586l6.293-6.293a1 1 0 011.414 0z"/></svg> User Input</div>
                            <div class="field-group"><label class="form-label">Client Name</label><select id="clientNameSelect" class="form-select" required><option value="">Select client‚Ä¶</option></select></div>
                            <div class="field-group"><label class="form-label">Activity Type</label><select id="activityType" class="form-select" required><option value="">Select type‚Ä¶</option><option value="CALL">Phone Call</option><option value="EMAIL">Email</option><option value="MEETING">Meeting</option><option value="BLOOMBERG">Bloomberg Chat</option><option value="OTHER">Other</option></select></div>

                            <div class="field-group">
                                <label class="form-label">ISIN / Ticker</label>
                                <div class="linked-pair">
                                    <input id="isinInput" type="text" class="form-input" placeholder="ISIN (e.g. US0378331005)" maxlength="12">
                                    <button type="button" class="link-swap-btn" id="swapISINTickerBtn" title="Swap fields">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                                    </button>
                                    <input id="tickerInput" type="text" class="form-input" placeholder="Ticker (e.g. AAPL)" maxlength="10">
                                </div>
                                <p class="form-hint">Enter either one ‚Äî the other auto-fills via Bloomberg API</p>
                            </div>

                            <div class="field-group"><label class="form-label">Size (MM)</label><input id="sizeInput" type="number" step="0.01" min="0" class="form-input" placeholder="0.00" required></div>
                            <div class="field-group">
                                <label class="form-label">Currency</label>
                                <select id="currencySelect" class="form-select" required><option value="">Select‚Ä¶</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="JPY">JPY</option><option value="CNH">CNH</option><option value="AUD">AUD</option><option value="CUSTOM">Other (specify‚Ä¶)</option></select>
                            </div>
                            <div id="customCurrencyDiv" class="field-group hidden"><label class="form-label">Custom Currency Code</label><input id="customCurrencyInput" type="text" class="form-input" placeholder="e.g. SGD" maxlength="3"><p class="form-hint">3-letter ISO code</p></div>
                            <div class="field-group"><label class="form-label">Price</label><input id="priceInput" type="number" step="0.01" class="form-input" placeholder="100.00"></div>
                            <div class="field-group"><label class="form-label">Direction</label><select id="directionSelect" class="form-select" required><option value="">Select‚Ä¶</option><option value="BUY">Buy</option><option value="SELL">Sell</option><option value="TWO-WAY">Two-Way</option></select></div>
                            <div class="field-group"><label class="form-label">Status</label><select id="statusSelect" class="form-select" required><option value="">Select‚Ä¶</option><option value="ENQUIRY">Enquiry</option><option value="QUOTED">Quoted</option><option value="EXECUTED">Executed</option><option value="PASSED">Passed</option></select></div>
                            <div class="field-group"><label class="form-label">Notes</label><textarea id="notesTextarea" rows="3" class="form-textarea" placeholder="Market color, follow-ups‚Ä¶"></textarea></div>
                        </div>

                        <!-- RIGHT: Auto-filled -->
                        <div class="panel-right">
                            <div class="panel-label"><svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg> Auto-Filled</div>

                            <div class="field-group"><label class="form-label">Bond / Security Name</label><input id="bondName" type="text" class="form-input input-autofill" readonly placeholder="Auto-filled from ISIN/Ticker"></div>
                            <div class="field-group"><label class="form-label">Client Type</label><input id="clientTypeInput" type="text" class="form-input input-autofill" readonly placeholder="From client database"></div>
                            <div class="field-group"><label class="form-label">Region</label><input id="clientRegionInput" type="text" class="form-input input-autofill" readonly placeholder="From client database"></div>
                            <div class="field-group"><label class="form-label">Sales Coverage</label><input id="clientCoverageInput" type="text" class="form-input input-autofill" readonly placeholder="From client database"></div>

                            <!-- Exchange Rate Box -->
                            <div class="field-group">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                    <label class="form-label" style="margin-bottom:0">Exchange Rate (Yahoo Finance)</label>
                                    <button type="button" id="fetchRatesBtn" class="btn btn-secondary" disabled style="padding:7px 12px;font-size:12px">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        Fetch Rate
                                    </button>
                                </div>
                                <div id="ratesDisplay" class="rate-box hidden">
                                    <div><div class="rate-box-label">Rate</div><div class="rate-box-value" id="exchangeRate">1.0000</div><div class="rate-box-sub"><span id="selectedCurrency">USD</span> ‚Üí USD</div></div>
                                    <div id="convertedAmountBox" class="hidden"><div class="rate-box-label">Converted (USD)</div><div class="rate-box-value" id="convertedAmount">‚Äî</div><div class="rate-box-sub"><span id="originalAmount">0</span> <span id="originalCurrency">USD</span> ‚Üí</div></div>
                                    <div class="rate-box-footer">Source: Yahoo Finance ‚Ä¢ Updated: <span id="rateTimestamp">‚Äî</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div style="padding:18px 24px 0;border-top:1px solid var(--border);margin-top:4px">
                        <button type="submit" id="submitActivityBtn" class="btn btn-primary" disabled>
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Log Activity
                        </button>
                    </div>
                </form>

                <!-- Activity History -->
                <div style="margin-top:32px">
                    <div class="card-header"><span>Activity History</span>
                        <div class="export-wrap"><button class="btn btn-export" id="exportActivitiesBtn"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Export ‚ñæ</button>
                            <div class="export-dropdown" id="exportActivitiesDropdown"><button class="export-item" data-export="activities-xlsx">Excel (.xlsx)</button><button class="export-item" data-export="activities-pdf">PDF</button></div>
                        </div>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th class="th">Date</th><th class="th">Client</th><th class="th">Bond</th><th class="th">ISIN</th><th class="th">Ticker</th><th class="th">Type</th><th class="th">Size (MM)</th><th class="th">CCY</th><th class="th">Dir</th><th class="th">Status</th><th class="th">Notes</th><th class="th" style="text-align:center">Del</th></tr></thead><tbody id="activitiesTableBody"><tr><td colspan="12" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No activities yet.</td></tr></tbody></table></div>
                </div>
            </div>

            <!-- ========== NEW ISSUES TAB ========== -->
            <div id="newIssuesTab" class="tab-content hidden" style="padding:28px">
                <div class="card-header">Track New Bond Issues</div>

                <form id="newIssueForm">
                    <div class="form-panel">
                        <div class="panel-left">
                            <div class="panel-label"><svg viewBox="0 0 20 20" fill="currentColor"><path d="M13.707 5.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L6 10.586l6.293-6.293a1 1 0 011.414 0z"/></svg> User Input</div>
                            <div class="field-group"><label class="form-label">Issuer Name</label><input id="newIssueIssuer" type="text" class="form-input" placeholder="e.g. Apple Inc." required></div>

                            <div class="field-group">
                                <label class="form-label">ISIN / Ticker</label>
                                <div class="linked-pair">
                                    <input id="newIssueISIN" type="text" class="form-input" placeholder="ISIN" maxlength="12">
                                    <button type="button" class="link-swap-btn" id="swapNewIssueISINTickerBtn" title="Swap fields">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
                                    </button>
                                    <input id="newIssueTicker" type="text" class="form-input" placeholder="Ticker" maxlength="10">
                                </div>
                                <p class="form-hint">Enter either ‚Äî the other auto-fills via Bloomberg API</p>
                            </div>

                            <div class="field-group"><label class="form-label">Issue Size (MM)</label><input id="newIssueSize" type="number" step="0.01" class="form-input" placeholder="0.00"></div>
                            <div class="field-group">
                                <label class="form-label">Currency</label>
                                <select id="newIssueCurrency" class="form-select"><option value="">Select‚Ä¶</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="JPY">JPY</option><option value="CNH">CNH</option><option value="AUD">AUD</option><option value="CUSTOM">Other (specify‚Ä¶)</option></select>
                            </div>
                            <div id="newIssueCustomCurrencyDiv" class="field-group hidden"><label class="form-label">Custom Currency Code</label><input id="newIssueCustomCurrency" type="text" class="form-input" placeholder="e.g. SGD" maxlength="3"></div>
                            <div class="field-group"><label class="form-label">Notes</label><textarea id="newIssueNotes" rows="3" class="form-textarea" placeholder="Market conditions, pricing color‚Ä¶"></textarea></div>
                        </div>
                        <div class="panel-right">
                            <div class="panel-label"><svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg> Auto-Filled</div>
                            <div class="field-group"><label class="form-label">Bond Name</label><input id="newIssueBondName" type="text" class="form-input input-autofill" readonly placeholder="Auto-filled from ISIN/Ticker"></div>
                            <div class="field-group"><label class="form-label">Coupon (%)</label><input id="newIssueCoupon" type="number" step="0.01" class="form-input input-autofill" readonly placeholder="From Bloomberg"></div>
                            <div class="field-group"><label class="form-label">Maturity Date</label><input id="newIssueMaturity" type="text" class="form-input input-autofill" readonly placeholder="From Bloomberg"></div>
                            <div class="field-group"><label class="form-label">Price Target</label><input id="newIssuePriceTarget" type="number" step="0.01" class="form-input" placeholder="100.00"></div>
                        </div>
                    </div>
                    <div style="padding:18px 24px 0;border-top:1px solid var(--border);margin-top:4px">
                        <button type="submit" class="btn btn-primary"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add New Issue</button>
                    </div>
                </form>

                <!-- Issues Table -->
                <div style="margin-top:32px">
                    <div class="card-header"><span>Tracked Issues</span>
                        <div class="export-wrap"><button class="btn btn-export" id="exportIssuesBtn"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Export ‚ñæ</button>
                            <div class="export-dropdown" id="exportIssuesDropdown"><button class="export-item" data-export="issues-xlsx">Excel (.xlsx)</button><button class="export-item" data-export="issues-pdf">PDF</button></div>
                        </div>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th class="th">Issuer</th><th class="th">ISIN</th><th class="th">Ticker</th><th class="th">Bond Name</th><th class="th">Coupon</th><th class="th">Maturity</th><th class="th">Size (MM)</th><th class="th">CCY</th><th class="th" style="text-align:center">Del</th></tr></thead><tbody id="newIssuesTableBody"><tr><td colspan="9" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No issues tracked yet.</td></tr></tbody></table></div>
                </div>
            </div>

            <!-- ========== CLIENTS TAB ========== -->
            <div id="clientsTab" class="tab-content hidden" style="padding:28px">
                <div class="card-header">Client Database</div>
                <form id="clientForm">
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px">
                        <div><label class="form-label">Client Name</label><input id="clientNameInputForDb" type="text" class="form-input" placeholder="ABC INVESTMENT FUND" required></div>
                        <div><label class="form-label">Client Type</label><select id="newClientTypeSelect" class="form-select" required><option value="">Select‚Ä¶</option><option value="ASSET MANAGER">Asset Manager</option><option value="HEDGE FUND">Hedge Fund</option><option value="PENSION FUND">Pension Fund</option><option value="INSURANCE">Insurance</option><option value="BANK">Bank</option><option value="SOVEREIGN">Sovereign</option><option value="OTHER">Other</option></select></div>
                        <div><label class="form-label">Region</label><input id="newClientRegionInput" type="text" class="form-input" placeholder="APAC / EMEA / AMERICAS" required></div>
                        <div><label class="form-label">Sales Coverage</label><input id="newClientCoverageInput" type="text" class="form-input" placeholder="e.g. John Smith" required></div>
                    </div>
                    <div style="margin-top:16px"><button type="button" id="addClientBtn" class="btn btn-primary"><svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add Client</button></div>
                </form>

                <!-- Client List -->
                <div class="client-table-wrap">
                    <div class="card-header"><span>Client List</span>
                        <div class="export-wrap"><button class="btn btn-export" id="exportClientsBtn"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Export ‚ñæ</button>
                            <div class="export-dropdown" id="exportClientsDropdown"><button class="export-item" data-export="clients-xlsx">Excel (.xlsx)</button><button class="export-item" data-export="clients-pdf">PDF</button></div>
                        </div>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th class="th">Client Name</th><th class="th">Type</th><th class="th">Region</th><th class="th">Sales Coverage</th><th class="th" style="text-align:center">Del</th></tr></thead><tbody id="clientsTableBody"><tr><td colspan="5" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No clients yet.</td></tr></tbody></table></div>
                </div>
            </div>

            <!-- ========== AI TAB ========== -->
            <div id="aiTab" class="tab-content hidden" style="padding:28px">
                <div class="card-header">AI Assistant <span class="ai-badge">Gemini AI</span></div>
                
                <!-- Upload & Analyze -->
                <div style="background:var(--section-label-bg);border:1px solid var(--section-label-border);border-radius:12px;padding:24px">
                    <h3 style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:10px">Chat Transcript Analysis</h3>
                    <p style="font-size:13px;color:var(--text-muted);margin-bottom:18px">Upload Bloomberg/WhatsApp/Slack chats. Gemini AI extracts client names, bond ISINs, sizes, pricing, and trade direction.</p>
                    
                    <!-- File Upload -->
                    <div id="aiDropZone" style="border:2px dashed var(--border);border-radius:10px;padding:36px;text-align:center;cursor:pointer;transition:all .2s">
                        <input type="file" id="aiFileInput" accept=".txt,.csv" style="display:none">
                        <svg width="40" height="40" fill="none" stroke="var(--text-muted)" viewBox="0 0 24 24" style="margin:0 auto 10px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p style="font-size:13px;color:var(--text-muted)">Click to upload or drag & drop</p>
                        <p style="font-size:11.5px;color:var(--text-muted);margin-top:4px">.txt or .csv</p>
                    </div>
                    
                    <!-- Preview -->
                    <div id="aiPreview" class="transcript-preview hidden" style="margin-top:16px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <p style="font-size:11px;color:var(--text-muted);margin:0">Uploaded file:</p>
                            <button id="aiClearBtn" style="background:none;border:none;color:var(--text-muted);font-size:11px;cursor:pointer">‚úï Clear</button>
                        </div>
                        <p id="aiFileName" style="font-weight:600;color:var(--text-primary);margin-bottom:8px"></p>
                        <pre id="aiFileContent" style="max-height:120px;overflow-y:auto;font-size:11.5px;color:var(--text-muted);white-space:pre-wrap;word-break:break-word"></pre>
                    </div>
                    
                    <!-- Analyze Button -->
                    <button id="aiAnalyzeBtn" class="btn btn-primary hidden" style="width:100%;justify-content:center;margin-top:16px">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Analyze with Gemini AI
                    </button>
                </div>

                <!-- Results -->
                <div id="aiResults" class="hidden" style="margin-top:20px">
                    <div class="card-header"><span>Extracted Activities</span>
                        <div style="display:flex;gap:8px;align-items:center">
                            <div class="export-wrap"><button class="btn btn-export" id="exportAIBtn"><svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Export ‚ñæ</button>
                                <div class="export-dropdown" id="exportAIDropdown"><button class="export-item" data-export="ai-xlsx">Excel (.xlsx)</button><button class="export-item" data-export="ai-pdf">PDF</button></div>
                            </div>
                            <button id="aiImportAllBtn" class="btn btn-primary" style="padding:8px 14px;font-size:13px">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Import All to Activity Log
                            </button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr>
                                <th class="th">Client</th>
                                <th class="th">Bond/ISIN</th>
                                <th class="th">Ticker</th>
                                <th class="th">Size (MM)</th>
                                <th class="th">Currency</th>
                                <th class="th">Direction</th>
                                <th class="th">Price</th>
                                <th class="th">Notes</th>
                            </tr></thead>
                            <tbody id="aiResultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== SCRIPTS ===== -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, collection, addDoc, deleteDoc, doc, getDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, confirmPasswordReset, verifyPasswordResetCode, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

const firebaseConfig = { apiKey:"AIzaSyBkQnlYdOsIki_VuEpMBsIFACLN-u2FYFo", authDomain:"bond-sales-tracker.firebaseapp.com", projectId:"bond-sales-tracker", storageBucket:"bond-sales-tracker.firebasestorage.app", messagingSenderId:"293591418173", appId:"1:293591418173:web:b0ca2b77f514dc6c9b3154" };

let app, db, auth, appId, userId, isAuthReady=false, isAdmin=false;
let unsub = { activities:null, issues:null, clients:null };
let clientsCache = [];
let activitiesCache = [];
let issuesCache = [];
let deleteTarget=null, deleteType=null;

// ---- DOM refs ----
const $ = id => document.getElementById(id);
const authOverlay=$('authOverlay'), appContent=$('appContent');
const authPanelLogin=$('authPanelLogin'), authPanelRegister=$('authPanelRegister'), authPanelForgot=$('authPanelForgot'), authPanelReset=$('authPanelReset');
const loginForm=$('loginForm'), registerForm=$('registerForm'), forgotPasswordForm=$('forgotPasswordForm');
const authMessage=$('authMessage'), registerMessage=$('registerMessage'), forgotMessage=$('forgotMessage'), resetMessage=$('resetMessage');
const forgotSuccessState=$('forgotSuccessState'), forgotEmailDisplay=$('forgotEmailDisplay');
const resetFormState=$('resetFormState'), resetSuccessState=$('resetSuccessState');
const resetPassword=$('resetPassword'), resetPasswordConfirm=$('resetPasswordConfirm'), resetSubmitBtn=$('resetSubmitBtn'), resetDoneBtn=$('resetDoneBtn');
let resetOobCode = null;
const accountBtn=$('accountBtn'), accountModal=$('accountModal'), closeAccountModal=$('closeAccountModal'), closeAccountModalBtn=$('closeAccountModalBtn'), logoutBtn=$('logoutBtn');
const userEmailSpan=$('userEmail'), accountEmailEl=$('accountEmail'), accountLogsCount=$('accountLogsCount'), accountLastUpdate=$('accountLastUpdate'), accountTotalSize=$('accountTotalSize');
const successMessage=$('successMessage'), errorMessage=$('errorMessage'), loadingIndicator=$('loadingIndicator');
const deleteModal=$('deleteModal'), confirmDeleteBtn=$('confirmDeleteBtn'), cancelDeleteBtn=$('cancelDeleteBtn');

// Activity
const activityForm=$('activityForm'), clientNameSelect=$('clientNameSelect');
const clientTypeInput=$('clientTypeInput'), clientRegionInput=$('clientRegionInput'), clientCoverageInput=$('clientCoverageInput');
const isinInput=$('isinInput'), tickerInput=$('tickerInput'), bondNameInput=$('bondName');
const sizeInput=$('sizeInput'), currencySelect=$('currencySelect'), customCurrencyDiv=$('customCurrencyDiv'), customCurrencyInput=$('customCurrencyInput');
const priceInput=$('priceInput'), directionSelect=$('directionSelect'), statusSelect=$('statusSelect'), activityTypeSelect=$('activityType'), notesTextarea=$('notesTextarea');
const submitActivityBtn=$('submitActivityBtn'), fetchRatesBtn=$('fetchRatesBtn');
const ratesDisplay=$('ratesDisplay'), exchangeRateEl=$('exchangeRate'), selectedCurrencyEl=$('selectedCurrency');
const convertedAmountBox=$('convertedAmountBox'), originalAmountEl=$('originalAmount'), originalCurrencyEl=$('originalCurrency'), convertedAmountEl=$('convertedAmount'), rateTimestampEl=$('rateTimestamp');
const activitiesTableBody=$('activitiesTableBody');

// New Issue
const newIssueForm=$('newIssueForm'), newIssueISIN=$('newIssueISIN'), newIssueTicker=$('newIssueTicker'), newIssueBondName=$('newIssueBondName');
const newIssueCoupon=$('newIssueCoupon'), newIssueMaturity=$('newIssueMaturity');
const newIssueCurrency=$('newIssueCurrency'), newIssueCustomCurrencyDiv=$('newIssueCustomCurrencyDiv'), newIssueCustomCurrency=$('newIssueCustomCurrency');
const newIssuesTableBody=$('newIssuesTableBody');

// Clients
const addClientBtn=$('addClientBtn'), clientNameInputForDb=$('clientNameInputForDb'), newClientTypeSelect=$('newClientTypeSelect'), newClientRegionInput=$('newClientRegionInput'), newClientCoverageInput=$('newClientCoverageInput');
const clientsTableBody=$('clientsTableBody');

// Theme
const themeToggle=$('themeToggle');

// AI Assistant
const aiDropZone=$('aiDropZone'), aiFileInput=$('aiFileInput'), aiPreview=$('aiPreview'), aiClearBtn=$('aiClearBtn');
const aiFileName=$('aiFileName'), aiFileContent=$('aiFileContent'), aiAnalyzeBtn=$('aiAnalyzeBtn');
const aiResults=$('aiResults'), aiResultsTableBody=$('aiResultsTableBody'), aiImportAllBtn=$('aiImportAllBtn');
let aiExtractedData = [];

// ========== UTILS ==========
function showMsg(el, text, dur=3000) { el.querySelector('span').textContent=text; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),dur); }
function showLoading(v=true) { loadingIndicator.classList.toggle('hidden',!v); }
function esc(s) { const d=document.createElement('div'); d.appendChild(document.createTextNode(s||'')); return d.innerHTML; }
function setAuthMsg(el, t, err=false) { if(!t){el.classList.add('hidden');return;} el.textContent=t; el.style.cssText=`font-size:13px;text-align:center;padding:10px 14px;border-radius:8px;margin-bottom:14px;background:${err?'rgba(220,38,38,0.1)':'rgba(34,197,94,0.1)'};color:${err?'#fca5a5':'#86efac'}`; el.classList.remove('hidden'); }
function getCurrency(sel, customEl) { return sel.value==='CUSTOM' ? customEl.value.trim().toUpperCase() : sel.value; }

// ========== THEME ==========
themeToggle.addEventListener('click', ()=> {
    const html = document.documentElement;
    html.dataset.theme = html.dataset.theme==='dark' ? 'light' : 'dark';
    try { localStorage.setItem('bt_theme', html.dataset.theme); } catch(e){}
});
// Restore on load
(function(){ try { const t=localStorage.getItem('bt_theme'); if(t) document.documentElement.dataset.theme=t; } catch(e){} })();

// ========== TABS ==========
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', ()=> {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        ['activityTab','newIssuesTab','clientsTab','aiTab'].forEach(id=>$( id).classList.add('hidden'));
        $( btn.dataset.tab==='activity'?'activityTab':btn.dataset.tab==='newIssues'?'newIssuesTab':btn.dataset.tab==='clients'?'clientsTab':'aiTab').classList.remove('hidden');
    });
});

// ========== EXPORT FUNCTIONS ==========
function exportActivitiesXLSX() {
    const rows = activitiesCache.map(a=>({ Date: a.timestamp?.toDate?.()?.toLocaleString()||'', Client: a.clientName||'', Bond: a.bondName||'', ISIN: a.isin||'', Ticker: a.ticker||'', Type: a.activityType||'', 'Size (MM)': a.size||0, Currency: a.currency||'USD', Direction: a.direction||'', Status: a.status||'', Notes: a.notes||'' }));
    if(!rows.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Activities');
    XLSX.writeFile(wb, 'BondTracker_Activities.xlsx');
    showMsg(successMessage,'Exported Activities to Excel',2500);
}
function exportIssuesXLSX() {
    const rows = issuesCache.map(i=>({ Issuer: i.issuer||'', ISIN: i.isin||'', Ticker: i.ticker||'', 'Bond Name': i.bondName||'', 'Coupon (%)': i.coupon||'', Maturity: i.maturity||'', 'Size (MM)': i.size||0, Currency: i.currency||'USD', 'Price Target': i.priceTarget||'', Notes: i.notes||'' }));
    if(!rows.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'NewIssues');
    XLSX.writeFile(wb, 'BondTracker_NewIssues.xlsx');
    showMsg(successMessage,'Exported Issues to Excel',2500);
}
function exportClientsXLSX() {
    const rows = clientsCache.map(c=>({ 'Client Name': c.clientName||'', Type: c.clientType||'', Region: c.clientRegion||'', 'Sales Coverage': c.salesCoverage||'' }));
    if(!rows.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Clients');
    XLSX.writeFile(wb, 'BondTracker_Clients.xlsx');
    showMsg(successMessage,'Exported Clients to Excel',2500);
}

// PDF export using print-style approach (no external lib needed)
function generatePDFHTML(title, headers, rows) {
    return `<!DOCTYPE html><html><head><style>
        body{font-family:Arial,sans-serif;padding:28px;color:#1a1a2e;font-size:13px}
        h1{font-size:20px;margin-bottom:4px;color:#0f172a} .sub{color:#6b7280;font-size:12px;margin-bottom:20px}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th{background:#1e293b;color:#fff;padding:9px 12px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.04em}
        td{padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:12.5px}
        tr:nth-child(even) td{background:#f9fafb}
        .footer{margin-top:24px;font-size:11px;color:#9ca3af}
    </style></head><body>
        <h1>BondTracker Enterprise ‚Äî ${title}</h1>
        <p class="sub">Exported: ${new Date().toLocaleString()}</p>
        <table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>
        <p class="footer">¬© BondTracker Enterprise ‚Ä¢ Confidential</p>
    </body></html>`;
}
function printPDF(html) {
    const w = window.open('','_blank');
    w.document.write(html);
    w.document.close();
    w.onload = ()=> { w.print(); w.close(); };
}
function exportActivitiesPDF() {
    if(!activitiesCache.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const headers=['Date','Client','Bond','ISIN','Ticker','Type','Size','CCY','Status'];
    const rows=activitiesCache.map(a=>[a.timestamp?.toDate?.()?.toLocaleDateString()||'',a.clientName||'',a.bondName||'',a.isin||'',a.ticker||'',a.activityType||'',(a.size||0).toFixed(2),a.currency||'USD',a.status||'']);
    printPDF(generatePDFHTML('Activity History',headers,rows));
    showMsg(successMessage,'PDF print dialog opened',2500);
}
function exportIssuesPDF() {
    if(!issuesCache.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const headers=['Issuer','ISIN','Ticker','Bond Name','Coupon','Maturity','Size','CCY'];
    const rows=issuesCache.map(i=>[i.issuer||'',i.isin||'',i.ticker||'',i.bondName||'',i.coupon?i.coupon.toFixed(2)+'%':'',i.maturity||'',(i.size||0).toFixed(2),i.currency||'USD']);
    printPDF(generatePDFHTML('Tracked Issues',headers,rows));
    showMsg(successMessage,'PDF print dialog opened',2500);
}
function exportClientsPDF() {
    if(!clientsCache.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const headers=['Client Name','Type','Region','Sales Coverage'];
    const rows=clientsCache.map(c=>[c.clientName||'',c.clientType||'',c.clientRegion||'',c.salesCoverage||'']);
    printPDF(generatePDFHTML('Client Database',headers,rows));
    showMsg(successMessage,'PDF print dialog opened',2500);
}

function exportAIXLSX() {
    if(!aiExtractedData?.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const rows = aiExtractedData.map(a=>({
        Client: a.clientName||'',
        'Bond / ISIN': a.bondName||a.isin||'',
        Ticker: a.ticker||'',
        'Size (MM)': a.size||0,
        Currency: a.currency||'USD',
        Direction: a.direction||'',
        Price: a.price||'',
        Notes: a.notes||''
    }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'AI Extracted');
    XLSX.writeFile(wb, 'BondTracker_AI_Extracted.xlsx');
}
function exportAIPDF() {
    if(!aiExtractedData?.length){ showMsg(errorMessage,'No data to export',2000); return; }
    const headers=['Client','Bond / ISIN','Ticker','Size (MM)','Currency','Direction','Price','Notes'];
    const rows = aiExtractedData.map(a=>[a.clientName||'',a.bondName||a.isin||'',a.ticker||'',a.size||0,a.currency||'USD',a.direction||'',a.price||'',a.notes||'']);
    printPDF(generatePDFHTML('AI Extracted Activities',headers,rows));
    showMsg(successMessage,'PDF print dialog opened',2500);
}

// ========== AUTH ‚Äî PANEL NAVIGATION ==========
function showAuthPanel(name) {
    authPanelLogin.classList.add('hidden');
    authPanelRegister.classList.add('hidden');
    authPanelForgot.classList.add('hidden');
    authPanelReset.classList.add('hidden');
    // clear all message banners
    setAuthMsg(authMessage,'');
    setAuthMsg(registerMessage,'');
    setAuthMsg(forgotMessage,'');
    setAuthMsg(resetMessage,'');
    // reset forgot success state back to form
    forgotSuccessState.classList.add('hidden');
    forgotPasswordForm.classList.remove('hidden');
    // reset the reset-password panel back to form state
    resetSuccessState.classList.add('hidden');
    resetFormState.classList.remove('hidden');

    if(name==='login')      authPanelLogin.classList.remove('hidden');
    else if(name==='register') authPanelRegister.classList.remove('hidden');
    else if(name==='forgot')   authPanelForgot.classList.remove('hidden');
    else if(name==='reset')    authPanelReset.classList.remove('hidden');
}

// Sign In panel ‚Üí links to other panels
$('goToRegister').addEventListener('click',()=>{ showAuthPanel('register'); });
$('goToForgot').addEventListener('click',()=>{ showAuthPanel('forgot'); });

// Create Account panel ‚Üí back arrow
$('backFromRegister').addEventListener('click',()=>{ showAuthPanel('login'); });

// Forgot Password panel ‚Üí back arrows (both from form state and success state)
$('backFromForgot').addEventListener('click',()=>{ showAuthPanel('login'); });
$('backFromForgotSuccess').addEventListener('click',()=>{ showAuthPanel('login'); });

// ‚îÄ‚îÄ PASSWORD STRENGTH ‚îÄ‚îÄ
$('registerPassword').addEventListener('input', ()=>{
    const p = $('registerPassword').value;
    let score = 0;
    if(p.length >= 6)  score++;
    if(p.length >= 10) score++;
    if(/[A-Z]/.test(p) && /[a-z]/.test(p)) score++;
    if(/[0-9]/.test(p)) score++;
    if(/[^A-Za-z0-9]/.test(p)) score = Math.min(score+1, 4);
    const colors = ['','#ef4444','#f59e0b','#22c55e','#6366f1'];
    const labels = ['','Weak','Fair','Good','Strong'];
    for(let i=1;i<=4;i++) $('strBar'+i).style.background = i<=score ? colors[score] : 'var(--border)';
    $('strLabel').textContent = p.length ? labels[score] : '';
    $('strLabel').style.color = colors[score] || 'var(--text-muted)';
});

// ‚îÄ‚îÄ RESET PASSWORD STRENGTH ‚îÄ‚îÄ
resetPassword.addEventListener('input', ()=>{
    const p = resetPassword.value;
    let score = 0;
    if(p.length >= 6)  score++;
    if(p.length >= 10) score++;
    if(/[A-Z]/.test(p) && /[a-z]/.test(p)) score++;
    if(/[0-9]/.test(p)) score++;
    if(/[^A-Za-z0-9]/.test(p)) score = Math.min(score+1, 4);
    const colors = ['','#ef4444','#f59e0b','#22c55e','#6366f1'];
    const labels = ['','Weak','Fair','Good','Strong'];
    for(let i=1;i<=4;i++) $('resetStrBar'+i).style.background = i<=score ? colors[score] : 'var(--border)';
    $('resetStrLabel').textContent = p.length ? labels[score] : '';
    $('resetStrLabel').style.color = colors[score] || 'var(--text-muted)';
});

// ‚îÄ‚îÄ RESET PASSWORD SUBMIT ‚îÄ‚îÄ
resetSubmitBtn.addEventListener('click', async ()=>{
    const pw  = resetPassword.value;
    const pw2 = resetPasswordConfirm.value;
    if(!pw || pw.length < 6) { setAuthMsg(resetMessage, 'Password must be at least 6 characters.', true); return; }
    if(pw !== pw2)           { setAuthMsg(resetMessage, 'Passwords do not match.', true); return; }
    if(!resetOobCode)        { setAuthMsg(resetMessage, 'Invalid reset session. Please request a new link.', true); return; }

    resetSubmitBtn.disabled = true; resetSubmitBtn.textContent = 'Updating‚Ä¶';
    try {
        await confirmPasswordReset(auth, resetOobCode, pw);
        // Success ‚Äî swap to confirmation screen
        resetFormState.classList.add('hidden');
        resetSuccessState.classList.remove('hidden');
        resetOobCode = null;
    } catch(err) {
        const msgs = {
            'auth/invalid-action-code': 'This reset link has expired. Please request a new one.',
            'auth/expired-action-code': 'This reset link has expired. Please request a new one.',
            'auth/weak-password': 'Password is too weak. Use at least 6 characters with a mix of letters and numbers.'
        };
        setAuthMsg(resetMessage, msgs[err.code] || err.message, true);
    }
    resetSubmitBtn.disabled = false; resetSubmitBtn.textContent = 'Update Password';
});

resetDoneBtn.addEventListener('click', ()=>{ showAuthPanel('login'); });

// ‚îÄ‚îÄ SIGN IN ‚îÄ‚îÄ
loginForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const btn = loginForm.querySelector('button[type="submit"]');
    btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
    try {
        await signInWithEmailAndPassword(auth, $('loginEmail').value.trim(), $('loginPassword').value);
        setAuthMsg(authMessage,'');
    } catch(err) {
        setAuthMsg(authMessage, err.message, true);
    }
    btn.disabled = false; btn.textContent = 'Sign In';
});

// ‚îÄ‚îÄ CREATE ACCOUNT ‚îÄ‚îÄ
registerForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const p  = $('registerPassword').value;
    const cp = $('registerPasswordConfirm').value;
    if(p !== cp){ setAuthMsg(registerMessage,'Passwords do not match', true); return; }
    const btn = registerForm.querySelector('button[type="submit"]');
    btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
    try {
        await createUserWithEmailAndPassword(auth, $('registerEmail').value.trim(), p);
        setAuthMsg(registerMessage,'');
    } catch(err) {
        setAuthMsg(registerMessage, err.message, true);
    }
    btn.disabled = false; btn.textContent = 'Create Account';
});

// ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ
forgotPasswordForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const email = $('forgotPasswordEmail').value.trim();
    const btn = forgotPasswordForm.querySelector('button[type="submit"]');
    btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
    try {
        const actionCodeSettings = {
            url: window.location.origin + '/',
            handleCodeInApp: false
        };
        await sendPasswordResetEmail(auth, email, actionCodeSettings);
        forgotPasswordForm.classList.add('hidden');
        forgotEmailDisplay.textContent = email;
        forgotSuccessState.classList.remove('hidden');
        setAuthMsg(forgotMessage,'');
    } catch(err) {
        const msgs = {
            'auth/user-not-found': 'No account found with this email.',
            'auth/invalid-email': 'Please enter a valid email address.',
            'auth/too-many-requests': 'Too many attempts. Please wait a few minutes and try again.',
            'auth/operation-not-allowed': 'Password reset is not enabled. Contact your administrator.'
        };
        setAuthMsg(forgotMessage, msgs[err.code] || err.message, true);
    }
    btn.disabled = false; btn.textContent = 'Send Reset Link';
});
logoutBtn.addEventListener('click',async()=>{ try{ await signOut(auth); accountModal.style.display='none'; }catch(e){ showMsg(errorMessage,'Sign out failed'); }});
accountBtn.addEventListener('click',()=>{ accountModal.style.display='flex'; });
closeAccountModal.addEventListener('click',()=>{ accountModal.style.display='none'; });
closeAccountModalBtn.addEventListener('click',()=>{ accountModal.style.display='none'; });

// ========== CURRENCY TOGGLES ==========
currencySelect.addEventListener('change',()=>{ customCurrencyDiv.classList.toggle('hidden', currencySelect.value!=='CUSTOM'); updateBtnStates(); ratesDisplay.classList.add('hidden'); });
newIssueCurrency.addEventListener('change',()=>{ newIssueCustomCurrencyDiv.classList.toggle('hidden', newIssueCurrency.value!=='CUSTOM'); });
customCurrencyInput.addEventListener('input', updateBtnStates);

// ========== ISIN / TICKER LINKED PAIR ==========
// Activity tab
isinInput.addEventListener('input',()=>{ bondNameInput.value=''; updateBtnStates(); });
tickerInput.addEventListener('input',()=>{ bondNameInput.value=''; updateBtnStates(); });
$('swapISINTickerBtn').addEventListener('click',()=>{ const tmp=isinInput.value; isinInput.value=tickerInput.value; tickerInput.value=tmp; });

// New Issues tab
newIssueISIN.addEventListener('input',()=>{ newIssueBondName.value=''; });
newIssueTicker.addEventListener('input',()=>{ newIssueBondName.value=''; });
$('swapNewIssueISINTickerBtn').addEventListener('click',()=>{ const tmp=newIssueISIN.value; newIssueISIN.value=newIssueTicker.value; newIssueTicker.value=tmp; });

// ========== CLIENT SELECT ‚Üí autofill =========
clientNameSelect.addEventListener('change',()=>{
    const sel=clientNameSelect.selectedOptions[0];
    clientTypeInput.value = sel?.dataset?.type||'';
    clientRegionInput.value = sel?.dataset?.region||'';
    clientCoverageInput.value = sel?.dataset?.coverage||'';
    updateBtnStates();
});

// ========== FORM VALIDATION ==========
function updateBtnStates() {
    const hasClient = clientNameSelect.value.trim()!=='';
    const hasBondOrISINOrTicker = bondNameInput.value.trim()!=='' || isinInput.value.trim()!=='' || tickerInput.value.trim()!=='';
    const hasSize = sizeInput.value.trim()!=='';
    const hasDir = directionSelect.value.trim()!=='';
    const hasStat = statusSelect.value.trim()!=='';
    const hasActType = activityTypeSelect.value.trim()!=='';
    const hasCurrency = getCurrency(currencySelect, customCurrencyInput)!=='';
    submitActivityBtn.disabled = !(hasClient && hasBondOrISINOrTicker && hasSize && hasDir && hasStat && hasActType && hasCurrency && isAuthReady);
    fetchRatesBtn.disabled = !(hasCurrency && hasSize && isAuthReady);
}
['bondName','isinInput','tickerInput','sizeInput','directionSelect','statusSelect','activityType','currencySelect'].forEach(id => {
    const el=$(id); if(el){ el.addEventListener('input',updateBtnStates); el.addEventListener('change',updateBtnStates); }
});

// ========== FETCH EXCHANGE RATE ==========
fetchRatesBtn.addEventListener('click', async()=> {
    const currency = getCurrency(currencySelect, customCurrencyInput);
    const size = parseFloat(sizeInput.value)||0;
    if(!currency){ showMsg(errorMessage,'Select a currency first',2000); return; }
    if(!size){ showMsg(errorMessage,'Enter a trade size first',2000); return; }
    showLoading(true);
    try {
        let rate=1.0;
        if(currency!=='USD'){
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${currency}USD=X?interval=1d&range=1d`);
                const data = await res.json();
                const meta = data?.chart?.result?.[0]?.meta;
                rate = meta?.regularMarketPrice || meta?.previousClose;
                if(!rate) throw new Error('Rate not found');
            } catch {
                const fb={EUR:1.08,GBP:1.27,JPY:0.0067,CNH:0.138,AUD:0.64,CAD:0.71,CHF:1.13,SGD:0.74,HKD:0.128};
                rate = fb[currency]||1.0;
            }
        }
        selectedCurrencyEl.textContent=currency;
        exchangeRateEl.textContent=rate.toFixed(4);
        if(currency!=='USD'){
            originalAmountEl.textContent=size.toFixed(2);
            originalCurrencyEl.textContent=currency;
            convertedAmountEl.textContent=(size*rate).toFixed(2)+' USD';
            convertedAmountBox.classList.remove('hidden');
        } else { convertedAmountBox.classList.add('hidden'); }
        rateTimestampEl.textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        ratesDisplay.classList.remove('hidden');
        showMsg(successMessage,`1 ${currency} = ${rate.toFixed(4)} USD`,2500);
    } catch(e){ showMsg(errorMessage,'Failed to fetch rate: '+e.message,3000); }
    finally { showLoading(false); }
});

// ========== ACTIVITY FORM SUBMIT ==========
activityForm.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!appId||!userId){ showMsg(errorMessage,'Not ready.'); return; }
    const currency = getCurrency(currencySelect, customCurrencyInput);
    if(!currency){ showMsg(errorMessage,'Please select a currency.'); return; }
    const bondOrISIN = bondNameInput.value.trim() || isinInput.value.trim() || tickerInput.value.trim();
    if(!bondOrISIN){ showMsg(errorMessage,'Enter Bond Name, ISIN or Ticker.'); return; }
    const data = {
        clientName: clientNameSelect.value.trim().toUpperCase(),
        clientType: clientTypeInput.value.trim().toUpperCase(),
        clientRegion: clientRegionInput.value.trim().toUpperCase(),
        salesCoverage: clientCoverageInput.value.trim(),
        bondName: bondNameInput.value.trim(),
        isin: isinInput.value.trim().toUpperCase(),
        ticker: tickerInput.value.trim().toUpperCase(),
        size: parseFloat(sizeInput.value)||0,
        currency, price: parseFloat(priceInput.value)||null,
        direction: directionSelect.value.trim().toUpperCase(),
        status: statusSelect.value.trim().toUpperCase(),
        activityType: activityTypeSelect.value.trim().toUpperCase(),
        notes: notesTextarea.value.trim(),
        timestamp: serverTimestamp()
    };
    try {
        await addDoc(collection(db,`artifacts/${appId}/users/${userId}/activities`), data);
        activityForm.reset(); clientTypeInput.value=''; clientRegionInput.value=''; clientCoverageInput.value='';
        customCurrencyDiv.classList.add('hidden'); ratesDisplay.classList.add('hidden'); convertedAmountBox.classList.add('hidden');
        updateBtnStates();
        showMsg(successMessage,'Activity logged successfully');
    } catch(err){ showMsg(errorMessage,'Failed: '+err.message); }
});

// ========== NEW ISSUE FORM SUBMIT ==========
newIssueForm.addEventListener('submit', async e=>{
    e.preventDefault();
    if(!appId||!userId){ showMsg(errorMessage,'Not ready.'); return; }
    const currency = getCurrency(newIssueCurrency, newIssueCustomCurrency);
    const data = {
        issuer: $('newIssueIssuer').value.trim(),
        isin: newIssueISIN.value.trim().toUpperCase(),
        ticker: newIssueTicker.value.trim().toUpperCase(),
        bondName: newIssueBondName.value.trim(),
        coupon: parseFloat(newIssueCoupon.value)||null,
        maturity: newIssueMaturity.value||'',
        size: parseFloat($('newIssueSize').value)||0,
        currency: currency||'USD',
        priceTarget: parseFloat($('newIssuePriceTarget').value)||null,
        notes: $('newIssueNotes').value.trim(),
        timestamp: serverTimestamp()
    };
    try {
        await addDoc(collection(db,`artifacts/${appId}/users/${userId}/new_issues`), data);
        newIssueForm.reset(); newIssueBondName.value=''; newIssueCoupon.value=''; newIssueMaturity.value='';
        newIssueCustomCurrencyDiv.classList.add('hidden');
        showMsg(successMessage,'New issue added');
    } catch(err){ showMsg(errorMessage,'Failed: '+err.message); }
});

// ========== CLIENT DB ==========
function populateClientDropdown(clients) {
    clientNameSelect.innerHTML='<option value="">Select client‚Ä¶</option>';
    if(!clients?.length) return;
    clients.sort((a,b)=>(a.clientName||'').localeCompare(b.clientName||''));
    clients.forEach(c=>{
        const o=document.createElement('option');
        o.value=c.clientName; o.textContent=c.clientName;
        o.dataset.type=c.clientType||''; o.dataset.region=c.clientRegion||''; o.dataset.coverage=c.salesCoverage||'';
        clientNameSelect.appendChild(o);
    });
}
function renderClients(clients) {
    if(!clients?.length){ clientsTableBody.innerHTML='<tr><td colspan="5" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No clients yet.</td></tr>'; return; }
    clientsTableBody.innerHTML = clients.map(c=>`<tr class="tr">
        <td class="td" style="font-weight:600;color:var(--text-primary)">${esc(c.clientName)}</td>
        <td class="td">${esc(c.clientType)}</td>
        <td class="td">${esc(c.clientRegion)}</td>
        <td class="td">${esc(c.salesCoverage)}</td>
        <td class="td" style="text-align:center">${isAdmin?`<button onclick="window.deleteClient('${esc(c.id)}')" style="background:none;border:none;cursor:pointer;color:var(--badge-danger-text)"><svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button>`:'<span style="color:var(--text-muted);font-size:12px">‚Äî</span>'}</td>
    </tr>`).join('');
}

addClientBtn.addEventListener('click', async()=>{
    if(!appId||!userId){ showMsg(errorMessage,'Not ready.'); return; }
    const name=clientNameInputForDb.value.trim().toUpperCase();
    const type=newClientTypeSelect.value.trim().toUpperCase();
    const region=newClientRegionInput.value.trim().toUpperCase();
    const coverage=newClientCoverageInput.value.trim();
    if(!name){ showMsg(errorMessage,'Enter client name'); return; }
    if(!type){ showMsg(errorMessage,'Select client type'); return; }
    if(!region){ showMsg(errorMessage,'Enter region'); return; }
    if(!coverage){ showMsg(errorMessage,'Enter sales coverage'); return; }
    if(clientsCache.some(c=>c.clientName===name)){ showMsg(errorMessage,'Client already exists'); return; }
    try {
        await addDoc(collection(db,`artifacts/${appId}/clients`),{ clientName:name, clientType:type, clientRegion:region, salesCoverage:coverage, createdAt:serverTimestamp() });
        clientNameInputForDb.value=''; newClientTypeSelect.value=''; newClientRegionInput.value=''; newClientCoverageInput.value='';
        showMsg(successMessage,'Client added');
    } catch(err){ showMsg(errorMessage,'Failed: '+err.message); }
});

// ========== RENDER TABLES ==========
function renderActivities(arr) {
    if(!arr?.length){ activitiesTableBody.innerHTML='<tr><td colspan="12" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No activities yet.</td></tr>'; return; }
    const statusBadge = { ENQUIRY:'badge-primary', QUOTED:'badge-warning', EXECUTED:'badge-success', PASSED:'badge-danger' };
    activitiesTableBody.innerHTML=arr.map(a=>{
        const d=a.timestamp?.toDate?.();
        const ds=d?d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}):'';
        return `<tr class="tr">
            <td class="td" style="color:var(--text-muted);font-size:12.5px">${ds}</td>
            <td class="td" style="font-weight:600;color:var(--text-primary)">${esc(a.clientName)}</td>
            <td class="td">${esc(a.bondName)}</td>
            <td class="td" style="color:var(--text-muted)">${esc(a.isin)}</td>
            <td class="td" style="color:var(--text-muted)">${esc(a.ticker)}</td>
            <td class="td">${esc(a.activityType)}</td>
            <td class="td" style="font-weight:600">${(a.size||0).toFixed(2)}</td>
            <td class="td"><span class="badge badge-primary">${esc(a.currency||'USD')}</span></td>
            <td class="td">${esc(a.direction)}</td>
            <td class="td"><span class="badge ${statusBadge[a.status]||'badge-primary'}">${esc(a.status)}</span></td>
            <td class="td" style="color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(a.notes)}</td>
            <td class="td" style="text-align:center">${isAdmin?`<button onclick="window.deleteActivity('${esc(a.id)}')" style="background:none;border:none;cursor:pointer;color:var(--badge-danger-text)"><svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button>`:'<span style="color:var(--text-muted);font-size:12px">‚Äî</span>'}</td>
        </tr>`;
    }).join('');
}
function renderNewIssues(arr) {
    if(!arr?.length){ newIssuesTableBody.innerHTML='<tr><td colspan="9" class="td" style="text-align:center;color:var(--text-muted);padding:32px 0">No issues tracked yet.</td></tr>'; return; }
    newIssuesTableBody.innerHTML=arr.map(i=>`<tr class="tr">
        <td class="td" style="font-weight:600;color:var(--text-primary)">${esc(i.issuer)}</td>
        <td class="td" style="color:var(--text-muted)">${esc(i.isin)}</td>
        <td class="td" style="color:var(--text-muted)">${esc(i.ticker)}</td>
        <td class="td">${esc(i.bondName)}</td>
        <td class="td">${i.coupon?i.coupon.toFixed(2)+'%':''}</td>
        <td class="td">${esc(i.maturity)}</td>
        <td class="td" style="font-weight:600">${(i.size||0).toFixed(2)}</td>
        <td class="td"><span class="badge badge-primary">${esc(i.currency||'USD')}</span></td>
        <td class="td" style="text-align:center">${isAdmin?`<button onclick="window.deleteNewIssue('${esc(i.id)}')" style="background:none;border:none;cursor:pointer;color:var(--badge-danger-text)"><svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button>`:'<span style="color:var(--text-muted);font-size:12px">‚Äî</span>'}</td>
    </tr>`).join('');
}

// ========== DELETE ==========
window.deleteActivity = id=>{ deleteTarget=id; deleteType='activity'; deleteModal.style.display='flex'; };
window.deleteNewIssue = id=>{ deleteTarget=id; deleteType='newIssue'; deleteModal.style.display='flex'; };
window.deleteClient = id=>{ deleteTarget=id; deleteType='client'; deleteModal.style.display='flex'; };
confirmDeleteBtn.addEventListener('click', async()=>{
    if(!deleteTarget) return;
    try {
        const col = deleteType==='activity'?'activities':deleteType==='newIssue'?'new_issues':null;
        if(col){ await deleteDoc(doc(db,`artifacts/${appId}/users/${userId}/${col}`,deleteTarget)); }
        else { await deleteDoc(doc(db,`artifacts/${appId}/clients`,deleteTarget)); }
        deleteModal.style.display='none'; deleteTarget=null; deleteType=null;
        showMsg(successMessage,'Deleted successfully');
    } catch(e){ showMsg(errorMessage,'Delete failed: '+e.message); }
});
cancelDeleteBtn.addEventListener('click',()=>{ deleteModal.style.display='none'; deleteTarget=null; deleteType=null; });

// ========== REALTIME LISTENERS ==========
function clearListeners(){ Object.keys(unsub).forEach(k=>{ if(unsub[k]) unsub[k](); unsub[k]=null; }); }
function setupListeners() {
    if(!userId||!appId) return;
    unsub.activities = onSnapshot(query(collection(db,`artifacts/${appId}/users/${userId}/activities`),orderBy('timestamp','desc')), snap=>{
        activitiesCache=[]; snap.forEach(d=>activitiesCache.push({id:d.id,...d.data()}));
        renderActivities(activitiesCache);
        accountLogsCount.textContent=activitiesCache.length;
        accountTotalSize.textContent=activitiesCache.reduce((s,a)=>s+(a.size||0),0).toFixed(2);
        if(activitiesCache.length){ const d=activitiesCache[0].timestamp?.toDate?.(); accountLastUpdate.textContent=d?d.toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):''; }
    });
    unsub.issues = onSnapshot(query(collection(db,`artifacts/${appId}/users/${userId}/new_issues`),orderBy('timestamp','desc')), snap=>{
        issuesCache=[]; snap.forEach(d=>issuesCache.push({id:d.id,...d.data()}));
        renderNewIssues(issuesCache);
    });
    unsub.clients = onSnapshot(query(collection(db,`artifacts/${appId}/clients`),orderBy('createdAt','desc')), snap=>{
        clientsCache=[]; snap.forEach(d=>clientsCache.push({id:d.id,...d.data()}));
        populateClientDropdown(clientsCache);
        renderClients(clientsCache);
    });
}

// ========== AI ASSISTANT ==========
// File Upload
let aiFileData = null;
aiDropZone.addEventListener('click',()=>aiFileInput.click());
aiDropZone.addEventListener('dragover',(e)=>{ e.preventDefault(); aiDropZone.style.borderColor='var(--accent)'; });
aiDropZone.addEventListener('dragleave',()=>{ aiDropZone.style.borderColor='var(--border)'; });
aiDropZone.addEventListener('drop',(e)=>{
    e.preventDefault(); aiDropZone.style.borderColor='var(--border)';
    if(e.dataTransfer.files.length) handleAIFile(e.dataTransfer.files[0]);
});
aiFileInput.addEventListener('change',()=>{ if(aiFileInput.files.length) handleAIFile(aiFileInput.files[0]); });
aiClearBtn.addEventListener('click',()=>{ aiFileData=null; aiPreview.classList.add('hidden'); aiAnalyzeBtn.classList.add('hidden'); aiFileInput.value=''; });

function handleAIFile(file) {
    if(!file.name.match(/\.(txt|csv)$/i)){ showMsg(errorMessage,'Only .txt or .csv files',2000); return; }
    const reader = new FileReader();
    reader.onload = e => {
        aiFileData = e.target.result;
        aiFileName.textContent = file.name;
        aiFileContent.textContent = aiFileData.slice(0,500) + (aiFileData.length>500?'...':'');
        aiPreview.classList.remove('hidden');
        aiAnalyzeBtn.classList.remove('hidden');
    };
    reader.readAsText(file);
}

// Analyze with Gemini AI (via Netlify Function)
aiAnalyzeBtn.addEventListener('click', async()=>{
    if(!aiFileData){ showMsg(errorMessage,'Upload a file first',2000); return; }
    
    aiAnalyzeBtn.disabled=true; aiAnalyzeBtn.textContent='Analyzing...';
    showLoading(true);
    
    try {
        const res = await fetch('/.netlify/functions/analyze-transcript', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transcript: aiFileData })
        });
        
        if(!res.ok) {
            const err = await res.json().catch(()=>({}));
            throw new Error(err.error || `Server error: ${res.status}`);
        }
        
        const data = await res.json();
        aiExtractedData = data.activities || [];
        
        if(!Array.isArray(aiExtractedData)) aiExtractedData = [];
        
        if(aiExtractedData.length === 0) {
            showMsg(errorMessage,'No activities found in transcript',3000);
        } else {
            renderAIResults(aiExtractedData);
            aiResults.classList.remove('hidden');
            showMsg(successMessage,`Extracted ${aiExtractedData.length} activities`,2500);
        }
    } catch(err) {
        showMsg(errorMessage,'AI analysis error: '+err.message,4000);
    } finally {
        showLoading(false);
        aiAnalyzeBtn.disabled=false; aiAnalyzeBtn.innerHTML='<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg> Analyze with Gemini AI';
    }
});

function renderAIResults(arr) {
    if(!arr?.length) { aiResultsTableBody.innerHTML='<tr><td colspan="8" class="td" style="text-align:center;color:var(--text-muted);padding:20px">No data</td></tr>'; return; }
    aiResultsTableBody.innerHTML = arr.map((a,i)=>`<tr class="tr">
        <td class="td" style="font-weight:600;color:var(--text-primary)">${esc(a.clientName||'')}</td>
        <td class="td">${esc(a.bondName||a.isin||'')}</td>
        <td class="td">${esc(a.ticker||'')}</td>
        <td class="td">${a.size||0}</td>
        <td class="td"><span class="badge badge-primary">${esc(a.currency||'USD')}</span></td>
        <td class="td">${esc(a.direction||'')}</td>
        <td class="td">${a.price||''}</td>
        <td class="td" style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(a.notes||'')}</td>
    </tr>`).join('');
}

// Import All
aiImportAllBtn.addEventListener('click', async()=>{
    if(!aiExtractedData?.length){ showMsg(errorMessage,'No data to import',2000); return; }
    if(!appId||!userId){ showMsg(errorMessage,'Not signed in',2000); return; }
    
    aiImportAllBtn.disabled=true; aiImportAllBtn.textContent='Importing...';
    let imported=0, failed=0;
    
    for(const item of aiExtractedData) {
        // Find client in dropdown to get full details
        const clientOpt = Array.from(clientNameSelect.options).find(o=>o.value.toUpperCase()===item.clientName?.toUpperCase());
        
        const data = {
            clientName: item.clientName?.toUpperCase()||'UNKNOWN',
            clientType: clientOpt?.dataset?.type||'',
            clientRegion: clientOpt?.dataset?.region||'',
            salesCoverage: clientOpt?.dataset?.coverage||'',
            bondName: item.bondName||'',
            isin: item.isin?.toUpperCase()||'',
            ticker: item.ticker?.toUpperCase()||'',
            size: parseFloat(item.size)||0,
            currency: item.currency?.toUpperCase()||'USD',
            price: parseFloat(item.price)||null,
            direction: item.direction?.toUpperCase()||'',
            status: 'ENQUIRY',
            activityType: 'OTHER',
            notes: item.notes||'Imported from AI analysis',
            timestamp: serverTimestamp()
        };
        
        try {
            await addDoc(collection(db,`artifacts/${appId}/users/${userId}/activities`), data);
            imported++;
        } catch(e) { failed++; }
    }
    
    aiImportAllBtn.disabled=false; aiImportAllBtn.innerHTML='<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Import All to Activity Log';
    
    if(failed===0) {
        showMsg(successMessage,`Imported ${imported} activities`,2500);
        aiExtractedData=[]; aiResults.classList.add('hidden'); aiFileData=null; aiPreview.classList.add('hidden'); aiAnalyzeBtn.classList.add('hidden'); aiFileInput.value='';
    } else {
        showMsg(errorMessage,`Imported ${imported}, failed ${failed}`,3000);
    }
});

// ========== INIT ==========
async function initApp() {
    try { app=initializeApp(firebaseConfig); db=getFirestore(app); auth=getAuth(app); appId=firebaseConfig.projectId; }
    catch(e){ showMsg(errorMessage,'Firebase init failed'); return; }
    
    // Check if this is a password reset redirect from Firebase email link
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('mode') === 'resetPassword' && urlParams.get('oobCode')) {
        resetOobCode = urlParams.get('oobCode');
        // Verify the code is still valid before showing the form
        verifyPasswordResetCode(auth, resetOobCode)
            .then(email => {
                showAuthPanel('reset');
            })
            .catch(err => {
                showAuthPanel('login');
                setAuthMsg(authMessage, 'This reset link has expired or is invalid. Please request a new one.', true);
            });
        // Clean URL so refresh doesn't re-trigger
        history.replaceState({}, '', window.location.pathname);
    }

    // Set up export dropdowns (must happen after DOM is ready)
    ['exportActivitiesBtn','exportIssuesBtn','exportClientsBtn','exportAIBtn'].forEach(id => {
        const btn = $(id);
        const dropId = id.replace('Btn','Dropdown');
        btn.addEventListener('click', (e)=> { e.stopPropagation(); $( dropId).classList.toggle('open'); });
    });
    document.addEventListener('click', ()=> { document.querySelectorAll('.export-dropdown').forEach(d=>d.classList.remove('open')); });

    document.querySelectorAll('.export-item').forEach(item => {
        item.addEventListener('click', ()=> {
            const type = item.dataset.export;
            if(type==='activities-xlsx') exportActivitiesXLSX();
            else if(type==='activities-pdf') exportActivitiesPDF();
            else if(type==='issues-xlsx') exportIssuesXLSX();
            else if(type==='issues-pdf') exportIssuesPDF();
            else if(type==='clients-xlsx') exportClientsXLSX();
            else if(type==='clients-pdf') exportClientsPDF();
            else if(type==='ai-xlsx') exportAIXLSX();
            else if(type==='ai-pdf') exportAIPDF();
            document.querySelectorAll('.export-dropdown').forEach(d=>d.classList.remove('open'));
        });
    });
    
    appContent.classList.add('hidden'); authOverlay.classList.remove('hidden');
    onAuthStateChanged(auth, async user=>{
        clearListeners();
        if(user){
            userId=user.uid; isAuthReady=true;
            
            // Check if user is admin
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                const userDoc = await getDoc(userDocRef);
                isAdmin = userDoc.exists() && userDoc.data()?.role === 'admin';
            } catch(e) {
                console.error('Failed to check admin status:', e);
                isAdmin = false;
            }
            
            userEmailSpan.textContent=user.email||user.uid;
            accountEmailEl.textContent=user.email||user.uid;
            accountBtn.disabled=false;
            appContent.classList.remove('hidden'); authOverlay.classList.add('hidden');
            showAuthPanel('login');
            loginForm.reset(); registerForm.reset(); forgotPasswordForm.reset();
            setupListeners(); updateBtnStates();
        } else {
            userId=null; isAuthReady=false; isAdmin=false;
            userEmailSpan.textContent='Guest'; accountBtn.disabled=true;
            accountEmailEl.textContent='-';
            activitiesCache=[]; issuesCache=[]; clientsCache=[];
            appContent.classList.add('hidden'); authOverlay.classList.remove('hidden');
            showAuthPanel('login'); updateBtnStates();
        }
    });
}
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
