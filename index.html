<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Sales Activity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .container { max-width: 1200px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; color: #e2e8f0; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #63b3ed; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled { background-color: #4a5568; cursor: not-allowed; }
        .btn-primary { background-color: #4c51bf; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #667eea; }
        .btn-primary:disabled { background-color: #3b4252; cursor: not-allowed; color: #a0aec0; }
        .btn-danger { background-color: #e53e3e; color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #fc8181; }
        .tab-btn.active { background-color: #4c51bf; color: white; font-weight: 600; }
        .tab-btn:hover { background-color: #4a5568; }
        .tab-btn { transition: background-color 0.2s; }
        .table-header { background-color: #2d3748; color: #a0aec0; }
        .table-row:nth-child(odd) { background-color: #2d3748; }
        .table-row:nth-child(even) { background-color: #1a202c; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background-color: #2d3748; margin: auto; padding: 24px; border: 1px solid #4a5568; width: 90%; max-width: 400px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center; }
        .auth-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top, rgba(76, 81, 191, 0.25), transparent), rgba(17, 24, 39, 0.95); z-index: 200; padding: 24px; }
        .auth-card { border: 1px solid rgba(99, 179, 237, 0.2); backdrop-filter: blur(6px); }
        .auth-card .btn-primary { width: 100%; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="authOverlay" class="auth-overlay hidden">
        <div class="auth-card bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="authTitle" class="text-3xl font-bold text-center mb-6 text-indigo-400">Sign In</h2>
            <div id="authMessage" class="text-sm text-center mb-4 hidden"></div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input id="loginEmail" type="email" class="form-input" required autocomplete="email">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input id="loginPassword" type="password" class="form-input" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary w-full">Sign In</button>
            </form>

            <form id="registerForm" class="space-y-4 hidden">
                <div>
                    <label for="registerEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input id="registerEmail" type="email" class="form-input" required autocomplete="email">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input id="registerPassword" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <div>
                    <label for="registerPasswordConfirm" class="block text-sm font-medium mb-1">Confirm Password</label>
                    <input id="registerPasswordConfirm" type="password" class="form-input" required minlength="6" autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary w-full">Create Account</button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-400">
                <span id="toggleAuthText">Don't have an account?</span>
                <button id="toggleAuthBtn" type="button" class="text-indigo-400 font-semibold hover:underline ml-1">Register</button>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden">
        <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
            <div class="ml-4 text-white">Fetching rates...</div>
        </div>

        <div id="successMessage" class="fixed top-4 right-4 bg-green-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform translate-x-full hidden">Activity Logged!</div>
        <div id="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white py-2 px-4 rounded-full shadow-lg z-50 transition-transform transform hidden">Failed to log activity. Please try again.</div>

        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
                <p class="mb-6">Are you sure you want to delete this entry?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Delete</button>
                    <button id="cancelDeleteBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-8 lg:p-12">
        <h1 class="text-4xl lg:text-5xl font-extrabold text-center mb-6 text-indigo-400">Bond Sales Activity Tracker</h1>
        <div id="userIdDisplay" class="flex flex-col md:flex-row items-center justify-center md:justify-between gap-3 text-sm mb-6 text-gray-500">
            <div>User ID: <span id="userIdSpan" class="text-gray-200 font-mono text-xs md:text-sm">Loading...</span></div>
            <button id="signOutBtn" type="button" class="btn-primary py-2 px-4 md:px-6 text-xs md:text-sm">Sign Out</button>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Client Database</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input id="newClientName" class="form-input" placeholder="Client Name" />
                <select id="newClientType" class="form-select">
                    <option value="">Select Type</option>
                    <option value="TREASURY">TREASURY</option>
                    <option value="ASSET MANAGER">ASSET MANAGER</option>
                    <option value="HEDGE FUND">HEDGE FUND</option>
                    <option value="SWF">SWF</option>
                    <option value="CENTRAL BANK">CENTRAL BANK</option>
                    <option value="PROP">PROP</option>
                    <option value="WM">WM</option>
                </select>
                <input id="newClientRegion" class="form-input" placeholder="Region (E.g., APAC, EMEA, AMER)" />
                <div class="flex items-center">
                    <button id="addClientBtn" class="btn-primary w-full py-2">Add Client</button>
                </div>
            </div>
            <div id="clientsList" class="text-sm text-gray-300">Clients will appear in the dropdown when added.</div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10 mb-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Log New Activity</h2>
            <div id="activity-hint" class="text-sm text-center mb-4 text-gray-400">Please select an activity type below to enable the form.</div>

            <div class="flex flex-wrap gap-2 mb-6 justify-center lg:justify-start">
                <button id="tab-enquiry" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Enquiry</button>
                <button id="tab-trade" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Trade</button>
                <button id="tab-missed-trades" class="tab-btn px-4 py-2 rounded-full border border-gray-600">Missed Trades</button>
                <button id="tab-new-issues" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <form id="activityForm">
                <input type="hidden" id="activityType" value="" required>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="form-group">
                        <label for="clientName" class="block mb-2 text-sm font-medium">Client Name</label>
                        <select id="clientName" class="form-select" disabled required>
                            <option value="">(Select client from Client Database)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clientType" class="block mb-2 text-sm font-medium">Client Type</label>
                        <input type="text" id="clientType" class="form-input" disabled placeholder="Auto-filled from client database" />
                    </div>
                    <div class="form-group">
                        <label for="clientRegion" class="block mb-2 text-sm font-medium">Client Region</label>
                        <input type="text" id="clientRegion" class="form-input" disabled placeholder="Auto-filled from client database" />
                    </div>
                    <div class="form-group">
                        <label for="securities" class="block mb-2 text-sm font-medium">Securities</label>
                        <input type="text" id="securities" class="form-input" disabled required>
                    </div>

                    <!-- General fields for all activity types -->
                    <div id="commonFields" class="contents">
                        <div class="form-group">
                            <label for="buySell" class="block mb-2 text-sm font-medium">Buy/Sell</label>
                            <select id="buySell" class="form-select" disabled>
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="size" class="block mb-2 text-sm font-medium">Size (MM)</label>
                            <input type="number" id="size" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="priceTarget" class="block mb-2 text-sm font-medium" id="priceLabel">Price Target</label>
                            <input type="text" id="priceTarget" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="currency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="currency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="usdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="usdEquivalent" class="form-input" disabled readonly>
                        </div>
                    </div>

                    <!-- Specific field for Missed Trades -->
                    <div id="missedTradeFields" class="form-group hidden">
                        <label for="cptyTradedAway" class="block mb-2 text-sm font-medium">CPTY Traded Away</label>
                        <input type="text" id="cptyTradedAway" class="form-input" disabled required>
                    </div>

                    <!-- Specific fields for New Issues -->
                    <div id="newIssueFields" class="contents hidden">
                        <div class="form-group">
                            <label for="ioi" class="block mb-2 text-sm font-medium">IOI</label>
                            <input type="text" id="ioi" class="form-input" disabled required>
                        </div>
                        <div class="form-group">
                            <label for="orderSize" class="block mb-2 text-sm font-medium">Order Size (MM)</label>
                            <input type="number" id="orderSize" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="realInterest" class="block mb-2 text-sm font-medium">Real Interest (MM)</label>
                            <input type="number" id="realInterest" class="form-input" disabled step="any" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="niCurrency" class="block mb-2 text-sm font-medium">Currency</label>
                            <select id="niCurrency" class="form-select" disabled required>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="CNH">CNH</option>
                                <option value="HKD">HKD</option>
                                <option value="SGD">SGD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="niUsdEquivalent" class="block mb-2 text-sm font-medium">USD Equivalent (MM)</label>
                            <input type="text" id="niUsdEquivalent" class="form-input" disabled readonly>
                        </div>

                        <div class="form-group lg:col-span-3">
                            <label for="remarks" class="block mb-2 text-sm font-medium">Remarks</label>
                            <textarea id="remarks" class="form-textarea" disabled rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center md:text-right">
                    <button type="submit" id="submitBtn" class="btn-primary mt-4" disabled>Log Activity</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 lg:p-10">
            <h2 class="text-3xl font-bold mb-6 text-white">Activity Log</h2>

            <div class="flex flex-wrap gap-2 mb-6">
                <button id="log-general-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600 active">General Activities</button>
                <button id="log-new-issues-tab" class="tab-btn px-4 py-2 rounded-full border border-gray-600">New Issues</button>
            </div>

            <div id="generalLog" class="overflow-x-auto">
                <table class="min-w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header text-xs uppercase tracking-wider">
                            <th class="p-3 text-left">Timestamp</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Client</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Region</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">Buy/Sell</th>
                            <th class="p-3 text-left">Size (MM)</th>
                            <th class="p-3 text-left">Price/Level</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">CPTY</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="generalLogTable"></tbody>
                </table>
            </div>

            <div id="newIssuesLog" class="overflow-x-auto hidden">
                <table class="min-w-full rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header text-xs uppercase tracking-wider">
                            <th class="p-3 text-left">Timestamp</th>
                            <th class="p-3 text-left">Client</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-left">Region</th>
                            <th class="p-3 text-left">Securities</th>
                            <th class="p-3 text-left">IOI</th>
                            <th class="p-3 text-left">Order Size</th>
                            <th class="p-3 text-left">Real Interest</th>
                            <th class="p-3 text-left">Price Target</th>
                            <th class="p-3 text-left">Currency</th>
                            <th class="p-3 text-left">USD Eq.</th>
                            <th class="p-3 text-left">Remarks</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="newIssuesLogTable"></tbody>
                </table>
            </div>

        </div>
    </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // IMPORTANT: For debugging, enable Firestore logging
        setLogLevel('debug');

        // Global variables for Firebase and auth

let app;   // ✅ declare app here
let db;
let auth;
let userId = null;
let isAuthReady = false;
let appId;
let generalUnsub = null;
let newIssuesUnsub = null;
let clientsUnsub = null;


        const appContent = document.getElementById('appContent');
        const authOverlay = document.getElementById('authOverlay');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleAuthBtn = document.getElementById('toggleAuthBtn');
        const toggleAuthText = document.getElementById('toggleAuthText');
        const authTitle = document.getElementById('authTitle');
        const authMessage = document.getElementById('authMessage');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerPasswordConfirmInput = document.getElementById('registerPasswordConfirm');
        const allFormFields = document.querySelectorAll('#activityForm input, #activityForm select, #activityForm textarea');
        const clientNameSelect = document.getElementById('clientName');
        const clientNameInputForDb = document.getElementById('newClientName');
        const newClientTypeSelect = document.getElementById('newClientType');
        const newClientRegionInput = document.getElementById('newClientRegion');
        const addClientBtn = document.getElementById('addClientBtn');
        const clientsListDiv = document.getElementById('clientsList');
        const clientTypeInput = document.getElementById('clientType');
        const clientRegionInput = document.getElementById('clientRegion');
        const securitiesInput = document.getElementById('securities');
        const buySell = document.getElementById('buySell');
        const cptyTradedAwayInput = document.getElementById('cptyTradedAway');
        const activityTypeInput = document.getElementById('activityType');
        const usdEquivalentInput = document.getElementById('usdEquivalent');
        const sizeInput = document.getElementById('size');
        const currencySelect = document.getElementById('currency');
        const priceLabel = document.getElementById('priceLabel');
        const activityForm = document.getElementById('activityForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generalLogTable = document.getElementById('generalLogTable');
        const newIssuesLogTable = document.getElementById('newIssuesLogTable');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const activityHint = document.getElementById('activity-hint');
        const signOutBtn = document.getElementById('signOutBtn');

        // New Issues specific
        const ioiInput = document.getElementById('ioi');
        const orderSizeInput = document.getElementById('orderSize');
        const realInterestInput = document.getElementById('realInterest');
        const niCurrencySelect = document.getElementById('niCurrency');
        const niUsdEquivalentInput = document.getElementById('niUsdEquivalent');

        const setAuthMessage = (message = '', type = 'error') => {
            if (!authMessage) return;

            let resolvedMessage = message;
            let allowHTML = false;

            if (typeof message === 'object' && message !== null) {
                allowHTML = Boolean(message.allowHTML);
                resolvedMessage = message.message || message.text || '';
            }

            if (!resolvedMessage) {
                authMessage.classList.add('hidden');
                authMessage.textContent = '';
                authMessage.innerHTML = '';
                return;
            }

            authMessage.classList.remove('hidden');
            authMessage.classList.remove('text-red-400', 'text-green-400');
            authMessage.classList.add(type === 'success' ? 'text-green-400' : 'text-red-400');

            if (allowHTML) {
                authMessage.innerHTML = resolvedMessage;
            } else {
                authMessage.textContent = resolvedMessage;
            }
        };

        let authFormsDisabled = false;
        const disableAuthForms = () => {
            if (authFormsDisabled) return;
            authFormsDisabled = true;
            [loginForm, registerForm].forEach((form) => {
                if (!form) return;
                form.querySelectorAll('input, button').forEach((element) => {
                    element.disabled = true;
                    element.classList.add('opacity-60', 'cursor-not-allowed');
                });
            });
        };

        const getFriendlyAuthErrorMessage = (error) => {
            const fallback = {
                message: 'An unexpected authentication error occurred. Please try again.',
            };

            if (!error) {
                return fallback;
            }

            const code = error.code || '';
            switch (code) {
                case 'auth/operation-not-allowed':
                    return {
                        allowHTML: true,
                        disableAuthForms: true,
                        message: `
                            <div class="space-y-3 text-left">
                                <p class="font-semibold text-red-200">Email/password authentication is disabled for this Firebase project.</p>
                                <p class="text-gray-300">Enable it to allow people to register and sign in:</p>
                                <ol class="list-decimal list-inside space-y-1 text-gray-300">
                                    <li>Open the <a href="https://console.firebase.google.com/" target="_blank" rel="noopener" class="text-indigo-300 underline">Firebase console</a> and select your project.</li>
                                    <li>Go to <strong>Build → Authentication → Sign-in method</strong>.</li>
                                    <li>Activate the <strong>Email/Password</strong> provider and click <strong>Save</strong>.</li>
                                </ol>
                                <p class="text-xs text-gray-400">After enabling the provider, reload this page and try again.</p>
                            </div>
                        `.trim(),
                    };
                case 'auth/email-already-in-use':
                    return { message: 'An account already exists for that email address.' };
                case 'auth/invalid-email':
                    return { message: 'Please enter a valid email address.' };
                case 'auth/weak-password':
                    return { message: 'Passwords must be at least 6 characters long.' };
                case 'auth/user-not-found':
                    return { message: "We couldn't find an account with that email." };
                case 'auth/wrong-password':
                    return { message: 'Incorrect password. Please try again.' };
                default:
                    return { message: error.message || fallback.message };
            }
        };

        const switchAuthView = (view = 'login') => {
            if (view === 'register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'Create Account';
                toggleAuthText.textContent = 'Already have an account?';
                toggleAuthBtn.textContent = 'Sign In';
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                authTitle.textContent = 'Sign In';
                toggleAuthText.textContent = "Don't have an account?";
                toggleAuthBtn.textContent = 'Register';
            }
            setAuthMessage('');
        };

        const showMessage = (element, message, duration = 2500) => {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('translate-y-0');
            setTimeout(() => { element.classList.remove('translate-y-0'); element.classList.add('-translate-y-full'); }, duration);
            setTimeout(() => { element.classList.add('hidden'); element.classList.remove('-translate-y-full'); }, duration + 500);
        };

        const updateSubmitButtonState = () => {
            const isActivitySelected = activityTypeInput.value.trim() !== '';
            submitBtn.disabled = !(isAuthReady && isActivitySelected);
            if (isActivitySelected) activityHint.classList.add('hidden'); else activityHint.classList.remove('hidden');
        };

        const setupRealtimeListeners = () => {
            if (!isAuthReady || !userId || !appId) return;
            const generalActivitiesPath = `artifacts/${appId}/users/${userId}/general_activities`;
            const newIssuesPath = `artifacts/${appId}/users/${userId}/new_issues`;
            const clientsPath = `artifacts/${appId}/clients`;

            if (generalUnsub) generalUnsub();
            generalUnsub = onSnapshot(collection(db, generalActivitiesPath), (snapshot) => {
                const activities = [];
                snapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));
                renderGeneralActivities(activities);
            }, (error) => { console.error('Error fetching general activities:', error); showMessage(errorMessage, `Failed to load activities: ${error.message}`); });

            if (newIssuesUnsub) newIssuesUnsub();
            newIssuesUnsub = onSnapshot(collection(db, newIssuesPath), (snapshot) => {
                const newIssues = [];
                snapshot.forEach(doc => newIssues.push({ id: doc.id, ...doc.data() }));
                renderNewIssues(newIssues);
            }, (error) => { console.error('Error fetching new issues:', error); showMessage(errorMessage, `Failed to load new issues: ${error.message}`); });

            if (clientsUnsub) clientsUnsub();
            clientsUnsub = onSnapshot(collection(db, clientsPath), (snapshot) => {
                const clients = [];
                snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                populateClientDropdown(clients);
            }, (error) => { console.error('Error fetching clients:', error); showMessage(errorMessage, `Failed to load clients: ${error.message}`); });
        };

        const clearRealtimeListeners = () => {
            if (generalUnsub) { generalUnsub(); generalUnsub = null; }
            if (newIssuesUnsub) { newIssuesUnsub(); newIssuesUnsub = null; }
            if (clientsUnsub) { clientsUnsub(); clientsUnsub = null; }
        };

        const resetAppState = () => {
            generalLogTable.innerHTML = '';
            newIssuesLogTable.innerHTML = '';
            clientsListDiv.textContent = 'Sign in to view clients.';
            clientNameSelect.innerHTML = '<option value="">(Select client from Client Database)</option>';
            clientNameSelect.disabled = true;
            clientTypeInput.value = '';
            clientRegionInput.value = '';
            securitiesInput.value = '';
            cptyTradedAwayInput.value = '';
            activityForm.reset();
            activityTypeInput.value = '';
            tabButtons.forEach(btn => btn.classList.remove('active'));
            const generalTab = document.getElementById('log-general-tab');
            const newIssuesTab = document.getElementById('log-new-issues-tab');
            if (generalTab) generalTab.classList.add('active');
            if (newIssuesTab) newIssuesTab.classList.remove('active');
            document.getElementById('generalLog').classList.remove('hidden');
            document.getElementById('newIssuesLog').classList.add('hidden');
            showFormFields('');
            activityHint.classList.remove('hidden');
            submitBtn.disabled = true;
        };

        switchAuthView('login');

        toggleAuthBtn.addEventListener('click', () => {
            const isShowingLogin = !loginForm.classList.contains('hidden');
            switchAuthView(isShowingLogin ? 'register' : 'login');
        });

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) return;
                const email = (loginEmailInput.value || '').trim();
                const password = loginPasswordInput.value || '';
                if (!email || !password) {
                    setAuthMessage('Please provide your email and password.');
                    return;
                }

                const submitButton = loginForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Signing In...';
                setAuthMessage('Signing in...', 'success');

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    setAuthMessage('Signed in successfully!', 'success');
                } catch (err) {
                    console.error('Sign in failed', err);
                    const friendlyError = getFriendlyAuthErrorMessage(err);
                    setAuthMessage(friendlyError);
                    if (friendlyError?.disableAuthForms) {
                        disableAuthForms();
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth) return;
                const email = (registerEmailInput.value || '').trim();
                const password = registerPasswordInput.value || '';
                const confirmPassword = registerPasswordConfirmInput.value || '';

                if (!email || !password || !confirmPassword) {
                    setAuthMessage('Please complete all fields.');
                    return;
                }

                if (password !== confirmPassword) {
                    setAuthMessage('Passwords do not match.');
                    return;
                }

                const submitButton = registerForm.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Creating...';
                setAuthMessage('Creating your account...', 'success');

                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    setAuthMessage('Account created! You are now signed in.', 'success');
                } catch (err) {
                    console.error('Registration failed', err);
                    const friendlyError = getFriendlyAuthErrorMessage(err);
                    setAuthMessage(friendlyError);
                    if (friendlyError?.disableAuthForms) {
                        disableAuthForms();
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        }

        if (signOutBtn) {
            signOutBtn.addEventListener('click', async () => {
                if (!auth) return;
                try {
                    await signOut(auth);
                } catch (err) {
                    console.error('Sign out failed', err);
                    showMessage(errorMessage, 'Failed to sign out.');
                }
            });
        }

        const tabButtons = document.querySelectorAll('#tab-enquiry, #tab-trade, #tab-missed-trades, #tab-new-issues');
        const generalTabs = document.querySelectorAll('#log-general-tab, #log-new-issues-tab');

 
const showFormFields = (type) => {
    const commonFields = document.getElementById('commonFields');
    const missedTradeFields = document.getElementById('missedTradeFields');
    const newIssueFields = document.getElementById('newIssueFields');

    // Reset all fields
// Reset all fields EXCEPT client-related ones
allFormFields.forEach(field => {
    if (field.id !== "clientName" && field.id !== "clientType" && field.id !== "clientRegion") {
        field.disabled = true;
        field.required = false;
    }
});

// Always keep client dropdown enabled if there are clients
if (clientNameSelect.options.length > 1) {
    clientNameSelect.disabled = false;
}

    // Helper: restore hidden fields
    const restoreFields = () => {
        document.getElementById('priceTarget').parentElement.style.display = "";
        buySell.parentElement.style.display = "";
        currencySelect.parentElement.style.display = "";
        usdEquivalentInput.parentElement.style.display = "";
        niCurrencySelect.parentElement.style.display = "";
        niUsdEquivalentInput.parentElement.style.display = "";
    };

    // Default: show common fields, hide extras
    commonFields.classList.remove('hidden');
    missedTradeFields.classList.add('hidden');
    newIssueFields.classList.add('hidden');
    priceLabel.textContent = 'Price Target';

    switch(type.trim().toUpperCase()) {
        case 'ENQUIRY':
        case 'TRADE':
            restoreFields();

            sizeInput.disabled = false;
            sizeInput.required = true;

            document.getElementById('priceTarget').disabled = false;
            document.getElementById('priceTarget').required = true;

            securitiesInput.disabled = false;
            securitiesInput.required = true;

            buySell.disabled = false;

            currencySelect.disabled = false;
            currencySelect.required = true;

            usdEquivalentInput.disabled = false;
            break;

        case 'MISSED TRADES':
            restoreFields();
            priceLabel.textContent = 'Traded away level';
            missedTradeFields.classList.remove('hidden');

            sizeInput.disabled = false;
            sizeInput.required = true;

            document.getElementById('priceTarget').disabled = false;
            document.getElementById('priceTarget').required = true;

            securitiesInput.disabled = false;
            securitiesInput.required = true;

            buySell.disabled = false;

            currencySelect.disabled = false;
            currencySelect.required = true;

            usdEquivalentInput.disabled = false;

            cptyTradedAwayInput.disabled = false;
            cptyTradedAwayInput.required = true;
            break;

        case 'NEW ISSUES':
            // Show only relevant fields
            commonFields.classList.remove('hidden');
            newIssueFields.classList.remove('hidden');

            // Securities
            securitiesInput.disabled = false;
            securitiesInput.required = true;

            // Size
            sizeInput.disabled = false;
            sizeInput.required = true;

            // IOI
            ioiInput.disabled = false;
            ioiInput.required = true;

            // Order Size
            orderSizeInput.disabled = false;
            orderSizeInput.required = true;

            // Real Interest
            realInterestInput.disabled = false;
            realInterestInput.required = true;

            // Remarks
            document.getElementById('remarks').disabled = false;
            document.getElementById('remarks').required = true;

            // Hide unused fields
            document.getElementById('priceTarget').disabled = true;
            document.getElementById('priceTarget').required = false;
            document.getElementById('priceTarget').parentElement.style.display = "none";

            buySell.disabled = true;
            buySell.parentElement.style.display = "none";

            currencySelect.disabled = true;
            currencySelect.required = false;
            currencySelect.parentElement.style.display = "none";

            usdEquivalentInput.disabled = true;
            usdEquivalentInput.parentElement.style.display = "none";

            niCurrencySelect.disabled = true;
            niCurrencySelect.parentElement.style.display = "none";

            niUsdEquivalentInput.disabled = true;
            niUsdEquivalentInput.parentElement.style.display = "none";
            break;

        default:
            // leave everything disabled
            restoreFields();
            break;
    }
};



        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activityTypeInput.value = btn.textContent.trim().toUpperCase();
                showFormFields(btn.textContent);
                updateSubmitButtonState();
            });
        });

        generalTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                generalTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('generalLog').classList.add('hidden');
                document.getElementById('newIssuesLog').classList.add('hidden');
                if (btn.id === 'log-general-tab') document.getElementById('generalLog').classList.remove('hidden'); else document.getElementById('newIssuesLog').classList.remove('hidden');
            });
        });

        // Case-insensitivity logic
        clientNameInputForDb.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        newClientRegionInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        securitiesInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());
        cptyTradedAwayInput.addEventListener('input', (e) => e.target.value = e.target.value.toUpperCase());

        const getUSDConversionRate = async (fromCurrency) => {
            const c = (fromCurrency || '').toUpperCase();
            if (c === 'USD' || c === '') return 1;
            try {
                const res = await fetch(`https://api.exchangerate.host/latest?base=${c}&symbols=USD`);
                if (!res.ok) return null;
                const data = await res.json();
                const rate = data?.rates?.USD;
                return rate;
            } catch (err) {
                console.error('Rate fetch error', err);
                return null;
            }
        };

        const updateUSDEquivalent = async () => {
            const activeTab = activityTypeInput.value.trim().toUpperCase();
            let effectiveSize, effectiveCurrencySelect, effectiveUsdEquivalentInput;

            if (activeTab === 'NEW ISSUES') {
                effectiveSize = parseFloat(orderSizeInput.value);
                effectiveCurrencySelect = niCurrencySelect;
                effectiveUsdEquivalentInput = niUsdEquivalentInput;
            } else {
                effectiveSize = parseFloat(sizeInput.value);
                effectiveCurrencySelect = currencySelect;
                effectiveUsdEquivalentInput = usdEquivalentInput;
            }

            const currency = (effectiveCurrencySelect?.value || '').trim().toUpperCase();
            if (isNaN(effectiveSize) || !currency) { if (effectiveUsdEquivalentInput) effectiveUsdEquivalentInput.value = ''; return; }

            loadingIndicator.classList.remove('hidden');
            const rate = await getUSDConversionRate(currency);
            loadingIndicator.classList.add('hidden');
            if (rate !== null) {
                effectiveUsdEquivalentInput.value = (effectiveSize * rate).toFixed(2);
            } else {
                effectiveUsdEquivalentInput.value = 'N/A';
            }
        };

        sizeInput.addEventListener('input', updateUSDEquivalent);
        currencySelect.addEventListener('change', updateUSDEquivalent);
        orderSizeInput.addEventListener('input', updateUSDEquivalent);
        niCurrencySelect.addEventListener('change', updateUSDEquivalent);

const resetFormState = () => {
    activityForm.reset();
    usdEquivalentInput.value = '';
    niUsdEquivalentInput.value = '';
    tabButtons.forEach(b => b.classList.remove('active'));
    activityTypeInput.value = '';
    showFormFields('');
    updateSubmitButtonState();

    // ✅ Reset client dropdown & autofill fields
    clientNameSelect.value = "";
    clientNameSelect.selectedIndex = 0;
    clientTypeInput.value = '';
    clientRegionInput.value = '';

    // Keep dropdown enabled if clients exist
    if (clientNameSelect.options.length > 1) {
        clientNameSelect.disabled = false;
    } else {
        clientNameSelect.disabled = true;
    }
};


activityForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const activityType = activityTypeInput.value.trim().toUpperCase();
    if (!activityType) { showMessage(errorMessage, 'Please choose an activity type.'); return; }
    if (!isAuthReady || !userId || !appId) { showMessage(errorMessage, 'App not ready. Please wait a moment.'); return; }

    const clientName = (clientNameSelect.value || '').trim().toUpperCase();
    const securities = securitiesInput.value.trim().toUpperCase();
    const clientType = clientTypeInput.value.trim().toUpperCase();
    const clientRegion = clientRegionInput.value.trim().toUpperCase();

    if (!clientName || !securities) { showMessage(errorMessage, 'Client Name and Securities are required.'); return; }

    let docData = { clientName, clientType, clientRegion, securities, timestamp: serverTimestamp() };
    let collectionPath = '';

 if (activityType === 'NEW ISSUES') {
    const ioi = ioiInput.value.trim().toUpperCase();
    const orderSize = parseFloat(orderSizeInput.value);
    const realInterest = parseFloat(realInterestInput.value);
    const currency = niCurrencySelect.value.trim().toUpperCase();
    const usdEquivalent = niUsdEquivalentInput.value.trim();
    const size = parseFloat(sizeInput.value);

    if (!ioi || isNaN(orderSize) || isNaN(realInterest) || !currency || isNaN(size)) {
        showMessage(errorMessage, 'IOI, Size, Order Size, Real Interest, and Currency are required for New Issues.');
        return;
    }

    docData = {
        ...docData,
        ioi,
        size,
        orderSize,
        realInterest,
        currency,
        usdEquivalent,
        remarks: document.getElementById('remarks').value
    };
    collectionPath = `artifacts/${appId}/users/${userId}/new_issues`;
}
 else {
        const size = parseFloat(sizeInput.value);
        const priceTarget = document.getElementById('priceTarget').value.trim();
        const currency = currencySelect.value.trim().toUpperCase();
        const usdEquivalent = usdEquivalentInput.value.trim();
        if (isNaN(size) || !priceTarget || !currency) { showMessage(errorMessage, 'Size, Price Target, and Currency are required.'); return; }

        docData = { 
            ...docData,
            type: activityType,
            buySell: document.getElementById('buySell').value.toUpperCase(),
            size,
            priceTarget,
            currency,
            usdEquivalent
        };

        if (activityType === 'MISSED TRADES') {
            const cptyTradedAway = document.getElementById('cptyTradedAway').value.trim().toUpperCase();
            if (!cptyTradedAway) { showMessage(errorMessage, 'CPTY Traded Away is required for Missed Trades.'); return; }
            docData.tradedAwayLevel = priceTarget;
            docData.cptyTradedAway = cptyTradedAway;
            delete docData.priceTarget;
        }
        collectionPath = `artifacts/${appId}/users/${userId}/general_activities`;
    }

    try {
        await addDoc(collection(db, collectionPath), docData);
        resetFormState();
        showMessage(successMessage, 'Activity Logged!');
    } catch (error) {
        console.error('Error adding document: ', error);
        showMessage(errorMessage, `Failed to log activity: ${error.message}`);
    }
});



        let docToDelete = null; let collectionToDelete = null;
        const showDeleteModal = (collectionName, docId) => { docToDelete = docId; collectionToDelete = collectionName; deleteModal.style.display = 'flex'; };
        const hideDeleteModal = () => { docToDelete = null; collectionToDelete = null; deleteModal.style.display = 'none'; };
        const handleDelete = async () => {
            if (!appId || !userId) { console.error('App or user not ready.'); showMessage(errorMessage, 'App or user not ready. Please try again.'); return; }
            if (docToDelete && collectionToDelete) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionToDelete}`, docToDelete);
                try { await deleteDoc(docRef); hideDeleteModal(); } catch (error) { console.error('Error removing document:', error); showMessage(errorMessage, 'Failed to delete entry.'); }
            }
        };
        confirmDeleteBtn.addEventListener('click', handleDelete);
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        window.showDeleteModal = showDeleteModal;

        const renderGeneralActivities = (activities) => {
            generalLogTable.innerHTML = '';
            activities.sort((a,b)=>{ const ta=a.timestamp?.toMillis()||0; const tb=b.timestamp?.toMillis()||0; return tb-ta; });
            activities.forEach(activity=>{
                const row = document.createElement('tr'); row.className='table-row text-sm';
                const priceValue = activity.type === 'MISSED TRADES' ? activity.tradedAwayLevel : activity.priceTarget;
                const cptyValue = activity.type === 'MISSED TRADES' ? activity.cptyTradedAway : 'N/A';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${activity.timestamp ? new Date(activity.timestamp.toMillis()).toLocaleString() : 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.type || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.clientName}</td>
                    <td class="p-3 whitespace-nowrap">${activity.clientType}</td>
                    <td class="p-3 whitespace-nowrap">${activity.clientRegion || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.securities}</td>
                    <td class="p-3 whitespace-nowrap">${activity.buySell || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.size || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${priceValue || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${activity.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${cptyValue}</td>
                    <td class="p-3 text-right"><button class="btn-danger text-xs" onclick="showDeleteModal('general_activities','${activity.id}')">Delete</button></td>
                `;
                generalLogTable.appendChild(row);
            });
        };

        const renderNewIssues = (issues) => {
            newIssuesLogTable.innerHTML = '';
            issues.sort((a,b)=>{ const ta=a.timestamp?.toMillis()||0; const tb=b.timestamp?.toMillis()||0; return tb-ta; });
            issues.forEach(issue=>{
                const row = document.createElement('tr'); row.className='table-row text-sm';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">${issue.timestamp ? new Date(issue.timestamp.toMillis()).toLocaleString() : 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.clientName}</td>
                    <td class="p-3 whitespace-nowrap">${issue.clientType}</td>
                    <td class="p-3 whitespace-nowrap">${issue.clientRegion || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.securities}</td>
                    <td class="p-3 whitespace-nowrap">${issue.ioi || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.orderSize || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.realInterest || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.priceTarget || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.currency || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap">${issue.usdEquivalent || 'N/A'}</td>
                    <td class="p-3 whitespace-nowrap max-w-xs overflow-hidden truncate" title="${issue.remarks || ''}">${issue.remarks || 'N/A'}</td>
                    <td class="p-3 text-right"><button class="btn-danger text-xs" onclick="showDeleteModal('new_issues','${issue.id}')">Delete</button></td>
                `;
                newIssuesLogTable.appendChild(row);
            });
        };

const populateClientDropdown = (clients) => {
    clientNameSelect.innerHTML = '<option value="">(Select client from Client Database)</option>';

    if (!clients || clients.length === 0) {
        clientsListDiv.textContent = "No clients yet. Add one above.";
        clientNameSelect.disabled = true;
        return;
    }

    // Sort alphabetically
    clients.sort((a, b) => (a.clientName || '').localeCompare(b.clientName || ''));

    clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.clientName;
        opt.textContent = c.clientName;
        opt.dataset.type = c.clientType || '';
        opt.dataset.region = c.clientRegion || '';
        clientNameSelect.appendChild(opt);
    });

    clientsListDiv.textContent = `${clients.length} client(s) available.`;
    clientNameSelect.disabled = false;
    clientNameSelect.value = ""; // reset to placeholder
};

        addClientBtn.addEventListener('click', async () => {
            if (!appId || !userId) { console.error('App or user not ready.'); showMessage(errorMessage, 'App or user not ready. Please try again.'); return; }
            const name = (clientNameInputForDb.value || '').trim().toUpperCase();
            const type = (newClientTypeSelect.value || '').trim().toUpperCase();
            const region = (newClientRegionInput.value || '').trim().toUpperCase();

            if (!name) { showMessage(errorMessage, 'Please enter a client name.'); return; }
            if (!type) { showMessage(errorMessage, 'Please select a client type.'); return; }
            if (!region) { showMessage(errorMessage, 'Please enter a region.'); return; }

            try {
                const clientsCollection = collection(db, `artifacts/${appId}/clients`);
                await addDoc(clientsCollection, { clientName: name, clientType: type, clientRegion: region, createdAt: serverTimestamp() });
                clientNameInputForDb.value = '';
                newClientRegionInput.value = '';
                showMessage(successMessage, 'Client added.');
            } catch (err) {
                console.error('Add client error', err);
                showMessage(errorMessage, `Failed to add client: ${err.message}`);
            }
        });

        clientNameSelect.addEventListener('change', (e)=>{
            const selected = e.target.selectedOptions[0];
            const type = selected?.dataset?.type || '';
            const region = selected?.dataset?.region || '';
            clientTypeInput.value = type;
            clientRegionInput.value = region;
        });

const initApp = async () => {

            const firebaseConfig = {

  apiKey: "AIzaSyBkQnlYdOsIki_VuEpMBsIFACLN-u2FYFo",
  authDomain: "bond-sales-tracker.firebaseapp.com",
  projectId: "bond-sales-tracker",
  storageBucket: "bond-sales-tracker.firebasestorage.app",
  messagingSenderId: "293591418173",
  appId: "1:293591418173:web:b0ca2b77f514dc6c9b3154",



            };



try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    appId = firebaseConfig.projectId;
} catch (e) {
    console.error('Firebase init failed', e);
    showMessage(errorMessage, 'Firebase initialization failed. Check your config.');
    return;
}

resetAppState();
appContent.classList.add('hidden');
authOverlay.classList.remove('hidden');
document.getElementById('userIdSpan').textContent = 'Not signed in';

            onAuthStateChanged(auth, (user) => {
                clearRealtimeListeners();
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdSpan').textContent = userId;
                    isAuthReady = true;
                    appContent.classList.remove('hidden');
                    authOverlay.classList.add('hidden');
                    switchAuthView('login');
                    setAuthMessage('');
                    if (loginForm) loginForm.reset();
                    if (registerForm) registerForm.reset();
                    setupRealtimeListeners();
                    updateSubmitButtonState();
                } else {
                    userId = null;
                    isAuthReady = false;
                    document.getElementById('userIdSpan').textContent = 'Not signed in';
                    resetAppState();
                    appContent.classList.add('hidden');
                    authOverlay.classList.remove('hidden');
                    switchAuthView('login');
                    setAuthMessage('');
                    updateSubmitButtonState();
                }
            });
        };
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>